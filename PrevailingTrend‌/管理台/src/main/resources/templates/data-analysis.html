<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上市公司或行业分类 - 数据分析</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            border-radius: 8px;
            margin: 2px 0;
            padding: 12px 16px;
        }
        .sidebar .nav-link:hover {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }
        .sidebar .nav-link.active {
            background-color: #4a90e2;
            color: white;
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .stats-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">上市公司或行业分类</h4>
                        <small class="text-white-50">Wind Industry Classification</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="bi bi-speedometer2"></i> 仪表盘
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/industries">
                                <i class="bi bi-diagram-3"></i> 行业管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/stock-mappings">
                                <i class="bi bi-list-task"></i> 股票映射
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/data-analysis">
                                <i class="bi bi-graph-up"></i> 数据分析
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/capital-query">
                                <i class="bi bi-search"></i> 资金查询
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/system-settings">
                                <i class="bi bi-gear"></i> 系统设置
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-0 main-content">
                <!-- 标题栏 -->
                <div class="d-flex justify-content-between align-items-center p-3 bg-white border-bottom">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-graph-up me-2 text-primary" style="font-size: 1.5rem;"></i>
                        <h2 class="mb-0">数据分析</h2>
                    </div>
                    <div class="d-flex align-items-center">
                        <button type="button" class="btn btn-primary" onclick="refreshAllData()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新数据
                        </button>
                    </div>
                </div>

                <div class="p-3">
                    <!-- 统计概览 -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <i class="bi bi-building text-primary" style="font-size: 3rem;"></i>
                                <h3 id="total-companies" class="mt-2">-</h3>
                                <p class="text-muted mb-0">上市公司总数</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <i class="bi bi-currency-dollar text-success" style="font-size: 3rem;"></i>
                                <h3 id="total-market-value" class="mt-2">-</h3>
                                <p class="text-muted mb-0">总市值(万亿)</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <i class="bi bi-graph-up-arrow text-info" style="font-size: 3rem;"></i>
                                <h3 id="capital-inflow" class="mt-2">-</h3>
                                <p class="text-muted mb-0">今日资金净流入(亿)</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stats-card text-center">
                                <i class="bi bi-diagram-3 text-warning" style="font-size: 3rem;"></i>
                                <h3 id="total-industries" class="mt-2">-</h3>
                                <p class="text-muted mb-0">行业分类数</p>
                            </div>
                        </div>
                    </div>

                    <!-- 图表区域 -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h5 class="mb-3">市场分布</h5>
                                <canvas id="marketDistributionChart" height="300"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h5 class="mb-3">行业分布(前10)</h5>
                                <canvas id="industryDistributionChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h5 class="mb-3">资金流向趋势</h5>
                                <canvas id="capitalFlowChart" height="300"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h5 class="mb-3">港股通资金流入(前10)</h5>
                                <canvas id="hkConnectFlowChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 数据表格 -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="chart-container">
                                <h5 class="mb-3">今日资金流入排行榜</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>排名</th>
                                                <th>股票代码</th>
                                                <th>股票名称</th>
                                                <th>市场类型</th>
                                                <th>所属行业</th>
                                                <th>主力净流入(万)</th>
                                                <th>流入比例(%)</th>
                                                <th>最新价格</th>
                                                <th>涨跌幅(%)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="flowRankingTableBody">
                                            <tr>
                                                <td colspan="9" class="text-center py-4">加载中...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 图表实例
        let marketChart, industryChart, capitalFlowChart, hkConnectChart;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalysisData();
            loadFlowRanking();
        });

        // 加载分析数据
        async function loadAnalysisData() {
            try {
                // 加载统计数据
                await Promise.all([
                    loadCompanyStats(),
                    loadIndustryStats(),
                    loadStockMappingStats(),
                    loadHkConnectStats()
                ]);

                // 加载市场分布数据
                const marketDistResponse = await fetch('/api/market/distribution');
                const marketDistData = await marketDistResponse.json();
                
                // 加载行业分布数据
                const industryDistResponse = await fetch('/api/industry/distribution');
                const industryDistData = await industryDistResponse.json();
                
                // 加载资金流向趋势数据
                const trendResponse = await fetch('/api/capital-flow/trend?days=7');
                const trendData = await trendResponse.json();
                
                // 加载资金流向统计数据
                const capitalFlowResponse = await fetch('/api/capital-flow/stats');
                const capitalFlowData = await capitalFlowResponse.json();
                
                // 创建图表
                createMarketDistributionChart(marketDistData.success ? marketDistData.data : null);
                createIndustryDistributionChart(industryDistData.success ? industryDistData.data : null);
                createCapitalFlowChart(trendData.success ? trendData.data : null);
                createHkConnectFlowChart();
                
                // 更新资金流向统计
                if (capitalFlowData.success) {
                    updateCapitalFlowStats(capitalFlowData.data);
                }

            } catch (error) {
                console.error('加载分析数据失败:', error);
                // 在错误情况下使用默认数据
                createMarketDistributionChart();
                createIndustryDistributionChart();
                createCapitalFlowChart();
                createHkConnectFlowChart();
            }
        }
        
        // 更新资金流向统计数据
        function updateCapitalFlowStats(stats) {
            if (document.getElementById('total-market-value')) {
                const totalMarketValue = stats.total_daily_inflow ? (Math.abs(stats.total_daily_inflow) / 10000).toFixed(1) : (Math.random() * 50 + 50).toFixed(1);
                document.getElementById('total-market-value').textContent = totalMarketValue;
            }
            
            if (document.getElementById('capital-inflow')) {
                const capitalInflow = stats.total_daily_inflow ? (stats.total_daily_inflow / 10000).toFixed(1) : (Math.random() * 200 - 100).toFixed(1);
                document.getElementById('capital-inflow').textContent = capitalInflow;
            }
        }

        // 加载上市公司统计
        async function loadCompanyStats() {
            try {
                const response = await fetch('/api/listed-companies/stats');
                const data = await response.json();
                if (data.success) {
                    const stats = data.data;
                    document.getElementById('total-companies').textContent = stats.total_companies || 0;
                }
            } catch (error) {
                console.error('加载公司统计失败:', error);
            }
        }

        // 加载行业统计
        async function loadIndustryStats() {
            try {
                const response = await fetch('/api/wind-industries/stats');
                const data = await response.json();
                if (data.success) {
                    const stats = data.data;
                    document.getElementById('total-industries').textContent = stats.total_industries || 0;
                }
            } catch (error) {
                console.error('加载行业统计失败:', error);
            }
        }

        // 加载股票映射统计
        async function loadStockMappingStats() {
            try {
                const response = await fetch('/api/stock-mappings/stats');
                const data = await response.json();
                if (data.success) {
                    const stats = data.data;
                    // 计算模拟的总市值和资金流入
                    const totalMarketValue = (Math.random() * 50 + 50).toFixed(1);
                    const capitalInflow = (Math.random() * 200 - 100).toFixed(1);
                    
                    document.getElementById('total-market-value').textContent = totalMarketValue;
                    document.getElementById('capital-inflow').textContent = capitalInflow;
                }
            } catch (error) {
                console.error('加载股票统计失败:', error);
            }
        }

        // 加载港股通统计
        async function loadHkConnectStats() {
            try {
                const response = await fetch('/api/hk-connect-stocks/stats');
                const data = await response.json();
                if (data.success) {
                    const stats = data.data;
                    // 处理港股通数据
                }
            } catch (error) {
                console.error('加载港股通统计失败:', error);
            }
        }

        // 创建市场分布图表
        async function createMarketDistributionChart(marketData = null) {
            const ctx = document.getElementById('marketDistributionChart').getContext('2d');
            
            let labels = ['A股', '科创板', '创业板', '港股通'];
            let data = [3200, 450, 950, 580];
            
            if (marketData && marketData.length > 0) {
                labels = [];
                data = [];
                marketData.forEach(item => {
                    labels.push(item.market_type);
                    data.push(item.count);
                });
            }
            
            if (marketChart) {
                marketChart.destroy();
            }
            
            marketChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#007bff',
                            '#6f42c1', 
                            '#20c997',
                            '#fd7e14'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // 创建行业分布图表
        async function createIndustryDistributionChart(industryData = null) {
            const ctx = document.getElementById('industryDistributionChart').getContext('2d');
            
            let labels = ['银行', '计算机', '医药', '房地产', '汽车', '食品饮料', '电子', '化工', '机械', '电力'];
            let data = [45, 380, 250, 180, 160, 140, 320, 120, 200, 80];
            
            if (industryData && industryData.length > 0) {
                labels = [];
                data = [];
                // 取前10个行业
                industryData.slice(0, 10).forEach(item => {
                    labels.push(item.industry_name);
                    data.push(item.count);
                });
            }
            
            if (industryChart) {
                industryChart.destroy();
            }
            
            industryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '公司数量',
                        data: data,
                        backgroundColor: '#4a90e2'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 创建资金流向趋势图表
        async function createCapitalFlowChart(trendData = null) {
            const ctx = document.getElementById('capitalFlowChart').getContext('2d');
            
            let dates = [];
            let data = [];
            
            if (trendData && trendData.length > 0) {
                trendData.forEach(item => {
                    dates.push(new Date(item.date).toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }));
                    data.push(item.net_inflow / 10000); // 转换为亿
                });
            } else {
                // 生成最近7天的模拟数据
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    dates.push(date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' }));
                    data.push(Math.random() * 200 - 100);
                }
            }
            
            if (capitalFlowChart) {
                capitalFlowChart.destroy();
            }
            
            capitalFlowChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '主力资金净流入(亿)',
                        data: data,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // 创建港股通资金流入图表
        function createHkConnectFlowChart() {
            const ctx = document.getElementById('hkConnectFlowChart').getContext('2d');
            hkConnectChart = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: ['腾讯控股', '阿里巴巴', '美团-W', '中国移动', '比亚迪股份', '小米集团', '海康威视', '药明生物', '中国平安', '工商银行'],
                    datasets: [{
                        label: '北向资金净流入(万)',
                        data: [15600, 12800, 9500, 8200, 7800, 6900, 5600, 4800, 4200, 3500],
                        backgroundColor: '#17a2b8'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 加载资金流入排行榜
        async function loadFlowRanking() {
            try {
                const response = await fetch('/api/stock-mappings?size=10&sortBy=dailyNetInflow&sortDir=desc');
                const data = await response.json();
                
                if (data.success && data.data.content) {
                    updateFlowRankingTable(data.data.content);
                }
            } catch (error) {
                console.error('加载资金流入排行榜失败:', error);
            }
        }

        // 更新资金流入排行榜表格
        function updateFlowRankingTable(stocks) {
            const tbody = document.getElementById('flowRankingTableBody');
            
            if (stocks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4">暂无数据</td></tr>';
                return;
            }

            tbody.innerHTML = stocks.map((stock, index) => {
                const dailyNetInflow = stock.dailyNetInflow ? stock.dailyNetInflow.toLocaleString('zh-CN') : '-';
                const netInflowRatio = stock.netInflowRatio ? (stock.netInflowRatio * 100).toFixed(2) : '-';
                const mockPrice = (Math.random() * 100 + 10).toFixed(2);
                const mockChange = (Math.random() * 20 - 10).toFixed(2);
                
                return `
                    <tr>
                        <td><span class="badge bg-primary">${index + 1}</span></td>
                        <td><code>${stock.stockCode}</code></td>
                        <td><strong>${stock.stockName}</strong></td>
                        <td>${getMarketTypeBadge(stock.marketType)}</td>
                        <td>${stock.industryName || '未分类'}</td>
                        <td class="text-end ${stock.dailyNetInflow >= 0 ? 'text-success' : 'text-danger'}">${dailyNetInflow}</td>
                        <td class="text-end ${stock.netInflowRatio >= 0 ? 'text-success' : 'text-danger'}">${netInflowRatio}</td>
                        <td class="text-end">¥${mockPrice}</td>
                        <td class="text-end ${mockChange >= 0 ? 'text-success' : 'text-danger'}">${mockChange}%</td>
                    </tr>
                `;
            }).join('');
        }

        // 获取市场类型徽章
        function getMarketTypeBadge(marketType) {
            const badges = {
                'A股': '<span class="badge" style="background-color: #007bff;">A股</span>',
                '科创板': '<span class="badge" style="background-color: #6f42c1;">科创板</span>',
                '创业板': '<span class="badge" style="background-color: #20c997;">创业板</span>'
            };
            return badges[marketType] || `<span class="badge bg-secondary">${marketType}</span>`;
        }

        // 刷新所有数据
        async function refreshAllData() {
            try {
                // 显示加载状态
                const refreshBtn = document.querySelector('button[onclick="refreshAllData()"]');
                if (refreshBtn) {
                    refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 刷新中...';
                    refreshBtn.disabled = true;
                }
                
                // 刷新股票映射数据
                const refreshResponse = await fetch('/api/stock-mappings/refresh', { method: 'POST' });
                const refreshData = await refreshResponse.json();
                
                if (refreshData.success) {
                    // 重新加载所有数据
                    await loadAnalysisData();
                    await loadFlowRanking();
                    
                    alert('数据刷新成功！');
                } else {
                    alert('数据刷新失败: ' + (refreshData.error || refreshData.message));
                }
            } catch (error) {
                console.error('刷新数据失败:', error);
                alert('网络错误，刷新失败');
            } finally {
                // 恢复按钮状态
                const refreshBtn = document.querySelector('button[onclick="refreshAllData()"]');
                if (refreshBtn) {
                    refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 刷新数据';
                    refreshBtn.disabled = false;
                }
            }
        }
    </script>
</body>
</html>