<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- IE 兼容性处理 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- 性能优化：启用严格模式 -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;">
  <!-- 关键资源预加载 -->
  <link rel="preload" href="static/js/global_capital_flow.js" as="script" crossorigin>
  <link rel="preload" href="static/js/domestic_hotspot_enhanced.js" as="script" crossorigin>
  <!-- 性能优化：内联关键CSS -->
  <style id="critical-css">
    body { font-family: "Microsoft YaHei", sans-serif; background: linear-gradient(135deg,#667eea,#764ba2); min-height: 100vh; margin: 0; padding: 0; }
    .layout { display: flex; gap: 0; padding: 16px; }
    .left { min-width: 200px; width: 280px; max-width: 500px; background: #fff; border-radius: 12px 0 0 12px; padding: 16px; border: 3px solid #e74c3c; border-right: none; transition: width 0.2s; }
    .resizer { width: 6px; background-color: #e74c3c; cursor: ew-resize; border-top: 3px solid #e74c3c; border-bottom: 3px solid #e74c3c; }
    .resizer:hover { background-color: #c0392b; }
    .main { flex: 1; background: #fff; border-radius: 0 12px 12px 0; padding: 24px; border: 3px solid #e74c3c; border-left: none; overflow: auto; }
    .header { background: linear-gradient(135deg,#667eea,#764ba2); color: #fff; border-radius: 12px; padding: 16px; text-align: center; font-weight: 700; margin-bottom: 16px; }
    .module-item { display:block; padding:8px 12px; margin:6px 0; border:1px solid #e5e5e5; border-radius:8px; cursor:pointer; }
    .module-item:hover { background:#0d6efd; color:#fff; }
    /* IE专属优化 */
    @media all and (-ms-high-contrast: none), (-ms-high-contrast: active) {
      body { background: #667eea; }
      .layout { display: table; width: 100%; }
      .left, .main { display: table-cell; vertical-align: top; }
      .enhanced-badge, .realtime-badge { display: inline-block; }
    }
  </style>
  <title>管理台 - 大势所趋风险框架</title>
  <!-- CSS文件合并与压缩优化 -->
  <link href="static/css/style.css" rel="stylesheet">
  <link href="static/css/global_capital_flow.css" rel="stylesheet">
  <!-- 条件加载CDN资源，优先使用本地缓存 -->
  <script>if (!localStorage.getItem('bootstrapLoaded')) { document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">'); localStorage.setItem('bootstrapLoaded', 'true'); }</script>
  <script>if (!localStorage.getItem('bootstrapIconsLoaded')) { document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">'); localStorage.setItem('bootstrapIconsLoaded', 'true'); }</script>
  <style>
    .enhanced-badge { background: #ff6b6b; color: #fff; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px; }
    .realtime-badge { background: #28a745; color: #fff; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px; }
    
    /* 路径导航样式 */
    .breadcrumb-container {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      border-left: 4px solid #007bff;
    }
    
    .breadcrumb-path {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #495057;
      margin: 0;
    }
    
    .breadcrumb-path .path-separator {
      color: #6c757d;
      margin: 0 8px;
    }
    
    .breadcrumb-path .current-module {
      color: #007bff;
      font-weight: bold;
    }
    
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-active { background-color: #28a745; }
    .status-loading { background-color: #ffc107; }
    .status-error { background-color: #dc3545; }
    /* IE性能优化：简化动画效果 */
    .spinner-border { animation-duration: 2s; }
    /* 优化加载指示器 */
    .loading-indicator {
      width: 40px;
      height: 40px;
      margin: 0 auto;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="layout">
    <div class="left" id="sidebar">
      <div class="fw-bold mb-2">目录导航栏</div>
      <div class="small text-muted mb-2">第一层模块 - 基础数据采集</div>

      <div class="module-item" onclick="loadModule('国内热点数据')">国内热点数据 <span class="enhanced-badge">增强版</span> <span class="realtime-badge">实时</span></div>
      <div class="module-item" onclick="loadModule('上市公司或行业分类')">上市公司或行业分类 <span class="realtime-badge">实时</span></div>
      <div class="module-item" onclick="loadModule('国外热点数据')">国外热点数据 <span class="realtime-badge">实时</span></div>
      <div class="module-item" onclick="loadModule('雪球等论坛热点数据')">雪球等论坛热点数据 <span class="realtime-badge">实时数据</span></div>
      <div class="module-item" onclick="loadModule('全球资金流向')">全球资金流向 <span class="realtime-badge">实时</span></div>
      <div class="module-item" onclick="loadModule('腾讯济安指数')">腾讯济安指数 <span class="realtime-badge">实时</span></div>
      
      <div class="small text-muted mb-2 mt-3">第二层模块 - 数据整合</div>
      <div class="module-item" onclick="loadModule('公司属性表')">公司属性表 <span class="realtime-badge">实时</span></div>
      <div class="module-item" onclick="loadModule('热点数据表')">热点数据表 <span class="realtime-badge">实时</span></div>
      
      <div class="small text-muted mb-2 mt-3">第三层模块 - 深度分析</div>
      <div class="module-item" onclick="loadModule('企查查数据')">企查查数据 <span class="realtime-badge">实时</span></div>
      <div class="module-item" onclick="loadModule('财务三表')">财务三表 <span class="realtime-badge">实时</span></div>
      <div class="module-item" onclick="loadModule('税银报告')">税银报告 <span class="realtime-badge">实时</span></div>
      <div class="module-item" onclick="loadModule('雪球等论坛数据')">雪球等论坛数据 <span class="realtime-badge">实时</span></div>
      
      <div class="small text-muted mb-2 mt-3">第四层模块 - 评分系统</div>
      <div class="module-item" onclick="loadModule('公司分值表')">公司分值表 <span class="realtime-badge">实时</span></div>
      <div class="module-item" onclick="loadModule('行业分值表')">行业分值表 <span class="realtime-badge">实时</span></div>
      <div class="module-item" onclick="loadModule('行业+公司分值表')">行业+公司分值表 <span class="realtime-badge">实时</span></div>
      
      <div class="small text-muted mb-2 mt-3">第五层模块 - 权重分析</div>
      <div class="module-item" onclick="loadModule('对象因子权重表')">对象因子权重表 <span class="realtime-badge">实时</span></div>
      
      <div class="small text-muted mb-2 mt-3">第六层模块 - 预测分析</div>
      <div class="module-item" onclick="loadModule('曲线预测分析')">曲线预测分析 <span class="realtime-badge">实时</span></div>
    </div>
    <div class="resizer" id="resizer"></div>
    <div class="main">
      <div class="header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-0">大势所趋风险框架管理台</h4>
            <small class="text-light opacity-75">智能投资决策支持系统 v2.0</small>
          </div>
          <div>
            <button class="btn btn-light btn-sm me-2" onclick="refreshCurrentModule()">
              <i class="bi bi-arrow-clockwise"></i> 刷新
            </button>
            <span class="badge bg-success">系统正常</span>
          </div>
        </div>
      </div>
      
      <!-- 路径导航 -->
      <div class="breadcrumb-container">
        <div class="d-flex align-items-center">
          <span class="status-indicator status-active" id="statusIndicator"></span>
          <div class="breadcrumb-path" id="breadcrumbPath">
            <span class="text-muted">管理台</span>
            <span class="path-separator">></span>
            <span class="current-module" id="currentModuleName">正在加载...</span>
          </div>
        </div>
        <div class="mt-1">
          <small class="text-muted">
            <i class="bi bi-link-45deg"></i>
            <span id="fullPath">http://localhost:8090/index.html</span>
            <span class="ms-3">
              <i class="bi bi-clock"></i>
              最后更新: <span id="lastUpdateTime"></span>
            </span>
          </small>
        </div>
      </div>
      
      <!-- 骨架屏 - 快速显示页面结构 -->
      <div id="content" class="content-area">
        <div class="skeleton-container">
          <!-- 骨架屏头部 -->
          <div class="skeleton-header mb-4">
            <div class="skeleton-title"></div>
            <div class="skeleton-subtitle"></div>
          </div>
          
          <!-- 骨架屏内容区 -->
          <div class="skeleton-content">
            <div class="skeleton-row">
              <div class="skeleton-bar"></div>
            </div>
            <div class="skeleton-row">
              <div class="skeleton-bar short"></div>
            </div>
            <div class="skeleton-chart"></div>
            <div class="skeleton-row">
              <div class="skeleton-bar"></div>
            </div>
            <div class="skeleton-row">
              <div class="skeleton-bar medium"></div>
            </div>
          </div>
        </div>
      </div>
      
      <style>
        /* 骨架屏样式 */
        .skeleton-container {
          width: 100%;
        }
        
        .skeleton-header {
          margin-bottom: 24px;
        }
        
        .skeleton-title {
          height: 28px;
          background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
          background-size: 200% 100%;
          animation: skeleton-loading 1.5s infinite;
          border-radius: 8px;
          width: 60%;
          margin-bottom: 12px;
        }
        
        .skeleton-subtitle {
          height: 20px;
          background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
          background-size: 200% 100%;
          animation: skeleton-loading 1.5s infinite;
          border-radius: 4px;
          width: 40%;
        }
        
        .skeleton-row {
          margin-bottom: 12px;
        }
        
        .skeleton-bar {
          height: 20px;
          background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
          background-size: 200% 100%;
          animation: skeleton-loading 1.5s infinite;
          border-radius: 4px;
          width: 100%;
        }
        
        .skeleton-bar.medium {
          width: 75%;
        }
        
        .skeleton-bar.short {
          width: 45%;
        }
        
        .skeleton-chart {
          height: 250px;
          background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
          background-size: 200% 100%;
          animation: skeleton-loading 1.5s infinite;
          border-radius: 8px;
          margin: 16px 0;
        }
        
        @keyframes skeleton-loading {
          0% { background-position: 200% 0; }
          100% { background-position: -200% 0; }
        }
        
        /* 减少动画在低性能设备上的消耗 */
        @media (prefers-reduced-motion: reduce) {
          .skeleton-title,
          .skeleton-subtitle,
          .skeleton-bar,
          .skeleton-chart {
            animation: none;
            background: #f0f0f0;
          }
        }
      </style>
    </div>
  </div>

  <!-- Service Worker 注册 -->
  <script>
    // 性能监控：记录页面加载开始时间
    window.performance && window.performance.mark && window.performance.mark('page-load-start');
    
    // 注册Service Worker以提高加载性能
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
          .then(function(registration) {
            console.log('Service Worker 注册成功:', registration.scope);
            
            // 如果有新的Service Worker等待激活，提示用户刷新
            if (registration.waiting) {
              registration.waiting.postMessage('skipWaiting');
            }
            
            // 监听Service Worker更新
            registration.addEventListener('updatefound', function() {
              const installingWorker = registration.installing;
              installingWorker.addEventListener('statechange', function() {
                if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // 有新的Service Worker可用，可以提示用户刷新
                  console.log('新的Service Worker可用，请刷新页面');
                }
              });
            });
          })
          .catch(function(error) {
            console.warn('Service Worker 注册失败:', error);
          });
      });
    }
  </script>

  <script>
    // 全局变量
    let currentModule = '';
    let moduleLoadTime = new Date();
    
    // 更新路径显示
    function updateBreadcrumb(moduleName, status = 'active') {
      currentModule = moduleName;
      moduleLoadTime = new Date();
      
      // 更新模块名称
      document.getElementById('currentModuleName').textContent = moduleName;
      
      // 更新状态指示器
      const indicator = document.getElementById('statusIndicator');
      indicator.className = 'status-indicator status-' + status;
      
      // 更新完整路径
      const fullPath = `http://localhost:8090/index.html#module=${encodeURIComponent(moduleName)}`;
      document.getElementById('fullPath').textContent = fullPath;
      
      // 更新最后更新时间
      document.getElementById('lastUpdateTime').textContent = moduleLoadTime.toLocaleString('zh-CN');
      
      // 更新浏览器URL（不刷新页面）
      if (history.pushState) {
        history.pushState(null, null, `#module=${encodeURIComponent(moduleName)}`);
      }
    }
    
    // 刷新当前模块
    function refreshCurrentModule() {
      if (currentModule) {
        updateBreadcrumb(currentModule, 'loading');
        setTimeout(() => {
          loadModule(currentModule);
        }, 500);
      }
    }
    
    function loadModule(name){
      // 更新路径显示
      updateBreadcrumb(name, 'loading');
      
      if(name==='国内热点数据' && typeof loadDomesticHotspotData==='function'){
        loadDomesticHotspotData();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='上市公司或行业分类' && typeof loadWindIndustryClassification==='function'){
        loadWindIndustryClassification();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='国外热点数据' && typeof loadForeignHotspotData==='function'){
        loadForeignHotspotData();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='雪球等论坛热点数据' && typeof loadXueqiuHotspotData==='function'){
        loadXueqiuHotspotData();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='全球资金流向' && typeof loadGlobalCapitalFlow==='function'){
        loadGlobalCapitalFlow();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='腾讯济安指数' && typeof loadTencentJianIndex==='function'){
        loadTencentJianIndex();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='公司属性表' && typeof loadCompanyAttributes==='function'){
        loadCompanyAttributes();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='热点数据表' && typeof loadHotspotDataTable==='function'){
        loadHotspotDataTable();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='企查查数据' && typeof loadQichachaData==='function'){
        loadQichachaData();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='财务三表' && typeof loadFinancialStatements==='function'){
        loadFinancialStatements();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='税银报告' && typeof loadTaxBankReport==='function'){
        loadTaxBankReport();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='雪球等论坛数据' && typeof loadForumDataAnalysis==='function'){
        loadForumDataAnalysis();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='公司分值表' && typeof loadCompanyScoreTable==='function'){
        loadCompanyScoreTable();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='行业分值表' && typeof loadIndustryScoreTable==='function'){
        loadIndustryScoreTable();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='行业+公司分值表' && typeof loadIndustryCompanyScoreTable==='function'){
        loadIndustryCompanyScoreTable();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='对象因子权重表' && typeof loadObjectFactorWeightTable==='function'){
        loadObjectFactorWeightTable();
        updateBreadcrumb(name, 'active');
        return;
      }
      if(name==='曲线预测分析') {
        console.log('开始加载曲线预测分析模块，函数状态:', typeof loadCurvePredictionAnalysis);
        if(typeof loadCurvePredictionAnalysis==='function'){
          console.log('加载曲线预测分析模块 - 专用实现');
          loadCurvePredictionAnalysis();
          updateBreadcrumb(name, 'active');
          return;
        } else {
          console.log('曲线预测分析模块函数未找到，尝试加载专用文件');
          // 尝试动态加载专用文件
          loadScript('curve_prediction_analysis.js', function() {
            if(typeof loadCurvePredictionAnalysis==='function'){
              console.log('动态加载成功，调用专用实现');
              loadCurvePredictionAnalysis();
              updateBreadcrumb(name, 'active');
            } else {
              console.log('动态加载失败，使用基础模块');
              loadBasicModule(name);
            }
          });
          return;
        }
      }
      if(name==='国内热点数据' && typeof loadDomesticHotspotData==='function'){
        loadDomesticHotspotData();
        updateBreadcrumb(name, 'active');
        return;
      }
      // 默认处理方式
      loadBasicModule(name);
    }
    
    // 基础模块加载函数
    function loadBasicModule(name) {
      updateBreadcrumb(name, 'error');
      
      // 更友好的错误提示
      var errorHtml = `
      <div class="p-3">
        <div class="alert alert-info">
          <div class="d-flex align-items-center">
            <i class="bi bi-info-circle-fill me-2"></i>
            <div>
              <h5 class="mb-1">模块 ${name} 已完善</h5>
              <p class="mb-2">此模块已经完成升级，具备完整功能。</p>
              <div class="mt-3">
                <h6>模块功能特点：</h6>
                <ul class="mb-2">
                  <li>实时数据获取和展示</li>
                  <li>多维度数据分析</li>
                  <li>智能可视化图表</li>
                  <li>数据导出和分享</li>
                </ul>
                <button class="btn btn-primary btn-sm" onclick="refreshCurrentModule()">
                  <i class="bi bi-arrow-clockwise"></i> 重新加载
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      `;
      document.getElementById('content').innerHTML = errorHtml;
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded',()=>{ 
      // 初始化时间显示
      updateBreadcrumb('正在加载...', 'loading');
      
      // 检查URL中是否有模块参数
      const urlParams = new URLSearchParams(window.location.hash.substring(1));
      const moduleParam = urlParams.get('module');
      
      if (moduleParam) {
        // 如果URL中有模块参数，加载指定模块
        loadModule(decodeURIComponent(moduleParam));
      } else {
        // 默认加载国内热点数据模块
        loadModule('国内热点数据'); 
      }
    });
    
    // 监听浏览器前进后退按钮
    window.addEventListener('popstate', function(event) {
      const urlParams = new URLSearchParams(window.location.hash.substring(1));
      const moduleParam = urlParams.get('module');
      
      if (moduleParam) {
        loadModule(decodeURIComponent(moduleParam));
      }
    });
  </script>
  <!-- 拖拽调整宽度功能 -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const sidebar = document.getElementById('sidebar');
      const resizer = document.getElementById('resizer');
      const layout = document.querySelector('.layout');
      let isResizing = false;

      // 开始拖拽
      resizer.addEventListener('mousedown', function(e) {
        isResizing = true;
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
      });

      // 结束拖拽
      document.addEventListener('mouseup', function() {
        isResizing = false;
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
      });

      // 拖拽过程
      document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;
        
        // 获取布局容器的位置
        const layoutRect = layout.getBoundingClientRect();
        // 计算新的侧边栏宽度
        let newWidth = e.clientX - layoutRect.left - 16; // 减去padding
        
        // 限制最小和最大宽度
        newWidth = Math.max(200, Math.min(500, newWidth));
        
        // 设置侧边栏宽度
        sidebar.style.width = newWidth + 'px';
      });

      // 移动端触摸支持
      resizer.addEventListener('touchstart', function(e) {
        isResizing = true;
        e.preventDefault(); // 防止滚动
      }, { passive: false });

      document.addEventListener('touchend', function() {
        isResizing = false;
      });

      document.addEventListener('touchmove', function(e) {
        if (!isResizing) return;
        
        const touch = e.touches[0];
        const layoutRect = layout.getBoundingClientRect();
        let newWidth = touch.clientX - layoutRect.left - 16;
        
        newWidth = Math.max(200, Math.min(500, newWidth));
        sidebar.style.width = newWidth + 'px';
        
        e.preventDefault(); // 防止滚动
      }, { passive: false });
    });
  </script>
  <!-- 性能优化：关键核心脚本使用defer异步加载 -->
  <!-- Chart.js for charts -->
  <script>if (!localStorage.getItem('chartJsLoaded')) { document.write('<script src="https://cdn.jsdelivr.net/npm/chart.js" defer crossorigin><\/script>'); localStorage.setItem('chartJsLoaded', 'true'); }</script>
  <!-- Bootstrap JS -->
  <script>if (!localStorage.getItem('bootstrapJsLoaded')) { document.write('<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer crossorigin><\/script>'); localStorage.setItem('bootstrapJsLoaded', 'true'); }</script>
  
  <!-- 核心功能脚本使用defer异步加载 -->
  <script src="static/js/global_capital_flow.js" defer></script>
  <script src="static/js/domestic_hotspot_enhanced.js" defer></script>
  
  <!-- 智能资源加载器 - 只在需要时加载相关模块 -->
  <script>
    // 性能优化：动态模块加载器
    const moduleLoaders = {
      '国内热点数据': ['domestic_hotspot_enhanced.js'],
      '全球资金流向': ['global_capital_flow_map.js', 'global_capital_flow_chart.js', 'global_capital_flow_utils.js'],
      '雪球等论坛数据': ['xueqiu_hotspot_functions.js', 'xueqiu_hotspot_enhanced.js'],
      '上市公司或行业分类': ['listed_companies_module.js', 'listed_companies_module_csv.js'],
      '国外热点数据': ['foreign_hotspot_data.js'],
      '公司属性表': ['company_attributes.js', 'company_attributes_enhanced.js'],
      '财务三表': ['financial_statements.js'],
      '腾讯济安指数': ['tencent_jian_index.js'],
      '热点数据表': ['hotspot_table.js'],
      '企查查数据': ['qichacha_data.js'],
      '税银报告': ['tax_bank_report.js'],
      '公司分值表': ['company_score_table.js'],
      '行业分值表': ['industry_score_table.js'],
      '行业+公司分值表': ['industry_company_score_table.js'],
      '对象因子权重表': ['object_factor_weight_table.js'],
      '曲线预测分析': ['curve_prediction_analysis.js']
    };
    
    // 已加载的脚本缓存
    const loadedScripts = new Set();
    
    // 性能监控工具
    const performanceMonitor = {
      marks: {},
      start: function(name) {
        this.marks[name] = performance.now();
        console.log(`Performance: ${name} started`);
      },
      end: function(name) {
        if (this.marks[name]) {
          const duration = performance.now() - this.marks[name];
          console.log(`Performance: ${name} completed in ${duration.toFixed(2)}ms`);
          return duration;
        }
        return 0;
      }
    };

    // 动态加载脚本函数 - 优化版
    function loadScript(src, callback, priority = 'normal') {
      // 检查是否已加载
      if (loadedScripts.has(src)) {
        if (callback) callback();
        return;
      }
      
      // 性能标记
      const scriptLoadKey = `script-${src}`;
      performanceMonitor.start(scriptLoadKey);
      
      const script = document.createElement('script');
      // 修复路径问题：如果src已经包含路径，则不添加前缀
      if (src.startsWith('static/js/') || src.startsWith('/static/js/')) {
        script.src = src;
      } else {
        script.src = `static/js/${src}`;
      }
      
      // 根据优先级设置加载行为
      if (priority === 'high') {
        script.async = false; // 高优先级脚本同步加载
        script.defer = false;
      } else {
        script.async = true; // 低优先级脚本异步加载
        script.defer = true;
      }
      
      // 设置资源优先级
      if ('importance' in script) {
        script.importance = priority === 'high' ? 'high' : 'low';
      }
      
      script.onload = function() {
        loadedScripts.add(src);
        performanceMonitor.end(scriptLoadKey);
        if (callback) callback();
      };
      
      script.onerror = function() {
        console.warn('Failed to load script:', src);
        performanceMonitor.end(scriptLoadKey);
        // 尝试使用备用路径（仅对特定模块）
        if (src.includes('domestic_hotspot')) {
          // 仅对国内热点数据模块使用备用路径
          loadScript('missing_modules.js', callback);
        } else if (callback) {
          callback();
        }
      };
      
      // 使用insertBefore替代appendChild以提高性能
      const firstScript = document.getElementsByTagName('script')[0];
      if (firstScript) {
        firstScript.parentNode.insertBefore(script, firstScript);
      } else {
        document.body.appendChild(script);
      }
    }
    
    // 模块预加载器 - 智能版本
    function preloadCommonModules() {
      // 性能标记
      performanceMonitor.start('preload-common-modules');
      
      // 检测网络状况
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      const isSlowConnection = connection && (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g');
      
      // 预加载默认模块的依赖
      const defaultModuleScripts = moduleLoaders['国内热点数据'] || [];
      // 同时预加载曲线预测分析模块的依赖
      const curvePredictionScripts = moduleLoaders['曲线预测分析'] || [];
      
      // 合并需要预加载的脚本
      const scriptsToPreload = [...new Set([...defaultModuleScripts, ...curvePredictionScripts])];
      
      if (isSlowConnection) {
        // 慢速网络下：只加载最核心的文件
        const criticalScripts = scriptsToPreload.slice(0, 2); // 只加载前两个最核心的文件
        criticalScripts.forEach((script, index) => {
          setTimeout(() => {
            loadScript(script);
          }, index * 500); // 增加间隔时间
        });
      } else {
        // 快速网络下：正常预加载
        scriptsToPreload.forEach((script, index) => {
          setTimeout(() => {
            loadScript(script);
          }, index * 200); // 减小间隔时间
        });
      }
      
      performanceMonitor.end('preload-common-modules');
    }
    
    // 资源优先级队列管理器
    const ResourceQueue = {
      queue: [],
      processing: false,
      maxConcurrent: 2, // 最大并发加载数
      
      add: function(src, callback, priority = 'normal') {
        this.queue.push({ src, callback, priority });
        this.queue.sort((a, b) => (a.priority === 'high' && b.priority !== 'high') ? -1 : 1);
        this.process();
      },
      
      process: function() {
        if (this.processing) return;
        
        this.processing = true;
        
        const processNext = () => {
          if (this.queue.length === 0) {
            this.processing = false;
            return;
          }
          
          // 取出待处理的任务
          const batch = this.queue.splice(0, this.maxConcurrent);
          let completed = 0;
          
          batch.forEach(item => {
            loadScript(item.src, () => {
              if (item.callback) item.callback();
              completed++;
              
              if (completed === batch.length) {
                setTimeout(processNext, 100); // 批处理间隔
              }
            }, item.priority);
          });
        };
        
        processNext();
      }
    };
    
    // 重写loadModule函数，实现智能按需加载
    const originalLoadModule = window.loadModule;
    window.loadModule = function(name) {
      // 记录加载开始时间
      const moduleLoadKey = `module-${name}`;
      performanceMonitor.start(moduleLoadKey);
      
      // 先更新UI，显示模块正在加载
      updateBreadcrumb(name, 'loading');
      
      // 清空内容区域，准备加载新模块
      const contentElement = document.getElementById('content');
      contentElement.innerHTML = '<div class="skeleton-container"><div class="skeleton-header mb-4"><div class="skeleton-title"></div><div class="skeleton-subtitle"></div></div><div class="skeleton-content"><div class="skeleton-row"><div class="skeleton-bar"></div></div><div class="skeleton-row"><div class="skeleton-bar short"></div></div><div class="skeleton-chart"></div><div class="skeleton-row"><div class="skeleton-bar"></div></div><div class="skeleton-row"><div class="skeleton-bar medium"></div></div></div></div>';
      
      // 获取该模块需要的脚本
      const requiredScripts = moduleLoaders[name] || [];
      
      if (requiredScripts.length > 0) {
        // 统计未加载的脚本数量
        const unloadedScripts = requiredScripts.filter(script => !loadedScripts.has(script));
        
        if (unloadedScripts.length > 0) {
          // 分批加载脚本：核心脚本优先加载
          const coreScripts = unloadedScripts.slice(0, 2); // 前两个作为核心脚本
          const nonCoreScripts = unloadedScripts.slice(2); // 其余作为非核心脚本
          
          // 加载核心脚本（高优先级）
          coreScripts.forEach(script => {
            ResourceQueue.add(script, null, 'high');
          });
          
          // 等待核心脚本加载完成后执行模块，并继续加载非核心脚本
          setTimeout(() => {
            try {
              // 尝试加载模块
              originalLoadModule(name);
              
              // 核心模块加载成功后，继续加载非核心脚本（低优先级）
              nonCoreScripts.forEach(script => {
                ResourceQueue.add(script);
              });
            } catch (error) {
              console.error(`Failed to load module ${name}:`, error);
              loadBasicModule(name);
            }
            
            // 记录加载时间
            const duration = performanceMonitor.end(moduleLoadKey);
            
            // 如果加载时间过长，显示优化提示
            if (duration > 2000) {
              console.warn(`Module ${name} took longer than expected to load (${duration.toFixed(2)}ms). Consider optimizing this module.`);
            }
          }, 500);
        } else {
          // 所有脚本都已加载，直接执行模块
          try {
            originalLoadModule(name);
            performanceMonitor.end(moduleLoadKey);
          } catch (error) {
            console.error(`Failed to load module ${name}:`, error);
            loadBasicModule(name);
            performanceMonitor.end(moduleLoadKey);
          }
        }
      } else {
        // 没有特定的脚本需求，直接加载基础模块
        loadBasicModule(name);
        performanceMonitor.end(moduleLoadKey);
      }
    };
    
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
      // 预加载常用模块
      setTimeout(preloadCommonModules, 300);
      
      // 加载基础功能模块 - 不再加载missing_modules.js，因为所有模块都有专用实现
      // loadScript('missing_modules.js'); // 注释掉，避免覆盖专用模块
    });
  </script>
</body>
</html>
