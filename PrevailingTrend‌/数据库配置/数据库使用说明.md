# 数据库配置和使用说明

## 📊 数据库概览

### 数据库信息
- **数据库名**: `pt` (PrevailingTrend)
- **主机**: localhost:3306
- **用户名**: root
- **密码**: rr1234RR
- **字符集**: utf8mb4

### 表名规范
所有表名都按照层级和模块进行组织，便于识别和管理：

```
l{层级}_{模块}_{表名}
```

例如：
- `l1_wind_industry_classification` - 第一层万得行业分类
- `l2_company_attributes` - 第二层公司属性
- `l3_financial_balance_sheet` - 第三层财务资产负债表

## 🏗️ 表结构设计

### 第一层模块 - 数据采集层

#### 1. 万得行业分类
- **l1_wind_industry_classification**: 行业分类基础数据
- **l1_wind_stock_industry_mapping**: 股票行业映射关系

#### 2. 公司名字列表
- **l1_company_list_info**: 公司基础信息
- **l1_company_market_classification**: 市场分类信息

#### 3. 热点数据
- **l1_domestic_hotspot_data**: 国内热点数据
- **l1_foreign_hotspot_data**: 国外热点数据
- **l1_forum_hotspot_data**: 论坛热点数据

#### 4. 指数数据
- **l1_tencent_index_data**: 腾讯济安指数数据
- **l1_tencent_index_history**: 指数历史数据

#### 5. 其他信息
- **l1_internet_info_data**: 其他互联网信息

### 第二层模块 - 数据处理层
- **l2_company_attributes**: 公司属性数据
- **l2_hotspot_data_summary**: 热点数据汇总

### 第三层模块 - 数据整合层
- **l3_qcc_company_data**: 企查查公司数据
- **l3_tax_bank_report_data**: 税银报告数据
- **l3_financial_balance_sheet**: 财务资产负债表
- **l3_financial_income_statement**: 财务利润表
- **l3_financial_cash_flow**: 财务现金流量表

### 第四层模块 - 数据评分层
- **l4_company_score**: 公司评分
- **l4_industry_score**: 行业评分
- **l4_industry_company_score**: 行业公司评分

### 第五层模块 - 权重配置层
- **l5_factor_weights**: 因子权重配置

### 第六层模块 - 预测分析层
- **l6_curve_prediction_data**: 曲线预测数据

### 系统表
- **system_logs**: 系统日志
- **system_data_flow_logs**: 数据流向日志
- **system_module_status**: 模块状态
- **system_data_quality**: 数据质量

## 🚀 快速开始

### 1. 初始化数据库

```bash
cd 数据库配置
java init_database.py
```

### 2. 测试数据库连接

```bash
java test_database.py
```

### 3. 使用数据库配置

```java
from database_config import db_config, table_names

# 获取连接配置
config = db_config.get_connection_config()

# 获取表名
table_name = table_names.get_table_name('LAYER1', 'wind_industry', 'industry_classification')
# 返回: l1_wind_industry_classification
```

## 📋 数据流向追踪

### 数据流向设计
每个表都包含以下字段用于数据追踪：

- **source**: 数据来源
- **update_date**: 数据更新日期
- **created_at**: 创建时间
- **updated_at**: 更新时间

### 数据流向日志
`system_data_flow_logs` 表记录数据在各模块间的流向：

```sql
SELECT * FROM system_data_flow_logs 
WHERE source_module = '万得行业分类' 
AND target_module = '公司属性表'
ORDER BY start_time DESC;
```

## 🔍 数据查询示例

### 1. 查看公司完整数据流

```sql
-- 查看公司在各层级的完整数据
SELECT 
    c.company_name,
    c.stock_code,
    w.industry_name,
    w.industry_level,
    ca.attribute_value,
    cs.score_value
FROM l1_company_list_info c
LEFT JOIN l1_wind_stock_industry_mapping w ON c.stock_code = w.stock_code
LEFT JOIN l2_company_attributes ca ON c.stock_code = ca.stock_code
LEFT JOIN l4_company_score cs ON c.stock_code = cs.stock_code
WHERE c.stock_code = '000001';
```

### 2. 查看模块数据统计

```sql
-- 查看各模块数据量
SELECT 
    'l1_wind_industry_classification' as table_name,
    COUNT(*) as record_count
FROM l1_wind_industry_classification
UNION ALL
SELECT 
    'l1_company_list_info' as table_name,
    COUNT(*) as record_count
FROM l1_company_list_info
UNION ALL
SELECT 
    'l1_domestic_hotspot_data' as table_name,
    COUNT(*) as record_count
FROM l1_domestic_hotspot_data;
```

### 3. 查看数据质量

```sql
-- 查看数据质量报告
SELECT 
    table_name,
    layer,
    module,
    total_records,
    completeness_rate,
    accuracy_rate,
    quality_score,
    check_date
FROM system_data_quality
ORDER BY check_date DESC, quality_score DESC;
```

## 🔧 配置管理

### 环境变量配置
创建 `.env` 文件：

```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=rr1234RR
DB_DATABASE=pt
DB_CHARSET=utf8mb4

# 连接池配置
DB_MAX_CONNECTIONS=20
DB_MIN_CONNECTIONS=5
DB_CONNECTION_TIMEOUT=30
```

### 表名配置
在 `database_config.py` 中的 `TableNames` 类中配置表名：

```java
LAYER1 = {
    'wind_industry': {
        'industry_classification': 'l1_wind_industry_classification',
        'stock_industry_mapping': 'l1_wind_stock_industry_mapping'
    }
}
```

## 📊 监控和维护

### 1. 数据质量监控

```sql
-- 查看数据完整性
SELECT 
    table_name,
    total_records,
    valid_records,
    completeness_rate
FROM system_data_quality
WHERE check_date = CURDATE();
```

### 2. 模块状态监控

```sql
-- 查看模块运行状态
SELECT 
    module_name,
    layer,
    status,
    last_run_time,
    run_count,
    error_count
FROM system_module_status
ORDER BY layer, module_name;
```

### 3. 数据流向监控

```sql
-- 查看数据流向
SELECT 
    source_layer,
    source_module,
    target_layer,
    target_module,
    data_type,
    record_count,
    status,
    duration_seconds
FROM system_data_flow_logs
WHERE DATE(start_time) = CURDATE()
ORDER BY start_time DESC;
```

## 🎯 最佳实践

### 1. 数据插入
- 始终包含 `source` 字段标识数据来源
- 使用 `created_at` 和 `updated_at` 字段追踪时间
- 批量插入时使用 `INSERT IGNORE` 避免重复

### 2. 数据查询
- 使用索引字段进行查询优化
- 按层级和模块组织查询逻辑
- 使用 `system_data_flow_logs` 追踪数据流向

### 3. 数据维护
- 定期检查数据质量
- 监控模块运行状态
- 清理过期数据

## 🔍 故障排除

### 1. 连接问题
```bash
# 检查MySQL服务状态
net start mysql

# 检查端口占用
netstat -an | findstr :3306
```

### 2. 权限问题
```sql
-- 检查用户权限
SHOW GRANTS FOR 'root'@'localhost';
```

### 3. 表不存在
```bash
# 重新初始化数据库
java init_database.py
```

## 📈 性能优化

### 1. 索引优化
所有表都包含必要的索引：
- 主键索引
- 业务字段索引
- 时间字段索引

### 2. 查询优化
- 使用 `EXPLAIN` 分析查询计划
- 避免全表扫描
- 合理使用 `LIMIT`

### 3. 连接池配置
- 根据并发需求调整连接池大小
- 监控连接使用情况
- 及时释放连接

## 🎉 总结

数据库配置已经完成，具备以下特性：

✅ **完整的表结构设计**
✅ **按层级组织的表名规范**
✅ **数据流向追踪功能**
✅ **系统监控和维护功能**
✅ **示例数据和测试脚本**

现在您可以开始使用数据库来存储和管理各个模块的数据了！ 