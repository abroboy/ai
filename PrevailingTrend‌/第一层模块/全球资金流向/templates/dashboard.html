<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒèµ„é‡‘æµå‘åˆ†æä»ªè¡¨ç›˜</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .metric-card { text-align: center; padding: 20px; }
        .metric-value { font-size: 2rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <h2 class="mt-4 mb-4">å…¨çƒèµ„é‡‘æµå‘åˆ†æä»ªè¡¨ç›˜</h2>
                
                <!-- å…³é”®æŒ‡æ ‡ -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card metric-card">
                            <div class="metric-value text-success" id="global-flow">+125.6B</div>
                            <div>å…¨çƒå‡€æµå…¥</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card">
                            <div class="metric-value text-primary" id="forex-flow">+45.2B</div>
                            <div>å¤–æ±‡æµå‘</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card">
                            <div class="metric-value text-warning" id="stock-flow">+38.7B</div>
                            <div>è‚¡ç¥¨æµå‘</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card">
                            <div class="metric-value text-info" id="bond-flow">+41.7B</div>
                            <div>å€ºåˆ¸æµå‘</div>
                        </div>
                    </div>
                </div>
                
                <!-- æ•°æ®çŠ¶æ€ -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="alert alert-info" id="data-status">
                            <strong>æ•°æ®çŠ¶æ€:</strong> <span id="last-update">æ­£åœ¨åŠ è½½...</span>
                        </div>
                    </div>
                </div>

                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>æ•°æ®æ”¶é›†</h5>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-primary" onclick="collectData()">æ”¶é›†æ•°æ®</button>
                                <div id="collection-status" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>æµå‘åˆ†æ</h5>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-success" onclick="analyzeFlow()">å¼€å§‹åˆ†æ</button>
                                <div id="analysis-results" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°æ•°æ®
            setInterval(loadDashboardData, 30000);
        });

        function loadDashboardData() {
            fetch('/api/dashboard_data')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateDashboard(data.data);
                    } else {
                        console.error('è·å–æ•°æ®å¤±è´¥:', data.message);
                    }
                })
                .catch(error => {
                    console.error('è¯·æ±‚å¤±è´¥:', error);
                    document.getElementById('data-status').innerHTML = 
                        '<div class="alert alert-warning"><strong>æ•°æ®çŠ¶æ€:</strong> è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®</div>';
                });
        }

        function updateDashboard(data) {
            const analysis = data.global_analysis;
            
            // æ›´æ–°å…³é”®æŒ‡æ ‡
            if (analysis.forex) {
                const forexValue = analysis.forex.total_net_flow;
                const forexElement = document.getElementById('forex-flow');
                forexElement.textContent = (forexValue >= 0 ? '+' : '') + forexValue.toFixed(1) + 'B';
                forexElement.className = 'metric-value ' + (forexValue >= 0 ? 'text-success' : 'text-danger');
            }
            
            if (analysis.stock) {
                const stockValue = analysis.stock.total_net_flow;
                const stockElement = document.getElementById('stock-flow');
                stockElement.textContent = (stockValue >= 0 ? '+' : '') + stockValue.toFixed(1) + 'B';
                stockElement.className = 'metric-value ' + (stockValue >= 0 ? 'text-success' : 'text-danger');
            }
            
            if (analysis.bond) {
                const bondValue = analysis.bond.total_net_flow;
                const bondElement = document.getElementById('bond-flow');
                bondElement.textContent = (bondValue >= 0 ? '+' : '') + bondValue.toFixed(1) + 'B';
                bondElement.className = 'metric-value ' + (bondValue >= 0 ? 'text-success' : 'text-danger');
            }
            
            // è®¡ç®—å…¨çƒå‡€æµå…¥
            const globalFlow = (analysis.forex?.total_net_flow || 0) + 
                              (analysis.stock?.total_net_flow || 0) + 
                              (analysis.bond?.total_net_flow || 0) + 
                              (analysis.commodity?.total_net_flow || 0);
            
            const globalElement = document.getElementById('global-flow');
            globalElement.textContent = (globalFlow >= 0 ? '+' : '') + globalFlow.toFixed(1) + 'B';
            globalElement.className = 'metric-value ' + (globalFlow >= 0 ? 'text-success' : 'text-danger');
            
            // æ›´æ–°æ•°æ®çŠ¶æ€
            const lastUpdate = data.last_update ? new Date(data.last_update).toLocaleString('zh-CN') : 'æœªçŸ¥';
            document.getElementById('last-update').textContent = lastUpdate;
            
            if (data.note) {
                document.getElementById('data-status').innerHTML = 
                    `<div class="alert alert-info"><strong>æ•°æ®çŠ¶æ€:</strong> ${data.note} | æœ€åæ›´æ–°: ${lastUpdate}</div>`;
            } else {
                document.getElementById('data-status').innerHTML = 
                    `<div class="alert alert-success"><strong>æ•°æ®çŠ¶æ€:</strong> å®æ—¶æ•°æ® | æœ€åæ›´æ–°: ${lastUpdate}</div>`;
            }
        }

        function collectData() {
            const statusDiv = document.getElementById('collection-status');
            statusDiv.innerHTML = '<div class="alert alert-info">æ­£åœ¨æ”¶é›†æ•°æ®...</div>';

            fetch('/api/collect_data', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusDiv.innerHTML = '<div class="alert alert-success">æ•°æ®æ”¶é›†æˆåŠŸï¼</div>';
                        // æ”¶é›†å®Œæˆååˆ·æ–°æ•°æ®
                        setTimeout(loadDashboardData, 1000);
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-danger">æ”¶é›†å¤±è´¥: ' + data.message + '</div>';
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = '<div class="alert alert-danger">è¯·æ±‚å¤±è´¥: ' + error.message + '</div>';
                });
        }

        function analyzeFlow() {
            const resultsDiv = document.getElementById('analysis-results');
            resultsDiv.innerHTML = '<div class="alert alert-info">æ­£åœ¨åˆ†æ...</div>';

            fetch('/api/flow_analysis?period=30d')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const analysis = data.data.analysis;
                        let resultHtml = '<div class="alert alert-success"><h6>åˆ†æç»“æœ:</h6><ul>';
                        
                        for (const [asset, info] of Object.entries(analysis)) {
                            const trend = info.trend === 'up' ? 'ğŸ“ˆ' : 'ğŸ“‰';
                            const color = info.trend === 'up' ? 'text-success' : 'text-danger';
                            resultHtml += `<li class="${color}">${asset.toUpperCase()}: ${trend} ${info.total_net_flow.toFixed(1)}B (${info.count}æ¡è®°å½•)</li>`;
                        }
                        
                        resultHtml += '</ul></div>';
                        resultsDiv.innerHTML = resultHtml;
                    } else {
                        resultsDiv.innerHTML = '<div class="alert alert-danger">åˆ†æå¤±è´¥: ' + data.message + '</div>';
                    }
                })
                .catch(error => {
                    resultsDiv.innerHTML = '<div class="alert alert-danger">è¯·æ±‚å¤±è´¥: ' + error.message + '</div>';
                });
        }
    </script>
</body>
</html> 