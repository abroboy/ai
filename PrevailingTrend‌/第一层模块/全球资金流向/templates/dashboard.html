<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全球资金流向分析仪表盘</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .metric-card { text-align: center; padding: 20px; }
        .metric-value { font-size: 2rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <h2 class="mt-4 mb-4">全球资金流向分析仪表盘</h2>
                
                <!-- 关键指标 -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card metric-card">
                            <div class="metric-value text-success" id="global-flow">+125.6B</div>
                            <div>全球净流入</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card">
                            <div class="metric-value text-primary" id="forex-flow">+45.2B</div>
                            <div>外汇流向</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card">
                            <div class="metric-value text-warning" id="stock-flow">+38.7B</div>
                            <div>股票流向</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card metric-card">
                            <div class="metric-value text-info" id="bond-flow">+41.7B</div>
                            <div>债券流向</div>
                        </div>
                    </div>
                </div>
                
                <!-- 数据状态 -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="alert alert-info" id="data-status">
                            <strong>数据状态:</strong> <span id="last-update">正在加载...</span>
                        </div>
                    </div>
                </div>

                <!-- 控制面板 -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>数据收集</h5>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-primary" onclick="collectData()">收集数据</button>
                                <div id="collection-status" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>流向分析</h5>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-success" onclick="analyzeFlow()">开始分析</button>
                                <div id="analysis-results" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 页面加载时获取数据
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            // 每30秒自动刷新数据
            setInterval(loadDashboardData, 30000);
        });

        function loadDashboardData() {
            fetch('/api/dashboard_data')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateDashboard(data.data);
                    } else {
                        console.error('获取数据失败:', data.message);
                    }
                })
                .catch(error => {
                    console.error('请求失败:', error);
                    document.getElementById('data-status').innerHTML = 
                        '<div class="alert alert-warning"><strong>数据状态:</strong> 连接失败，使用缓存数据</div>';
                });
        }

        function updateDashboard(data) {
            const analysis = data.global_analysis;
            
            // 更新关键指标
            if (analysis.forex) {
                const forexValue = analysis.forex.total_net_flow;
                const forexElement = document.getElementById('forex-flow');
                forexElement.textContent = (forexValue >= 0 ? '+' : '') + forexValue.toFixed(1) + 'B';
                forexElement.className = 'metric-value ' + (forexValue >= 0 ? 'text-success' : 'text-danger');
            }
            
            if (analysis.stock) {
                const stockValue = analysis.stock.total_net_flow;
                const stockElement = document.getElementById('stock-flow');
                stockElement.textContent = (stockValue >= 0 ? '+' : '') + stockValue.toFixed(1) + 'B';
                stockElement.className = 'metric-value ' + (stockValue >= 0 ? 'text-success' : 'text-danger');
            }
            
            if (analysis.bond) {
                const bondValue = analysis.bond.total_net_flow;
                const bondElement = document.getElementById('bond-flow');
                bondElement.textContent = (bondValue >= 0 ? '+' : '') + bondValue.toFixed(1) + 'B';
                bondElement.className = 'metric-value ' + (bondValue >= 0 ? 'text-success' : 'text-danger');
            }
            
            // 计算全球净流入
            const globalFlow = (analysis.forex?.total_net_flow || 0) + 
                              (analysis.stock?.total_net_flow || 0) + 
                              (analysis.bond?.total_net_flow || 0) + 
                              (analysis.commodity?.total_net_flow || 0);
            
            const globalElement = document.getElementById('global-flow');
            globalElement.textContent = (globalFlow >= 0 ? '+' : '') + globalFlow.toFixed(1) + 'B';
            globalElement.className = 'metric-value ' + (globalFlow >= 0 ? 'text-success' : 'text-danger');
            
            // 更新数据状态
            const lastUpdate = data.last_update ? new Date(data.last_update).toLocaleString('zh-CN') : '未知';
            document.getElementById('last-update').textContent = lastUpdate;
            
            if (data.note) {
                document.getElementById('data-status').innerHTML = 
                    `<div class="alert alert-info"><strong>数据状态:</strong> ${data.note} | 最后更新: ${lastUpdate}</div>`;
            } else {
                document.getElementById('data-status').innerHTML = 
                    `<div class="alert alert-success"><strong>数据状态:</strong> 实时数据 | 最后更新: ${lastUpdate}</div>`;
            }
        }

        function collectData() {
            const statusDiv = document.getElementById('collection-status');
            statusDiv.innerHTML = '<div class="alert alert-info">正在收集数据...</div>';

            fetch('/api/collect_data', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusDiv.innerHTML = '<div class="alert alert-success">数据收集成功！</div>';
                        // 收集完成后刷新数据
                        setTimeout(loadDashboardData, 1000);
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-danger">收集失败: ' + data.message + '</div>';
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = '<div class="alert alert-danger">请求失败: ' + error.message + '</div>';
                });
        }

        function analyzeFlow() {
            const resultsDiv = document.getElementById('analysis-results');
            resultsDiv.innerHTML = '<div class="alert alert-info">正在分析...</div>';

            fetch('/api/flow_analysis?period=30d')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const analysis = data.data.analysis;
                        let resultHtml = '<div class="alert alert-success"><h6>分析结果:</h6><ul>';
                        
                        for (const [asset, info] of Object.entries(analysis)) {
                            const trend = info.trend === 'up' ? '📈' : '📉';
                            const color = info.trend === 'up' ? 'text-success' : 'text-danger';
                            resultHtml += `<li class="${color}">${asset.toUpperCase()}: ${trend} ${info.total_net_flow.toFixed(1)}B (${info.count}条记录)</li>`;
                        }
                        
                        resultHtml += '</ul></div>';
                        resultsDiv.innerHTML = resultHtml;
                    } else {
                        resultsDiv.innerHTML = '<div class="alert alert-danger">分析失败: ' + data.message + '</div>';
                    }
                })
                .catch(error => {
                    resultsDiv.innerHTML = '<div class="alert alert-danger">请求失败: ' + error.message + '</div>';
                });
        }
    </script>
</body>
</html> 