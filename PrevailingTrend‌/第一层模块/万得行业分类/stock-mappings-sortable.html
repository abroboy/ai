<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>万得行业分类股票映射管理 - 可排序版本</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .sortable-header:hover {
            background-color: #f8f9fa;
        }
        .sort-icon {
            margin-left: 5px;
            opacity: 0.5;
        }
        .sort-icon.active {
            opacity: 1;
        }
        .table-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: white;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-chart-line"></i> 万得行业分类股票映射管理
                    <small class="text-muted">可排序版本</small>
                </h1>
                
                <!-- 统计信息卡片 -->
                <div class="row mb-4">
                    <div class="col-md-2">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <h4 id="totalStocks">--</h4>
                                <p class="mb-0">总股票数</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h4 id="aStocks" class="text-primary">--</h4>
                                <p class="mb-0">A股</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h4 id="kcStocks" class="text-success">--</h4>
                                <p class="mb-0">科创板</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h4 id="gemStocks" class="text-warning">--</h4>
                                <p class="mb-0">创业板</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <h4 id="hkStocks" class="text-info">--</h4>
                                <p class="mb-0">港股通</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card border-secondary">
                            <div class="card-body text-center">
                                <small id="lastUpdate" class="text-muted">--</small>
                                <p class="mb-0">最后更新</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 搜索和过滤控件 -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="搜索股票代码或名称">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="marketFilter">
                            <option value="all">全部市场</option>
                            <option value="A股">A股</option>
                            <option value="科创板">科创板</option>
                            <option value="创业板">创业板</option>
                            <option value="港股通">港股通</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="pageSizeSelect">
                            <option value="20">每页20条</option>
                            <option value="50">每页50条</option>
                            <option value="100">每页100条</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary" onclick="loadStockData()">
                                <i class="fas fa-sync-alt"></i> 刷新数据
                            </button>
                            <button class="btn btn-outline-success" onclick="exportData()">
                                <i class="fas fa-download"></i> 导出数据
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-end">
                            <span class="badge bg-info" id="recordCount">记录数: 0</span>
                        </div>
                    </div>
                </div>
                
                <!-- 股票数据表格 -->
                <div class="table-container">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark sticky-header">
                            <tr>
                                <th class="sortable-header" data-sort="stockCode">
                                    股票代码 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable-header" data-sort="stockName">
                                    股票名称 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable-header" data-sort="marketType">
                                    市场类型 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable-header" data-sort="industryName">
                                    所属行业 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th>映射状态</th>
                                <th class="sortable-header" data-sort="totalMarketValue">
                                    总市值(万) <i class="fas fa-sort sort-icon active"></i>
                                </th>
                                <th class="sortable-header" data-sort="dailyNetInflow">
                                    日资金净流入(万) <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable-header" data-sort="netInflowRatio">
                                    流入比例(%) <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable-header" data-sort="recentVolatility">
                                    最近波动率 <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th class="sortable-header" data-sort="latest7dInflow">
                                    最近7日流入(万) <i class="fas fa-sort sort-icon"></i>
                                </th>
                                <th>最后更新</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                            <tr>
                                <td colspan="12" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i> 加载数据中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页控件 -->
                <nav aria-label="股票数据分页">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- 分页按钮将通过JavaScript动态生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <!-- 浮动刷新按钮 -->
    <button class="btn btn-primary btn-lg refresh-btn" onclick="refreshAllData()" title="刷新所有数据">
        <i class="fas fa-sync-alt"></i>
    </button>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 0;
        let pageSize = 20;
        let currentSort = 'totalMarketValue';
        let currentSortOrder = 'desc';
        let currentMarketFilter = 'all';
        let currentSearch = '';
        let totalElements = 0;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadStockData();
            
            // 搜索框事件
            document.getElementById('searchInput').addEventListener('input', function() {
                currentSearch = this.value;
                currentPage = 0;
                loadStockData();
            });
            
            // 市场筛选事件
            document.getElementById('marketFilter').addEventListener('change', function() {
                currentMarketFilter = this.value;
                currentPage = 0;
                loadStockData();
            });
            
            // 页大小变化事件
            document.getElementById('pageSizeSelect').addEventListener('change', function() {
                pageSize = parseInt(this.value);
                currentPage = 0;
                loadStockData();
            });
            
            // 表头排序事件
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', function() {
                    const sortField = this.getAttribute('data-sort');
                    
                    // 如果点击的是当前排序字段，则切换排序方向
                    if (currentSort === sortField) {
                        currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort = sortField;
                        currentSortOrder = 'desc'; // 新字段默认降序
                    }
                    
                    updateSortIcons();
                    currentPage = 0;
                    loadStockData();
                });
            });
        });
        
        // 加载统计数据
        function loadStats() {
            fetch('/api/stock-mappings/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('totalStocks').textContent = data.data.total_stocks;
                        document.getElementById('aStocks').textContent = data.data.a_stock_count;
                        document.getElementById('kcStocks').textContent = data.data.kc_stock_count;
                        document.getElementById('gemStocks').textContent = data.data.gem_stock_count;
                        document.getElementById('hkStocks').textContent = data.data.hk_stock_count;
                        document.getElementById('lastUpdate').textContent = data.data.last_update;
                    }
                })
                .catch(error => {
                    console.error('加载统计数据失败:', error);
                });
        }
        
        // 加载股票数据
        function loadStockData() {
            const params = new URLSearchParams({
                page: currentPage,
                size: pageSize,
                sortBy: currentSort,
                sortOrder: currentSortOrder
            });
            
            if (currentMarketFilter !== 'all') {
                params.append('marketType', currentMarketFilter);
            }
            
            if (currentSearch) {
                params.append('search', currentSearch);
            }
            
            fetch(`/api/stock-mappings?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayStockData(data.data.content);
                        totalElements = data.data.totalElements;
                        updatePagination(data.data);
                        updateRecordCount(data.data);
                    } else {
                        showError('加载数据失败: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('加载股票数据失败:', error);
                    showError('网络请求失败，请检查服务器连接');
                });
        }
        
        // 显示股票数据
        function displayStockData(stocks) {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';
            
            if (stocks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">暂无数据</td></tr>';
                return;
            }
            
            stocks.forEach(stock => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${stock.stockCode}</strong></td>
                    <td>${stock.stockName}</td>
                    <td>
                        <span class="badge ${getMarketTypeBadgeClass(stock.marketType)}">
                            ${stock.marketType}
                        </span>
                    </td>
                    <td>${stock.industryName || '未分类'}</td>
                    <td>
                        <span class="badge ${stock.mappingStatus === '已映射' ? 'bg-success' : 'bg-warning'}">
                            ${stock.mappingStatus}
                        </span>
                    </td>
                    <td class="text-end">${formatNumber(stock.totalMarketValue)}</td>
                    <td class="text-end ${stock.dailyNetInflow >= 0 ? 'text-success' : 'text-danger'}">
                        ${formatNumber(stock.dailyNetInflow)}
                    </td>
                    <td class="text-end ${stock.netInflowRatio >= 0 ? 'text-success' : 'text-danger'}">
                        ${(stock.netInflowRatio * 100).toFixed(2)}%
                    </td>
                    <td class="text-end">${(stock.recentVolatility * 100).toFixed(2)}%</td>
                    <td class="text-end ${stock.latest7dInflow >= 0 ? 'text-success' : 'text-danger'}">
                        ${formatNumber(stock.latest7dInflow)}
                    </td>
                    <td>${formatDateTime(stock.lastUpdated)}</td>
                    <td>
                        <div class="btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewDetails('${stock.stockCode}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="editMapping('${stock.stockCode}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 更新排序图标
        function updateSortIcons() {
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.classList.remove('active');
                icon.className = 'fas fa-sort sort-icon';
            });
            
            const activeHeader = document.querySelector(`[data-sort="${currentSort}"] .sort-icon`);
            if (activeHeader) {
                activeHeader.classList.add('active');
                activeHeader.className = `fas fa-sort-${currentSortOrder === 'asc' ? 'up' : 'down'} sort-icon active`;
            }
        }
        
        // 更新分页控件
        function updatePagination(pageData) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            const totalPages = pageData.totalPages;
            const currentPageNum = pageData.currentPage;
            
            // 上一页
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPageNum === 0 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPageNum - 1})">上一页</a>`;
            pagination.appendChild(prevLi);
            
            // 页码
            const startPage = Math.max(0, currentPageNum - 2);
            const endPage = Math.min(totalPages - 1, currentPageNum + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPageNum ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i + 1}</a>`;
                pagination.appendChild(li);
            }
            
            // 下一页
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPageNum >= totalPages - 1 ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPageNum + 1})">下一页</a>`;
            pagination.appendChild(nextLi);
        }
        
        // 更新记录计数
        function updateRecordCount(pageData) {
            const start = pageData.currentPage * pageData.size + 1;
            const end = Math.min(start + pageData.numberOfElements - 1, pageData.totalElements);
            document.getElementById('recordCount').textContent = 
                `显示 ${start}-${end} / 共 ${pageData.totalElements} 条记录`;
        }
        
        // 切换页面
        function changePage(page) {
            if (page >= 0 && page < Math.ceil(totalElements / pageSize)) {
                currentPage = page;
                loadStockData();
            }
        }
        
        // 刷新所有数据
        function refreshAllData() {
            fetch('/api/stock-mappings/refresh', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccess('数据刷新成功！');
                        setTimeout(() => {
                            loadStats();
                            loadStockData();
                        }, 2000);
                    } else {
                        showError('数据刷新失败: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('刷新数据失败:', error);
                    showError('刷新请求失败');
                });
        }
        
        // 导出数据
        function exportData() {
            const params = new URLSearchParams({
                page: 0,
                size: totalElements, // 导出全部数据
                sortBy: currentSort,
                sortOrder: currentSortOrder
            });
            
            if (currentMarketFilter !== 'all') {
                params.append('marketType', currentMarketFilter);
            }
            
            if (currentSearch) {
                params.append('search', currentSearch);
            }
            
            window.open(`/api/stock-mappings?${params.toString()}&export=true`);
        }
        
        // 查看详情
        function viewDetails(stockCode) {
            alert(`查看股票 ${stockCode} 的详细信息（功能开发中）`);
        }
        
        // 编辑映射
        function editMapping(stockCode) {
            alert(`编辑股票 ${stockCode} 的行业映射（功能开发中）`);
        }
        
        // 工具函数
        function getMarketTypeBadgeClass(marketType) {
            const badgeClasses = {
                'A股': 'bg-primary',
                '科创板': 'bg-success',
                '创业板': 'bg-warning',
                '港股通': 'bg-info'
            };
            return badgeClasses[marketType] || 'bg-secondary';
        }
        
        function formatNumber(num) {
            if (num === null || num === undefined) return '--';
            return new Intl.NumberFormat('zh-CN', { 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 2 
            }).format(num);
        }
        
        function formatDateTime(dateTime) {
            if (!dateTime) return '--';
            return new Date(dateTime).toLocaleString('zh-CN');
        }
        
        function showSuccess(message) {
            showAlert(message, 'success');
        }
        
        function showError(message) {
            showAlert(message, 'danger');
        }
        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>