# 万得行业分类模块 - 免费数据源实施指南

## 免费数据源方案

### 🎯 推荐免费组合方案
```
主数据源: Tushare（需注册，基础功能免费）
补充数据源: AKShare（完全免费，无需注册）
验证数据源: 东方财富网API（免费，无需注册）
概念数据源: 同花顺API（免费，无需注册）
```

### 数据源特点对比

| 数据源 | 注册要求 | 调用限制 | 行业层级 | 数据完整性 | 推荐指数 |
|--------|----------|----------|----------|------------|----------|
| Tushare | 需注册 | 200次/分钟 | 3级完整 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| AKShare | 无需注册 | 无明确限制 | 2级 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 东方财富 | 无需注册 | ~60次/分钟 | 2级 | ⭐⭐⭐ | ⭐⭐⭐ |
| 同花顺 | 无需注册 | ~30次/分钟 | 概念板块 | ⭐⭐⭐ | ⭐⭐⭐ |

## 详细执行步骤

### 第一步：环境准备（预计时间：30分钟）

#### 1.1 创建Python虚拟环境
```bash
# 切换到项目目录
cd "第一层模块/万得行业分类"

# 创建虚拟环境
python -m venv venv

# 激活虚拟环境（Windows）
venv\Scripts\activate

# 激活虚拟环境（Linux/Mac）
source venv/bin/activate
```

#### 1.2 安装必要的依赖包
```bash
# 安装核心依赖
pip install tushare akshare pandas requests mysql-connector-python schedule

# 或者使用requirements文件
pip install -r requirements.txt
```

#### 1.3 验证环境安装
```bash
python -c "import tushare as ts; print('Tushare版本:', ts.__version__)"
python -c "import akshare as ak; print('AKShare版本:', ak.__version__)"
python -c "import pandas as pd; print('Pandas版本:', pd.__version__)"
python -c "import requests; print('Requests安装成功')"
```

### 第二步：Tushare配置（预计时间：15分钟）

#### 2.1 注册Tushare账号
1. 访问 https://tushare.pro
2. 注册账号并完成邮箱验证
3. 在用户中心获取API Token

#### 2.2 测试Tushare连接
```python
# 创建测试文件：test_tushare.py
import tushare as ts

# 设置token（替换为您的实际token）
ts.set_token('your_tushare_token_here')
pro = ts.pro_api()

def test_tushare_industry():
    """测试Tushare行业分类获取"""
    try:
        print("正在测试Tushare行业分类...")
        
        # 获取申万一级行业分类
        df = pro.index_classify(level='L1', src='SW2021')
        print(f"申万一级行业数量: {len(df)}")
        print("前5个行业:")
        print(df.head())
        
        # 获取申万二级行业分类
        df2 = pro.index_classify(level='L2', src='SW2021')
        print(f"申万二级行业数量: {len(df2)}")
        
        return True
    except Exception as e:
        print(f"Tushare测试失败: {e}")
        return False

if __name__ == "__main__":
    test_tushare_industry()
```

### 第三步：数据源测试（预计时间：30分钟）

#### 3.1 测试AKShare行业数据
```python
# 创建测试文件：test_akshare_industry.py
import akshare as ak
import pandas as pd

def test_akshare_industry():
    """测试AKShare行业数据获取"""
    try:
        print("正在测试AKShare行业数据...")
        
        # 获取同花顺行业板块
        df = ak.stock_board_industry_summary_ths()
        print(f"同花顺行业板块数量: {len(df)}")
        print("前5个行业板块:")
        print(df.head())
        
        # 获取概念板块
        concept_df = ak.stock_board_concept_summary_ths()
        print(f"概念板块数量: {len(concept_df)}")
        
        # 获取具体行业的成分股（示例：计算机行业）
        if len(df) > 0:
            industry_name = df.iloc[0]['板块名称']
            stocks_df = ak.stock_board_industry_cons_ths(symbol=industry_name)
            print(f"{industry_name}行业成分股数量: {len(stocks_df)}")
        
        return True
    except Exception as e:
        print(f"AKShare测试失败: {e}")
        return False

if __name__ == "__main__":
    test_akshare_industry()
```

#### 3.2 测试东方财富API
```python
# 创建测试文件：test_eastmoney_industry.py
import requests
import json

def test_eastmoney_industry():
    """测试东方财富行业数据"""
    try:
        print("正在测试东方财富行业数据...")
        
        # 获取行业板块列表
        url = "http://push2.eastmoney.com/api/qt/clist/get"
        params = {
            'pn': 1,
            'pz': 100,
            'po': 1,
            'np': 1,
            'ut': 'bd1d9ddb04089700cf9c27f6f7426281',
            'fltt': 2,
            'invt': 2,
            'fid': 'f3',
            'fs': 'm:90+t:2',  # 行业板块
            'fields': 'f12,f14,f2,f3,f62,f184,f225,f165'
        }
        
        response = requests.get(url, params=params, timeout=10)
        data = response.json()
        
        if data.get('rc') == 0 and data.get('data'):
            industries = data['data']['diff']
            print(f"东方财富行业板块数量: {len(industries)}")
            for industry in industries[:3]:  # 显示前3个
                print(f"  {industry['f12']}: {industry['f14']}")
            return True
        else:
            print("东方财富API返回数据格式异常")
            return False
    except Exception as e:
        print(f"东方财富API测试失败: {e}")
        return False

if __name__ == "__main__":
    test_eastmoney_industry()
```

### 第四步：数据库准备（预计时间：15分钟）

#### 4.1 确保MySQL运行
```bash
# 检查MySQL服务状态（Windows）
net start mysql

# 连接测试
mysql -u root -p
```

#### 4.2 创建行业分类表
```sql
-- 创建数据库（如果还没有）
CREATE DATABASE IF NOT EXISTS prevailing_trend 
CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

USE prevailing_trend;

-- 申万行业分类表
CREATE TABLE IF NOT EXISTS shenwan_industry_classification (
    id INT AUTO_INCREMENT PRIMARY KEY,
    sw_code VARCHAR(20) NOT NULL COMMENT '申万行业代码',
    sw_name VARCHAR(100) NOT NULL COMMENT '申万行业名称',
    industry_level TINYINT NOT NULL COMMENT '行业层级(1/2/3)',
    parent_code VARCHAR(20) COMMENT '父级行业代码',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否有效',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_sw_code_level (sw_code, industry_level),
    INDEX idx_parent_code (parent_code),
    INDEX idx_industry_level (industry_level)
) COMMENT '申万行业分类表';

-- 同花顺行业板块表
CREATE TABLE IF NOT EXISTS ths_industry_board (
    id INT AUTO_INCREMENT PRIMARY KEY,
    board_code VARCHAR(20) NOT NULL COMMENT '板块代码',
    board_name VARCHAR(100) NOT NULL COMMENT '板块名称',
    board_type ENUM('industry', 'concept') NOT NULL COMMENT '板块类型',
    stock_count INT DEFAULT 0 COMMENT '成分股数量',
    total_market_value DECIMAL(20,2) COMMENT '总市值',
    avg_price DECIMAL(10,2) COMMENT '平均价格',
    change_percent DECIMAL(8,4) COMMENT '涨跌幅',
    data_date DATE COMMENT '数据日期',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_board_code_date (board_code, data_date),
    INDEX idx_board_type (board_type),
    INDEX idx_data_date (data_date)
) COMMENT '同花顺行业板块表';

-- 行业成分股表
CREATE TABLE IF NOT EXISTS industry_constituents (
    id INT AUTO_INCREMENT PRIMARY KEY,
    industry_code VARCHAR(20) NOT NULL COMMENT '行业代码',
    industry_type ENUM('shenwan', 'ths_industry', 'ths_concept') NOT NULL COMMENT '行业类型',
    stock_code VARCHAR(10) NOT NULL COMMENT '股票代码',
    stock_name VARCHAR(50) NOT NULL COMMENT '股票名称',
    weight DECIMAL(8,4) COMMENT '权重',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否有效',
    effective_date DATE COMMENT '生效日期',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_industry_stock (industry_code, industry_type, stock_code),
    INDEX idx_stock_code (stock_code),
    INDEX idx_industry_code (industry_code),
    INDEX idx_industry_type (industry_type)
) COMMENT '行业成分股表';

-- 行业映射关系表
CREATE TABLE IF NOT EXISTS industry_mapping (
    id INT AUTO_INCREMENT PRIMARY KEY,
    source_type ENUM('shenwan', 'ths', 'eastmoney') NOT NULL COMMENT '源分类类型',
    source_code VARCHAR(20) NOT NULL COMMENT '源分类代码',
    source_name VARCHAR(100) NOT NULL COMMENT '源分类名称',
    target_type ENUM('shenwan', 'ths', 'eastmoney') NOT NULL COMMENT '目标分类类型',
    target_code VARCHAR(20) NOT NULL COMMENT '目标分类代码',
    target_name VARCHAR(100) NOT NULL COMMENT '目标分类名称',
    mapping_confidence DECIMAL(3,2) DEFAULT 1.00 COMMENT '映射置信度',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_source_target (source_type, source_code, target_type, target_code),
    INDEX idx_source (source_type, source_code),
    INDEX idx_target (target_type, target_code)
) COMMENT '行业映射关系表';
```

### 第五步：数据采集实现（预计时间：3小时）

#### 5.1 创建行业数据采集器
```python
# 创建文件：industry_data_collector.py
import tushare as ts
import akshare as ak
import requests
import pandas as pd
import time
import logging
from datetime import datetime, date
import sys
import os

# 添加配置路径
sys.path.append('.')
sys.path.append('../../数据库配置')

from database_config import get_database_manager

# 配置日志
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('industry_collector.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

class IndustryDataCollector:
    """行业数据采集器"""
    
    def __init__(self, tushare_token=None):
        self.db_manager = get_database_manager()
        self.tushare_token = tushare_token
        if tushare_token:
            ts.set_token(tushare_token)
            self.pro = ts.pro_api()
        else:
            self.pro = None
            logger.warning("未提供Tushare token，将跳过Tushare数据采集")
    
    def collect_shenwan_industries(self):
        """采集申万行业分类"""
        if not self.pro:
            logger.error("Tushare未配置，无法获取申万分类")
            return []
        
        try:
            logger.info("开始采集申万行业分类...")
            
            # 获取申万一级、二级、三级行业
            industries_data = []
            
            for level in ['L1', 'L2', 'L3']:
                logger.info(f"正在获取申万{level}级行业分类...")
                df = self.pro.index_classify(level=level, src='SW2021')
                
                for _, row in df.iterrows():
                    industry_data = {
                        'sw_code': row['index_code'],
                        'sw_name': row['industry_name'],
                        'industry_level': int(level[1]),
                        'parent_code': row.get('parent_code', None),
                        'data_source': 'tushare',
                        'is_active': True
                    }
                    industries_data.append(industry_data)
                
                time.sleep(0.5)  # 避免请求过快
            
            logger.info(f"申万行业分类采集完成，共获取 {len(industries_data)} 条数据")
            return industries_data
            
        except Exception as e:
            logger.error(f"申万行业分类采集失败: {e}")
            return []
    
    def collect_ths_industry_boards(self):
        """采集同花顺行业板块"""
        try:
            logger.info("开始采集同花顺行业板块...")
            
            # 获取行业板块
            industry_df = ak.stock_board_industry_summary_ths()
            
            # 获取概念板块
            concept_df = ak.stock_board_concept_summary_ths()
            
            boards_data = []
            
            # 处理行业板块
            for _, row in industry_df.iterrows():
                board_data = {
                    'board_code': f"THS_IND_{row['板块代码']}",
                    'board_name': row['板块名称'],
                    'board_type': 'industry',
                    'stock_count': row.get('成分股数量', 0),
                    'total_market_value': row.get('总市值', 0),
                    'change_percent': row.get('涨跌幅', 0),
                    'data_date': date.today(),
                    'data_source': 'akshare'
                }
                boards_data.append(board_data)
            
            # 处理概念板块
            for _, row in concept_df.iterrows():
                board_data = {
                    'board_code': f"THS_CON_{row['板块代码']}",
                    'board_name': row['板块名称'],
                    'board_type': 'concept',
                    'stock_count': row.get('成分股数量', 0),
                    'total_market_value': row.get('总市值', 0),
                    'change_percent': row.get('涨跌幅', 0),
                    'data_date': date.today(),
                    'data_source': 'akshare'
                }
                boards_data.append(board_data)
            
            logger.info(f"同花顺板块采集完成，共获取 {len(boards_data)} 条数据")
            return boards_data
            
        except Exception as e:
            logger.error(f"同花顺板块采集失败: {e}")
            return []
    
    def collect_industry_constituents(self, board_name):
        """采集行业成分股"""
        try:
            # 获取行业成分股
            stocks_df = ak.stock_board_industry_cons_ths(symbol=board_name)
            
            constituents_data = []
            for _, row in stocks_df.iterrows():
                constituent_data = {
                    'industry_code': f"THS_IND_{board_name}",
                    'industry_type': 'ths_industry',
                    'stock_code': row['代码'],
                    'stock_name': row['名称'],
                    'weight': None,  # 同花顺不提供权重信息
                    'is_active': True,
                    'effective_date': date.today()
                }
                constituents_data.append(constituent_data)
            
            return constituents_data
            
        except Exception as e:
            logger.error(f"获取 {board_name} 成分股失败: {e}")
            return []
    
    def save_shenwan_industries(self, industries_data):
        """保存申万行业分类到数据库"""
        if not industries_data:
            logger.warning("没有申万行业数据需要保存")
            return False
        
        try:
            if not self.db_manager.connect():
                logger.error("数据库连接失败")
                return False
            
            success_count = 0
            for industry in industries_data:
                sql = """
                INSERT INTO shenwan_industry_classification 
                (sw_code, sw_name, industry_level, parent_code, is_active, updated_at)
                VALUES (%s, %s, %s, %s, %s, NOW())
                ON DUPLICATE KEY UPDATE
                sw_name = VALUES(sw_name),
                parent_code = VALUES(parent_code),
                is_active = VALUES(is_active),
                updated_at = NOW()
                """
                
                params = (
                    industry['sw_code'],
                    industry['sw_name'],
                    industry['industry_level'],
                    industry.get('parent_code'),
                    industry['is_active']
                )
                
                if self.db_manager.execute_update(sql, params):
                    success_count += 1
            
            logger.info(f"申万行业数据保存完成，成功保存 {success_count} 条数据")
            return True
            
        except Exception as e:
            logger.error(f"申万行业数据保存失败: {e}")
            return False
        finally:
            self.db_manager.disconnect()
    
    def save_ths_boards(self, boards_data):
        """保存同花顺板块数据到数据库"""
        if not boards_data:
            logger.warning("没有同花顺板块数据需要保存")
            return False
        
        try:
            if not self.db_manager.connect():
                logger.error("数据库连接失败")
                return False
            
            success_count = 0
            for board in boards_data:
                sql = """
                INSERT INTO ths_industry_board 
                (board_code, board_name, board_type, stock_count, total_market_value, 
                 change_percent, data_date, updated_at)
                VALUES (%s, %s, %s, %s, %s, %s, %s, NOW())
                ON DUPLICATE KEY UPDATE
                board_name = VALUES(board_name),
                stock_count = VALUES(stock_count),
                total_market_value = VALUES(total_market_value),
                change_percent = VALUES(change_percent),
                updated_at = NOW()
                """
                
                params = (
                    board['board_code'],
                    board['board_name'],
                    board['board_type'],
                    board['stock_count'],
                    board['total_market_value'],
                    board['change_percent'],
                    board['data_date']
                )
                
                if self.db_manager.execute_update(sql, params):
                    success_count += 1
            
            logger.info(f"同花顺板块数据保存完成，成功保存 {success_count} 条数据")
            return True
            
        except Exception as e:
            logger.error(f"同花顺板块数据保存失败: {e}")
            return False
        finally:
            self.db_manager.disconnect()
    
    def run_collection(self):
        """执行完整的行业数据采集流程"""
        logger.info("开始执行行业数据采集任务...")
        start_time = time.time()
        
        # 1. 采集申万行业分类
        shenwan_data = self.collect_shenwan_industries()
        if shenwan_data:
            self.save_shenwan_industries(shenwan_data)
        
        # 2. 采集同花顺板块数据
        ths_data = self.collect_ths_industry_boards()
        if ths_data:
            self.save_ths_boards(ths_data)
        
        elapsed_time = time.time() - start_time
        logger.info(f"行业数据采集任务完成，耗时 {elapsed_time:.2f} 秒")
        
        return True

def main():
    """主函数"""
    # 设置Tushare token（请替换为您的实际token）
    tushare_token = "your_tushare_token_here"
    
    collector = IndustryDataCollector(tushare_token)
    collector.run_collection()

if __name__ == "__main__":
    main()
```

### 第六步：配置文件创建（预计时间：15分钟）

#### 6.1 创建配置文件
```python
# 创建文件：config.py
"""
万得行业分类模块配置文件
"""
import os

# 数据库配置
DATABASE_CONFIG = {
    'host': 'localhost',
    'port': 3306,
    'user': 'root',
    'password': 'your_password',
    'database': 'prevailing_trend',
    'charset': 'utf8mb4'
}

# Tushare配置
TUSHARE_CONFIG = {
    'token': 'your_tushare_token_here',  # 在 https://tushare.pro 注册获取
    'retry_count': 3,
    'retry_interval': 5,
    'request_interval': 0.5  # 请求间隔（秒）
}

# AKShare配置
AKSHARE_CONFIG = {
    'timeout': 30,
    'retry_count': 3,
    'retry_interval': 2,
    'request_interval': 1  # 请求间隔（秒）
}

# 东方财富API配置
EASTMONEY_CONFIG = {
    'base_url': 'http://push2.eastmoney.com/api/qt/clist/get',
    'timeout': 15,
    'retry_count': 3,
    'retry_interval': 3,
    'request_interval': 2  # 请求间隔（秒）
}

# 数据采集配置
COLLECTION_CONFIG = {
    'update_frequency': 'weekly',  # 更新频率：daily/weekly/monthly
    'batch_size': 500,
    'concurrent_requests': 2,
    'max_workers': 3
}

# 数据质量配置
QUALITY_CONFIG = {
    'min_industry_count': 25,  # 申万一级行业最少数量
    'max_industry_count': 35,  # 申万一级行业最多数量
    'min_concept_count': 300,  # 概念板块最少数量
    'data_freshness_days': 7   # 数据新鲜度要求（天）
}

# 日志配置
LOG_CONFIG = {
    'level': 'INFO',
    'format': '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    'file_path': 'industry_collector.log',
    'max_size': 10 * 1024 * 1024,  # 10MB
    'backup_count': 5
}

# 行业分类标准优先级
INDUSTRY_SOURCE_PRIORITY = [
    'shenwan',    # 申万分类（最高优先级）
    'ths',        # 同花顺分类
    'eastmoney'   # 东方财富分类
]

# 监控配置
MONITOR_CONFIG = {
    'enable_alerts': True,
    'alert_email': 'admin@yourcompany.com',
    'check_interval': 3600,  # 监控检查间隔（秒）
    'alert_thresholds': {
        'data_delay_hours': 24,
        'error_rate_percent': 5,
        'missing_data_percent': 10
    }
}
```

#### 6.2 创建requirements文件
```text
# 创建文件：requirements.txt
tushare>=1.2.89
akshare>=1.11.0
pandas>=1.5.0
requests>=2.28.0
mysql-connector-python>=8.0.32
schedule>=1.2.0
openpyxl>=3.1.0
beautifulsoup4>=4.11.0
lxml>=4.9.0
```

### 第七步：测试和验证（预计时间：30分钟）

#### 7.1 创建验证脚本
```python
# 创建文件：validate_industry_data.py
import sys
sys.path.append('../../数据库配置')
from database_config import get_database_manager
from datetime import datetime, timedelta

def validate_industry_data():
    """验证行业数据质量"""
    db_manager = get_database_manager()
    
    if not db_manager.connect():
        print("数据库连接失败")
        return
    
    try:
        print("=" * 50)
        print("行业数据质量验证报告")
        print("=" * 50)
        
        # 1. 检查申万行业分类数据
        print("\n1. 申万行业分类数据检查:")
        for level in [1, 2, 3]:
            result = db_manager.execute_query(
                "SELECT COUNT(*) FROM shenwan_industry_classification WHERE industry_level = %s",
                (level,)
            )
            count = result[0][0] if result else 0
            print(f"   申万{level}级行业数量: {count}")
        
        # 2. 检查同花顺板块数据
        print("\n2. 同花顺板块数据检查:")
        result = db_manager.execute_query(
            "SELECT board_type, COUNT(*) FROM ths_industry_board GROUP BY board_type"
        )
        for row in result:
            print(f"   {row[0]}板块数量: {row[1]}")
        
        # 3. 检查数据新鲜度
        print("\n3. 数据新鲜度检查:")
        result = db_manager.execute_query(
            "SELECT MAX(updated_at) FROM shenwan_industry_classification"
        )
        if result and result[0][0]:
            last_update = result[0][0]
            days_ago = (datetime.now() - last_update).days
            print(f"   申万分类最后更新: {last_update} ({days_ago}天前)")
            
            if days_ago <= 1:
                print("   ✅ 数据新鲜度良好")
            elif days_ago <= 7:
                print("   ⚠️ 数据稍有延迟")
            else:
                print("   ❌ 数据严重延迟")
        
        # 4. 检查数据完整性
        print("\n4. 数据完整性检查:")
        
        # 检查空值
        result = db_manager.execute_query(
            "SELECT COUNT(*) FROM shenwan_industry_classification WHERE sw_name IS NULL OR sw_name = ''"
        )
        null_names = result[0][0] if result else 0
        
        result = db_manager.execute_query(
            "SELECT COUNT(*) FROM shenwan_industry_classification WHERE sw_code IS NULL OR sw_code = ''"
        )
        null_codes = result[0][0] if result else 0
        
        print(f"   缺失行业名称: {null_names} 条")
        print(f"   缺失行业代码: {null_codes} 条")
        
        if null_names == 0 and null_codes == 0:
            print("   ✅ 数据完整性检查通过")
        else:
            print("   ❌ 数据完整性存在问题")
        
        # 5. 检查申万行业层级结构
        print("\n5. 申万行业层级结构检查:")
        result = db_manager.execute_query("""
            SELECT 
                l1.sw_name as '一级行业',
                COUNT(l2.sw_code) as '二级行业数量',
                COUNT(l3.sw_code) as '三级行业数量'
            FROM shenwan_industry_classification l1
            LEFT JOIN shenwan_industry_classification l2 ON l2.parent_code = l1.sw_code AND l2.industry_level = 2
            LEFT JOIN shenwan_industry_classification l3 ON l3.parent_code = l2.sw_code AND l3.industry_level = 3
            WHERE l1.industry_level = 1
            GROUP BY l1.sw_code, l1.sw_name
            ORDER BY l1.sw_name
            LIMIT 5
        """)
        
        for row in result:
            print(f"   {row[0]}: {row[1]}个二级行业, {row[2]}个三级行业")
        
        print("\n" + "=" * 50)
        print("验证完成")
        
    finally:
        db_manager.disconnect()

if __name__ == "__main__":
    validate_industry_data()
```

### 第八步：定时任务配置（预计时间：20分钟）

#### 8.1 创建调度器
```python
# 创建文件：scheduler.py
import schedule
import time
import logging
from datetime import datetime
from industry_data_collector import IndustryDataCollector

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def run_weekly_collection():
    """执行周度行业数据采集"""
    logger.info("开始执行周度行业数据采集任务...")
    
    try:
        # 替换为您的实际Tushare token
        tushare_token = "your_tushare_token_here"
        collector = IndustryDataCollector(tushare_token)
        
        success = collector.run_collection()
        if success:
            logger.info("周度行业数据采集任务执行成功")
        else:
            logger.error("周度行业数据采集任务执行失败")
    except Exception as e:
        logger.error(f"周度任务执行异常: {e}")

def run_daily_board_update():
    """执行日度板块数据更新"""
    logger.info("开始执行日度板块数据更新...")
    
    try:
        collector = IndustryDataCollector()
        
        # 只更新板块数据
        ths_data = collector.collect_ths_industry_boards()
        if ths_data:
            collector.save_ths_boards(ths_data)
            logger.info("日度板块数据更新成功")
        else:
            logger.error("日度板块数据更新失败")
    except Exception as e:
        logger.error(f"日度任务执行异常: {e}")

def main():
    """主调度程序"""
    # 配置定时任务
    schedule.every().sunday.at("08:00").do(run_weekly_collection)  # 每周日8点执行
    schedule.every().day.at("16:00").do(run_daily_board_update)    # 每天16点执行
    
    logger.info("行业数据采集调度器启动...")
    logger.info("定时任务安排:")
    logger.info("- 每周日 08:00 执行完整行业数据采集")
    logger.info("- 每天 16:00 执行板块数据更新")
    
    while True:
        schedule.run_pending()
        time.sleep(60)  # 每分钟检查一次

if __name__ == "__main__":
    main()
```

## 完整执行清单

### ✅ 快速启动清单（30分钟内完成）

1. **环境准备** (5分钟)
   ```bash
   cd "第一层模块/万得行业分类"
   python -m venv venv
   venv\Scripts\activate
   pip install tushare akshare pandas requests mysql-connector-python
   ```

2. **Tushare配置** (5分钟)
   - 注册账号：https://tushare.pro
   - 获取token并配置到config.py

3. **测试数据源** (10分钟)
   ```bash
   python test_tushare.py
   python test_akshare_industry.py
   python test_eastmoney_industry.py
   ```

4. **数据库准备** (5分钟)
   ```bash
   cd "../../数据库配置"
   mysql -u root -p < industry_tables.sql
   ```

5. **数据采集** (5分钟)
   ```bash
   cd "../第一层模块/万得行业分类"
   python industry_data_collector.py
   ```

### 📋 完整部署清单

- [ ] 环境准备和依赖安装
- [ ] Tushare账号注册和token配置
- [ ] 数据源连接测试
- [ ] 数据库表结构创建
- [ ] 行业数据采集器开发
- [ ] 定时任务配置
- [ ] 数据验证和监控
- [ ] 维护脚本部署

### 🚨 注意事项

1. **Tushare限制**: 免费用户有调用次数限制，注意控制请求频率
2. **网络连接**: 确保能正常访问外网API
3. **数据质量**: 定期检查数据完整性和一致性
4. **存储空间**: 行业数据量较小，通常不超过100MB
5. **备份策略**: 定期备份行业分类基础数据

### 📞 故障排除

- **Tushare token错误**: 检查token是否正确，账号是否激活
- **数据源无法访问**: 检查网络连接，尝试更换数据源
- **数据库连接失败**: 检查MySQL服务和配置
- **数据质量问题**: 运行验证脚本，检查数据源状态

这个免费方案可以满足行业分类数据的基本需求，为整个风险框架提供可靠的行业分类基础数据。

