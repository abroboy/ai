import pymysql
import re

# æ•°æ®åº“é…ç½®
DB_CONFIG = {
    'host': 'localhost',
    'port': 3306,
    'user': 'root',
    'password': 'rr1234RR',
    'database': 'pt',
    'charset': 'utf8mb4'
}

def get_enhanced_industry_mapping():
    """å¢å¼ºçš„è¡Œä¸šæ˜ å°„è§„åˆ™"""
    return {
        # é“¶è¡Œé‡‘è
        'é“¶è¡Œ': 'BK0475',
        'ä¿é™©': 'BK0474', 
        'è¯åˆ¸': 'BK0473',
        'é‡‘è': 'BK0738',
        'ä¿¡æ‰˜': 'BK0738',
        'æŠ•èµ„': 'BK0738',
        'åŸºé‡‘': 'BK0738',
        
        # ç§‘æŠ€
        'ç§‘æŠ€': 'BK0737',
        'è½¯ä»¶': 'BK0737',
        'åŠå¯¼ä½“': 'BK1036',
        'èŠ¯ç‰‡': 'BK1036',
        'é€šè®¯': 'BK0448',
        'é€šä¿¡': 'BK0448',
        'ç”µå­': 'BK0459',
        'æ•°ç ': 'BK1037',
        'ç½‘ç»œ': 'BK0447',
        'äº’è”ç½‘': 'BK0447',
        'æ™ºèƒ½': 'BK0737',
        'æ•°æ®': 'BK0737',
        'ä¿¡æ¯': 'BK0737',
        'ç³»ç»Ÿ': 'BK0737',
        'å¹³å°': 'BK0447',
        'åœ¨çº¿': 'BK0447',
        'æ•°å­—': 'BK0737',
        'äº‘': 'BK0737',
        'AI': 'BK0737',
        'äººå·¥æ™ºèƒ½': 'BK0737',
        'åŒºå—é“¾': 'BK0737',
        'å…ƒå®‡å®™': 'BK0737',
        
        # æ±½è½¦
        'æ±½è½¦': 'BK1029',
        'è½¦': 'BK1029',
        'æ–°èƒ½æº': 'BK1033',
        'ç”µæ± ': 'BK1033',
        'å……ç”µ': 'BK1033',
        'ç”µåŠ¨': 'BK1033',
        
        # åœ°äº§
        'åœ°äº§': 'BK0451',
        'ç‰©ä¸š': 'BK1045',
        'å»ºè®¾': 'BK0425',
        'å»ºç­‘': 'BK0720',
        'æˆ¿åœ°äº§': 'BK0451',
        'ç½®ä¸š': 'BK0451',
        'å¼€å‘': 'BK0451',
        'æŠ•èµ„': 'BK0738',
        
        # åŒ»è¯
        'åŒ»è¯': 'BK0465',
        'åŒ»ç–—': 'BK0727',
        'è¯ä¸š': 'BK0465',
        'ç”Ÿç‰©': 'BK1044',
        'å¥åº·': 'BK0727',
        'åˆ¶è¯': 'BK0465',
        'å™¨æ¢°': 'BK1041',
        'è¯Šæ–­': 'BK0727',
        'åŸºå› ': 'BK1044',
        'ç–«è‹—': 'BK1044',
        'æŠ—ä½“': 'BK1044',
        'ç»†èƒ': 'BK1044',
        'è‚¿ç˜¤': 'BK0465',
        'ç™Œç—‡': 'BK0465',
        'åº·å¤': 'BK0727',
        'æŠ¤ç†': 'BK0727',
        'è¯Šæ‰€': 'BK0727',
        'åŒ»é™¢': 'BK0727',
        
        # æ¶ˆè´¹
        'é£Ÿå“': 'BK0438',
        'é¥®æ–™': 'BK0438',
        'æœè£…': 'BK0436',
        'é›¶å”®': 'BK0482',
        'å•†è´¸': 'BK0484',
        'ç™¾è´§': 'BK0482',
        'è¶…å¸‚': 'BK0482',
        'è´­ç‰©': 'BK0482',
        'è¿é”': 'BK0482',
        'å“ç‰Œ': 'BK0436',
        'æ—¶å°š': 'BK0436',
        'ç¾å¦†': 'BK1035',
        'ç¾å®¹': 'BK1035',
        'æŠ¤è‚¤': 'BK1035',
        'åŒ–å¦†å“': 'BK1035',
        'å¥¢ä¾ˆå“': 'BK0436',
        'ç å®': 'BK0734',
        'é»„é‡‘': 'BK0732',
        'é’»çŸ³': 'BK0734',
        'æ‰‹è¡¨': 'BK0436',
        'é…’': 'BK0438',
        'å•¤é…’': 'BK0438',
        'ç™½é…’': 'BK0438',
        'çº¢é…’': 'BK0438',
        'çƒŸè‰': 'BK0438',
        
        # èƒ½æº
        'çŸ³æ²¹': 'BK0464',
        'ç…¤ç‚­': 'BK0437',
        'ç”µåŠ›': 'BK0428',
        'èƒ½æº': 'BK1015',
        'ç‡ƒæ°”': 'BK1028',
        'æ–°èƒ½æº': 'BK1033',
        'å¤ªé˜³èƒ½': 'BK1031',
        'å…‰ä¼': 'BK1031',
        'é£ç”µ': 'BK1032',
        'æ ¸ç”µ': 'BK0428',
        'æ°´ç”µ': 'BK0428',
        'ç«ç”µ': 'BK0428',
        'å¤©ç„¶æ°”': 'BK1028',
        'æ¶²åŒ–æ°”': 'BK1028',
        'æ²¹æ°”': 'BK0464',
        'å‹˜æ¢': 'BK1017',
        'å¼€é‡‡': 'BK1017',
        'çŸ¿ä¸š': 'BK1017',
        'é‡‘å±': 'BK0478',
        'æœ‰è‰²é‡‘å±': 'BK0478',
        'é’¢é“': 'BK0479',
        'é“': 'BK0478',
        'é“œ': 'BK0478',
        'é”Œ': 'BK0478',
        'é•': 'BK0478',
        'é”‚': 'BK1015',
        'ç¨€åœŸ': 'BK1015',
        'å°é‡‘å±': 'BK1027',
        
        # åˆ¶é€ ä¸š
        'åˆ¶é€ ': 'BK0910',
        'æœºæ¢°': 'BK0739',
        'è®¾å¤‡': 'BK0545',
        'å·¥ç¨‹': 'BK0425',
        'ææ–™': 'BK1020',
        'åŒ–å·¥': 'BK0538',
        'åŒ–å­¦': 'BK0538',
        'å¡‘æ–™': 'BK0454',
        'æ©¡èƒ¶': 'BK1018',
        'ç»ç’ƒ': 'BK0546',
        'æ°´æ³¥': 'BK0424',
        'å»ºæ': 'BK0476',
        'è£…é¥°': 'BK0725',
        'è£…ä¿®': 'BK0725',
        'å®¶å…·': 'BK0440',
        'å®¶ç”µ': 'BK0456',
        'ç”µå™¨': 'BK0456',
        'ç©ºè°ƒ': 'BK0456',
        'å†°ç®±': 'BK0456',
        'æ´—è¡£æœº': 'BK0456',
        'ç”µè§†': 'BK0456',
        'æ‰‹æœº': 'BK1037',
        'ç”µè„‘': 'BK0735',
        'ç¬”è®°æœ¬': 'BK0735',
        'æœåŠ¡å™¨': 'BK0735',
        'èŠ¯ç‰‡': 'BK1036',
        'ç”µè·¯': 'BK0459',
        'å…ƒä»¶': 'BK0459',
        'å™¨ä»¶': 'BK0459',
        'ä¼ æ„Ÿå™¨': 'BK0458',
        'ä»ªå™¨': 'BK0458',
        'ä»ªè¡¨': 'BK0458',
        'è‡ªåŠ¨åŒ–': 'BK0545',
        'æœºå™¨äºº': 'BK0545',
        'å·¥ä¸š': 'BK0545',
        'æœºåºŠ': 'BK0545',
        'æ³µ': 'BK0545',
        'é˜€é—¨': 'BK0545',
        'è½´æ‰¿': 'BK0545',
        'é½¿è½®': 'BK0545',
        'ç”µæœº': 'BK1030',
        'å˜å‹å™¨': 'BK0457',
        'ç”µç¼†': 'BK0457',
        'ç”µçº¿': 'BK0457',
        'å¼€å…³': 'BK0457',
        'é…ç”µ': 'BK0457',
        'ç”µç½‘': 'BK0457',
        'ç”µæº': 'BK1034',
        'å……ç”µå™¨': 'BK1034',
        'é€†å˜å™¨': 'BK1034',
        
        # äº¤é€šè¿è¾“
        'èˆªç©º': 'BK0420',
        'æœºåœº': 'BK0420',
        'æ¸¯å£': 'BK0450',
        'ç‰©æµ': 'BK0422',
        'è¿è¾“': 'BK0450',
        'èˆ¹èˆ¶': 'BK0729',
        'èˆªè¿': 'BK0450',
        'æµ·è¿': 'BK0450',
        'é“è·¯': 'BK0421',
        'å…¬è·¯': 'BK0421',
        'é«˜é€Ÿ': 'BK0421',
        'åœ°é“': 'BK0421',
        'å…¬äº¤': 'BK0421',
        'å‡ºç§Ÿè½¦': 'BK0421',
        'å¿«é€’': 'BK0422',
        'ä»“å‚¨': 'BK0422',
        'é…é€': 'BK0422',
        'ä¾›åº”é“¾': 'BK0422',
        
        # å…¬ç”¨äº‹ä¸š
        'ç”µä¿¡': 'BK0736',
        'å…¬ç”¨': 'BK0427',
        'æ°´åŠ¡': 'BK0427',
        'ä¾›æ°´': 'BK0427',
        'æ’æ°´': 'BK0427',
        'æ±¡æ°´å¤„ç†': 'BK0728',
        'ç¯ä¿': 'BK0728',
        'åƒåœ¾': 'BK0728',
        'åºŸç‰©': 'BK0728',
        'å›æ”¶': 'BK0728',
        'èŠ‚èƒ½': 'BK0728',
        'å‡æ’': 'BK0728',
        'æ¸…æ´': 'BK0728',
        
        # ä¼ åª’å¨±ä¹
        'ä¼ åª’': 'BK0486',
        'æ–‡åŒ–': 'BK0486',
        'æ¸¸æˆ': 'BK1046',
        'å¨±ä¹': 'BK0485',
        'æ—…æ¸¸': 'BK0485',
        'é…’åº—': 'BK0485',
        'åº¦å‡': 'BK0485',
        'æ™¯åŒº': 'BK0485',
        'ä¸»é¢˜å…¬å›­': 'BK0485',
        'ç”µå½±': 'BK0486',
        'ç”µè§†': 'BK0486',
        'å¹¿æ’­': 'BK0486',
        'å‡ºç‰ˆ': 'BK0486',
        'æŠ¥çº¸': 'BK0486',
        'æ‚å¿—': 'BK0486',
        'å¹¿å‘Š': 'BK0486',
        'è¥é”€': 'BK0486',
        'å…¬å…³': 'BK0486',
        'ä¼šå±•': 'BK0486',
        'æ¼”å‡º': 'BK0486',
        'æ¼”å”±ä¼š': 'BK0486',
        'éŸ³ä¹ä¼š': 'BK0486',
        'å‰§é™¢': 'BK0486',
        'åšç‰©é¦†': 'BK0486',
        'å›¾ä¹¦é¦†': 'BK0486',
        'æ•™è‚²': 'BK0740',
        'åŸ¹è®­': 'BK0740',
        'å­¦æ ¡': 'BK0740',
        'å¤§å­¦': 'BK0740',
        'å­¦é™¢': 'BK0740',
        'åœ¨çº¿æ•™è‚²': 'BK0740',
        'èŒä¸šæ•™è‚²': 'BK0740',
        'è¯­è¨€': 'BK0740',
        'è€ƒè¯•': 'BK0740',
        
        # å†œä¸š
        'å†œä¸š': 'BK0433',
        'å†œç‰§': 'BK0433',
        'æ¸”ä¸š': 'BK0433',
        'å…»æ®–': 'BK0433',
        'ç§æ¤': 'BK0433',
        'ç•œç‰§': 'BK0433',
        'é¥²æ–™': 'BK0730',
        'å†œè¯': 'BK0730',
        'å…½è¯': 'BK0730',
        'åŒ–è‚¥': 'BK0731',
        'ç§å­': 'BK0433',
        'å†œäº§å“': 'BK0433',
        'ç²®é£Ÿ': 'BK0433',
        'è”¬èœ': 'BK0433',
        'æ°´æœ': 'BK0433',
        'è‚‰ç±»': 'BK0433',
        'ä¹³åˆ¶å“': 'BK0438',
        'æ°´äº§': 'BK0433',
        
        # å…¶ä»–
        'ç»¼åˆ': 'BK0539',
        'é›†å›¢': 'BK0539',
        'æ§è‚¡': 'BK0539',
        'è‚¡ä»½': 'BK0539',
        'æœ‰é™': 'BK0539',
        'å›½é™…': 'BK0539',
        'ä¸­å›½': 'BK0539',
        'é¦™æ¸¯': 'BK0539',
        'äºšæ´²': 'BK0539',
        'å…¨çƒ': 'BK0539',
        'ä¸–ç•Œ': 'BK0539',
        'ä¼ä¸š': 'BK0539',
        'å…¬å¸': 'BK0539',
        'å®ä¸š': 'BK0539',
        'å·¥ä¸š': 'BK0545',
        'å•†ä¸š': 'BK0482',
        'è´¸æ˜“': 'BK0484',
        'è¿›å‡ºå£': 'BK0484',
        'ä»£ç†': 'BK0484',
        'ç»é”€': 'BK0484',
        'æ‰¹å‘': 'BK0484',
        'é›¶å”®': 'BK0482',
        'æœåŠ¡': 'BK1043',
        'å’¨è¯¢': 'BK1043',
        'æ³•å¾‹': 'BK1043',
        'ä¼šè®¡': 'BK1043',
        'å®¡è®¡': 'BK1043',
        'è¯„ä¼°': 'BK1043',
        'è®¤è¯': 'BK1043',
        'æ£€æµ‹': 'BK1043',
        'æ£€éªŒ': 'BK1043',
        'è®¤è¯': 'BK1043',
        'æ ‡å‡†': 'BK1043',
        'è´¨é‡': 'BK1043',
        'å®‰å…¨': 'BK1043',
        'ä¿é™©': 'BK0474',
        'å†ä¿é™©': 'BK0474',
        'å¯¿é™©': 'BK0474',
        'è´¢é™©': 'BK0474',
        'å¥åº·é™©': 'BK0474',
        'æ„å¤–é™©': 'BK0474',
        'è½¦é™©': 'BK0474',
        'æˆ¿å±‹é™©': 'BK0474',
    }

def get_industry_names():
    """è¡Œä¸šä»£ç å¯¹åº”çš„ä¸­æ–‡åç§°"""
    return {
        'BK0475': 'é“¶è¡Œ',
        'BK0474': 'ä¿é™©',
        'BK0473': 'è¯åˆ¸',
        'BK0738': 'å¤šå…ƒé‡‘è',
        'BK0737': 'è½¯ä»¶å¼€å‘',
        'BK1036': 'åŠå¯¼ä½“',
        'BK0448': 'é€šä¿¡è®¾å¤‡',
        'BK0459': 'ç”µå­å…ƒä»¶',
        'BK1037': 'æ¶ˆè´¹ç”µå­',
        'BK0447': 'äº’è”ç½‘æœåŠ¡',
        'BK1029': 'æ±½è½¦æ•´è½¦',
        'BK1033': 'ç”µæ± ',
        'BK0451': 'æˆ¿åœ°äº§å¼€å‘',
        'BK1045': 'æˆ¿åœ°äº§æœåŠ¡',
        'BK0425': 'å·¥ç¨‹å»ºè®¾',
        'BK0720': 'å»ºç­‘è£…é¥°',
        'BK0465': 'åŒ–å­¦åˆ¶è¯',
        'BK0727': 'åŒ»ç–—æœåŠ¡',
        'BK1044': 'ç”Ÿç‰©åˆ¶å“',
        'BK1041': 'åŒ»ç–—å™¨æ¢°',
        'BK0438': 'é£Ÿå“é¥®æ–™',
        'BK0436': 'çººç»‡æœè£…',
        'BK0482': 'å•†ä¸šç™¾è´§',
        'BK0484': 'è´¸æ˜“è¡Œä¸š',
        'BK1035': 'ç¾å®¹æŠ¤ç†',
        'BK0734': 'ç å®é¦–é¥°',
        'BK0732': 'è´µé‡‘å±',
        'BK0464': 'çŸ³æ²¹è¡Œä¸š',
        'BK0437': 'ç…¤ç‚­è¡Œä¸š',
        'BK0428': 'ç”µåŠ›è¡Œä¸š',
        'BK1015': 'èƒ½æºé‡‘å±',
        'BK1028': 'ç‡ƒæ°”',
        'BK1031': 'å…‰ä¼è®¾å¤‡',
        'BK1032': 'é£ç”µè®¾å¤‡',
        'BK1017': 'é‡‡æ˜è¡Œä¸š',
        'BK0478': 'æœ‰è‰²é‡‘å±',
        'BK0479': 'é’¢é“è¡Œä¸š',
        'BK1027': 'å°é‡‘å±',
        'BK0910': 'ä¸“ç”¨è®¾å¤‡',
        'BK0739': 'å·¥ç¨‹æœºæ¢°',
        'BK0545': 'é€šç”¨è®¾å¤‡',
        'BK1020': 'éé‡‘å±ææ–™',
        'BK0538': 'åŒ–å­¦åˆ¶å“',
        'BK0454': 'å¡‘æ–™åˆ¶å“',
        'BK1018': 'æ©¡èƒ¶åˆ¶å“',
        'BK0546': 'ç»ç’ƒç»çº¤',
        'BK0424': 'æ°´æ³¥å»ºæ',
        'BK0476': 'è£…ä¿®å»ºæ',
        'BK0725': 'è£…ä¿®è£…é¥°',
        'BK0440': 'å®¶ç”¨è½»å·¥',
        'BK0456': 'å®¶ç”µè¡Œä¸š',
        'BK0735': 'è®¡ç®—æœºè®¾å¤‡',
        'BK0458': 'ä»ªå™¨ä»ªè¡¨',
        'BK1030': 'ç”µæœº',
        'BK0457': 'ç”µç½‘è®¾å¤‡',
        'BK1034': 'ç”µæºè®¾å¤‡',
        'BK0420': 'èˆªç©ºæœºåœº',
        'BK0450': 'èˆªè¿æ¸¯å£',
        'BK0422': 'ç‰©æµè¡Œä¸š',
        'BK0729': 'èˆ¹èˆ¶åˆ¶é€ ',
        'BK0421': 'é“è·¯å…¬è·¯',
        'BK0736': 'é€šä¿¡æœåŠ¡',
        'BK0427': 'å…¬ç”¨äº‹ä¸š',
        'BK0728': 'ç¯ä¿è¡Œä¸š',
        'BK0486': 'æ–‡åŒ–ä¼ åª’',
        'BK1046': 'æ¸¸æˆ',
        'BK0485': 'æ—…æ¸¸é…’åº—',
        'BK0740': 'æ•™è‚²',
        'BK0433': 'å†œç‰§é¥²æ¸”',
        'BK0730': 'å†œè¯å…½è¯',
        'BK0731': 'åŒ–è‚¥è¡Œä¸š',
        'BK0539': 'ç»¼åˆè¡Œä¸š',
        'BK1043': 'ä¸“ä¸šæœåŠ¡',
    }

def map_hk_industries_enhanced():
    """ä¸ºæ¸¯è‚¡æ˜ å°„è¡Œä¸š - å¢å¼ºç‰ˆ"""
    try:
        connection = pymysql.connect(**DB_CONFIG)
        cursor = connection.cursor()
        
        # è·å–æœªæ˜ å°„çš„æ¸¯è‚¡åˆ—è¡¨
        cursor.execute("SELECT stock_code, stock_name FROM stock_industry_mapping WHERE LENGTH(stock_code) = 5 AND (industry_name = '' OR industry_name IS NULL)")
        unmapped_hk_stocks = cursor.fetchall()
        
        print(f"æ‰¾åˆ° {len(unmapped_hk_stocks)} åªæœªæ˜ å°„çš„æ¸¯è‚¡")
        
        industry_mapping = get_enhanced_industry_mapping()
        industry_names = get_industry_names()
        
        mapped_count = 0
        
        for stock_code, stock_name in unmapped_hk_stocks:
            matched_industry = None
            matched_keyword = None
            
            # éå†æ‰€æœ‰å…³é”®è¯ï¼Œå¯»æ‰¾åŒ¹é…
            for keyword, industry_code in industry_mapping.items():
                if keyword in stock_name:
                    matched_industry = industry_code
                    matched_keyword = keyword
                    break
            
            if matched_industry:
                industry_name = industry_names.get(matched_industry, 'æœªçŸ¥è¡Œä¸š')
                
                # æ›´æ–°æ•°æ®åº“
                sql = """
                UPDATE stock_industry_mapping 
                SET industry_code = %s, industry_name = %s, mapping_status = 'auto_mapped', confidence = 0.8
                WHERE stock_code = %s
                """
                cursor.execute(sql, (matched_industry, industry_name, stock_code))
                mapped_count += 1
                
                print(f"âœ… {stock_code} {stock_name} -> {industry_name} (å…³é”®è¯: {matched_keyword})")
        
        connection.commit()
        
        # ç»Ÿè®¡ç»“æœ
        cursor.execute("SELECT COUNT(*) FROM stock_industry_mapping WHERE LENGTH(stock_code) = 5 AND industry_name != ''")
        hk_mapped = cursor.fetchone()[0]
        
        cursor.execute("SELECT COUNT(*) FROM stock_industry_mapping WHERE LENGTH(stock_code) = 5")
        hk_total = cursor.fetchone()[0]
        
        print(f"\nğŸ“Š æ¸¯è‚¡è¡Œä¸šæ˜ å°„ç»“æœ:")
        print(f"   - æ€»æ¸¯è‚¡æ•°: {hk_total}")
        print(f"   - å·²æ˜ å°„: {hk_mapped}")
        print(f"   - æœ¬æ¬¡æ–°å¢æ˜ å°„: {mapped_count}")
        print(f"   - æ˜ å°„ç‡: {hk_mapped/hk_total*100:.1f}%")
        
        # æ˜¾ç¤ºæ¸¯è‚¡è¡Œä¸šåˆ†å¸ƒ
        cursor.execute("""
            SELECT industry_name, COUNT(*) as count 
            FROM stock_industry_mapping 
            WHERE LENGTH(stock_code) = 5 AND industry_name != '' 
            GROUP BY industry_name 
            ORDER BY count DESC 
            LIMIT 15
        """)
        industries = cursor.fetchall()
        
        if industries:
            print(f"\nğŸ­ æ¸¯è‚¡è¡Œä¸šåˆ†å¸ƒTOP15:")
            for industry, count in industries:
                print(f"   {industry}: {count}åªè‚¡ç¥¨")
        
        cursor.close()
        connection.close()
        
        return True
        
    except Exception as e:
        print(f"âŒ æ˜ å°„å¤±è´¥: {e}")
        return False

def main():
    """ä¸»å‡½æ•°"""
    print("=" * 60)
    print("ğŸ‡­ğŸ‡° å¼€å§‹ä¸ºæ¸¯è‚¡è¡¥å……è¡Œä¸šåˆ†ç±» - å¢å¼ºç‰ˆ")
    print("=" * 60)
    
    if map_hk_industries_enhanced():
        print("\n" + "=" * 60)
        print("âœ… æ¸¯è‚¡è¡Œä¸šåˆ†ç±»è¡¥å……å®Œæˆï¼")
        print("ğŸŒ è®¿é—® http://127.0.0.1:5001 æŸ¥çœ‹æ•°æ®")
        print("=" * 60)
    else:
        print("âŒ æ¸¯è‚¡è¡Œä¸šåˆ†ç±»è¡¥å……å¤±è´¥ï¼")

if __name__ == "__main__":
    main() 