# å…¬å¸åå­—åˆ—è¡¨æ¨¡å— - å…è´¹æ•°æ®æºå®æ–½æŒ‡å—

## å…è´¹æ•°æ®æºæ–¹æ¡ˆ

### ğŸ¯ æ¨èå…è´¹ç»„åˆæ–¹æ¡ˆ
```
ä¸»æ•°æ®æº: AKShareï¼ˆå®Œå…¨å…è´¹ï¼Œæ— éœ€æ³¨å†Œï¼‰
è¡¥å……æ•°æ®æº: ä¸œæ–¹è´¢å¯Œç½‘APIï¼ˆå…è´¹ï¼Œæ— éœ€æ³¨å†Œï¼‰
éªŒè¯æ•°æ®æº: æ–°æµªè´¢ç»APIï¼ˆå…è´¹ï¼Œæ— éœ€æ³¨å†Œï¼‰
å¤‡ç”¨æ•°æ®æº: Tushareå…è´¹ç‰ˆï¼ˆéœ€æ³¨å†Œï¼Œä½†å…è´¹ï¼‰
```

### æ•°æ®æºç‰¹ç‚¹å¯¹æ¯”

| æ•°æ®æº | æ³¨å†Œè¦æ±‚ | è°ƒç”¨é™åˆ¶ | æ•°æ®å®Œæ•´æ€§ | ç¨³å®šæ€§ | æ¨èæŒ‡æ•° |
|--------|----------|----------|------------|---------|----------|
| AKShare | æ— éœ€æ³¨å†Œ | æ— æ˜ç¡®é™åˆ¶ | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| ä¸œæ–¹è´¢å¯Œ | æ— éœ€æ³¨å†Œ | ~60æ¬¡/åˆ†é’Ÿ | â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| æ–°æµªè´¢ç» | æ— éœ€æ³¨å†Œ | ~60æ¬¡/åˆ†é’Ÿ | â­â­â­ | â­â­ | â­â­â­ |
| Tushareå…è´¹ç‰ˆ | éœ€æ³¨å†Œ | 200æ¬¡/åˆ†é’Ÿ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |

## è¯¦ç»†æ‰§è¡Œæ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ï¼ˆé¢„è®¡æ—¶é—´ï¼š30åˆ†é’Ÿï¼‰

#### 1.1 åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ
```bash
# åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
cd "ç¬¬ä¸€å±‚æ¨¡å—/å…¬å¸åå­—åˆ—è¡¨"

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆWindowsï¼‰
venv\Scripts\activate

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆLinux/Macï¼‰
source venv/bin/activate
```

#### 1.2 å®‰è£…å¿…è¦çš„ä¾èµ–åŒ…
```bash
# å®‰è£…æ ¸å¿ƒä¾èµ–
pip install akshare pandas requests mysql-connector-python schedule

# æˆ–è€…ä½¿ç”¨å®Œæ•´çš„requirementsæ–‡ä»¶
pip install -r requirements.txt
```

#### 1.3 éªŒè¯ç¯å¢ƒå®‰è£…
```bash
python -c "import akshare as ak; print('AKShareç‰ˆæœ¬:', ak.__version__)"
python -c "import pandas as pd; print('Pandasç‰ˆæœ¬:', pd.__version__)"
python -c "import requests; print('Requestså®‰è£…æˆåŠŸ')"
```

### ç¬¬äºŒæ­¥ï¼šæ•°æ®æºæµ‹è¯•ï¼ˆé¢„è®¡æ—¶é—´ï¼š30åˆ†é’Ÿï¼‰

#### 2.1 æµ‹è¯•AKShareè¿æ¥
```python
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼štest_data_sources.py
import akshare as ak
import pandas as pd

def test_akshare():
    """æµ‹è¯•AKShareæ•°æ®è·å–"""
    try:
        print("æ­£åœ¨æµ‹è¯•AKShare...")
        # è·å–Aè‚¡å®æ—¶è¡Œæƒ…ï¼ˆåªå–å‰10æ¡æµ‹è¯•ï¼‰
        df = ak.stock_zh_a_spot_em()
        print(f"AKShareæµ‹è¯•æˆåŠŸï¼Œè·å–åˆ° {len(df)} æ¡è‚¡ç¥¨æ•°æ®")
        print("å‰5æ¡æ•°æ®:")
        print(df.head())
        return True
    except Exception as e:
        print(f"AKShareæµ‹è¯•å¤±è´¥: {e}")
        return False

if __name__ == "__main__":
    test_akshare()
```

#### 2.2 æµ‹è¯•ä¸œæ–¹è´¢å¯ŒAPI
```python
import requests
import json

def test_eastmoney():
    """æµ‹è¯•ä¸œæ–¹è´¢å¯ŒAPI"""
    url = "http://80.push2.eastmoney.com/api/qt/clist/get"
    params = {
        'pn': 1,
        'pz': 20,  # åªè·å–20æ¡æµ‹è¯•
        'po': 1,
        'np': 1,
        'ut': 'bd1d9ddb04089700cf9c27f6f7426281',
        'fltt': 2,
        'invt': 2,
        'fid': 'f3',
        'fs': 'm:0+t:6,m:0+t:80,m:1+t:2,m:1+t:23',
        'fields': 'f12,f14,f2,f3,f62,f184'
    }
    
    try:
        print("æ­£åœ¨æµ‹è¯•ä¸œæ–¹è´¢å¯ŒAPI...")
        response = requests.get(url, params=params, timeout=10)
        data = response.json()
        if data.get('rc') == 0 and data.get('data'):
            stocks = data['data']['diff']
            print(f"ä¸œæ–¹è´¢å¯ŒAPIæµ‹è¯•æˆåŠŸï¼Œè·å–åˆ° {len(stocks)} æ¡è‚¡ç¥¨æ•°æ®")
            for stock in stocks[:3]:  # æ˜¾ç¤ºå‰3æ¡
                print(f"  {stock['f12']}: {stock['f14']}")
            return True
        else:
            print("ä¸œæ–¹è´¢å¯ŒAPIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸")
            return False
    except Exception as e:
        print(f"ä¸œæ–¹è´¢å¯ŒAPIæµ‹è¯•å¤±è´¥: {e}")
        return False

# è¿è¡Œæµ‹è¯•
test_eastmoney()
```

#### 2.3 æµ‹è¯•æ–°æµªè´¢ç»API
```python
import requests

def test_sina():
    """æµ‹è¯•æ–°æµªè´¢ç»API"""
    try:
        print("æ­£åœ¨æµ‹è¯•æ–°æµªè´¢ç»API...")
        # è·å–æ²ªæ·±Aè‚¡åˆ—è¡¨
        url = "http://vip.stock.finance.sina.com.cn/quotes_service/api/json_v2.php/Market_Center.getHQNodeData"
        params = {
            'page': 1,
            'num': 20,
            'sort': 'symbol',
            'asc': 1,
            'node': 'hs_a'
        }
        
        response = requests.get(url, params=params, timeout=10)
        data = response.json()
        
        if isinstance(data, list) and len(data) > 0:
            print(f"æ–°æµªè´¢ç»APIæµ‹è¯•æˆåŠŸï¼Œè·å–åˆ° {len(data)} æ¡è‚¡ç¥¨æ•°æ®")
            for stock in data[:3]:  # æ˜¾ç¤ºå‰3æ¡
                print(f"  {stock.get('symbol')}: {stock.get('name')}")
            return True
        else:
            print("æ–°æµªè´¢ç»APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸")
            return False
    except Exception as e:
        print(f"æ–°æµªè´¢ç»APIæµ‹è¯•å¤±è´¥: {e}")
        return False

# è¿è¡Œæµ‹è¯•
test_sina()
```

### ç¬¬ä¸‰æ­¥ï¼šæ•°æ®åº“å‡†å¤‡ï¼ˆé¢„è®¡æ—¶é—´ï¼š15åˆ†é’Ÿï¼‰

#### 3.1 ç¡®ä¿MySQLè¿è¡Œ
```bash
# æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€ï¼ˆWindowsï¼‰
net start mysql

# è¿æ¥æµ‹è¯•
mysql -u root -p
```

#### 3.2 åˆ›å»ºæ•°æ®åº“å’Œè¡¨
```bash
# è¿è¡Œæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
cd "../../æ•°æ®åº“é…ç½®"
python init_tables.py
```

#### 3.3 éªŒè¯æ•°æ®åº“è¿æ¥
```python
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼štest_database.py
import sys
import os
sys.path.append('../../æ•°æ®åº“é…ç½®')

from database_config import get_database_manager

def test_database():
    """æµ‹è¯•æ•°æ®åº“è¿æ¥"""
    db_manager = get_database_manager()
    
    if db_manager.create_database():
        print("æ•°æ®åº“åˆ›å»ºæˆåŠŸ")
        
        if db_manager.connect():
            print("æ•°æ®åº“è¿æ¥æˆåŠŸ")
            
            # æµ‹è¯•æŸ¥è¯¢
            result = db_manager.execute_query("SHOW TABLES")
            print(f"æ•°æ®åº“ä¸­çš„è¡¨: {result}")
            
            db_manager.disconnect()
            return True
        else:
            print("æ•°æ®åº“è¿æ¥å¤±è´¥")
            return False
    else:
        print("æ•°æ®åº“åˆ›å»ºå¤±è´¥")
        return False

if __name__ == "__main__":
    test_database()
```

### ç¬¬å››æ­¥ï¼šæ•°æ®é‡‡é›†å®ç°ï¼ˆé¢„è®¡æ—¶é—´ï¼š2å°æ—¶ï¼‰

#### 4.1 åˆ›å»ºæ•°æ®é‡‡é›†å™¨
```python
# åˆ›å»ºæ–‡ä»¶ï¼šcompany_collector.py
import akshare as ak
import requests
import pandas as pd
import time
import logging
from datetime import datetime
import sys
import os

# æ·»åŠ é…ç½®è·¯å¾„
sys.path.append('.')
sys.path.append('../../æ•°æ®åº“é…ç½®')

from config import *
from database_config import get_database_manager

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('company_collector.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

class CompanyDataCollector:
    """å…¬å¸æ•°æ®é‡‡é›†å™¨"""
    
    def __init__(self):
        self.db_manager = get_database_manager()
        self.collected_data = []
        
    def collect_from_akshare(self):
        """ä»AKShareé‡‡é›†æ•°æ®"""
        try:
            logger.info("å¼€å§‹ä»AKShareé‡‡é›†æ•°æ®...")
            df = ak.stock_zh_a_spot_em()
            
            # æ•°æ®æ¸…æ´—å’Œæ ¼å¼åŒ–
            processed_data = []
            for _, row in df.iterrows():
                company_data = {
                    'stock_code': row['ä»£ç '],
                    'company_name': row['åç§°'],
                    'market': 'SZ' if row['ä»£ç '].startswith(('000', '002', '300')) else 'SH',
                    'market_cap': row.get('æ€»å¸‚å€¼', 0),
                    'float_market_cap': row.get('æµé€šå¸‚å€¼', 0),
                    'data_source': 'akshare',
                    'data_date': datetime.now().date()
                }
                processed_data.append(company_data)
            
            logger.info(f"AKShareé‡‡é›†å®Œæˆï¼Œè·å– {len(processed_data)} æ¡æ•°æ®")
            return processed_data
            
        except Exception as e:
            logger.error(f"AKShareæ•°æ®é‡‡é›†å¤±è´¥: {e}")
            return []
    
    def collect_from_eastmoney(self):
        """ä»ä¸œæ–¹è´¢å¯Œé‡‡é›†æ•°æ®"""
        try:
            logger.info("å¼€å§‹ä»ä¸œæ–¹è´¢å¯Œé‡‡é›†æ•°æ®...")
            url = "http://80.push2.eastmoney.com/api/qt/clist/get"
            params = {
                'pn': 1,
                'pz': 5000,
                'po': 1,
                'np': 1,
                'ut': 'bd1d9ddb04089700cf9c27f6f7426281',
                'fltt': 2,
                'invt': 2,
                'fid': 'f3',
                'fs': 'm:0+t:6,m:0+t:80,m:1+t:2,m:1+t:23',
                'fields': 'f12,f14,f2,f3,f62,f184,f116,f117'
            }
            
            response = requests.get(url, params=params, timeout=30)
            data = response.json()
            
            if data.get('rc') == 0 and data.get('data'):
                processed_data = []
                for stock in data['data']['diff']:
                    company_data = {
                        'stock_code': stock['f12'],
                        'company_name': stock['f14'],
                        'market': 'SZ' if stock['f12'].startswith(('000', '002', '300')) else 'SH',
                        'current_price': stock.get('f2', 0),
                        'change_percent': stock.get('f3', 0),
                        'data_source': 'eastmoney',
                        'data_date': datetime.now().date()
                    }
                    processed_data.append(company_data)
                
                logger.info(f"ä¸œæ–¹è´¢å¯Œé‡‡é›†å®Œæˆï¼Œè·å– {len(processed_data)} æ¡æ•°æ®")
                return processed_data
            else:
                logger.error("ä¸œæ–¹è´¢å¯ŒAPIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸")
                return []
                
        except Exception as e:
            logger.error(f"ä¸œæ–¹è´¢å¯Œæ•°æ®é‡‡é›†å¤±è´¥: {e}")
            return []
    
    def merge_data(self, akshare_data, eastmoney_data):
        """åˆå¹¶å¤šæºæ•°æ®"""
        logger.info("å¼€å§‹åˆå¹¶å¤šæºæ•°æ®...")
        
        # ä»¥AKShareä¸ºä¸»ï¼Œä¸œæ–¹è´¢å¯Œä¸ºè¡¥å……
        merged_data = {}
        
        # å…ˆå¤„ç†AKShareæ•°æ®
        for item in akshare_data:
            code = item['stock_code']
            merged_data[code] = item
        
        # è¡¥å……ä¸œæ–¹è´¢å¯Œæ•°æ®
        for item in eastmoney_data:
            code = item['stock_code']
            if code in merged_data:
                # è¡¥å……ä»·æ ¼ä¿¡æ¯
                merged_data[code]['current_price'] = item.get('current_price', 0)
                merged_data[code]['change_percent'] = item.get('change_percent', 0)
            else:
                # æ–°å¢æ•°æ®
                merged_data[code] = item
        
        result = list(merged_data.values())
        logger.info(f"æ•°æ®åˆå¹¶å®Œæˆï¼Œæ€»è®¡ {len(result)} æ¡æ•°æ®")
        return result
    
    def save_to_database(self, data):
        """ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“"""
        if not data:
            logger.warning("æ²¡æœ‰æ•°æ®éœ€è¦ä¿å­˜")
            return False
        
        try:
            if not self.db_manager.connect():
                logger.error("æ•°æ®åº“è¿æ¥å¤±è´¥")
                return False
            
            # æ‰¹é‡æ’å…¥æ•°æ®
            success_count = 0
            for item in data:
                # æ„å»ºæ’å…¥SQL
                sql = """
                INSERT INTO company_list 
                (company_name, stock_code, market, market_cap, current_price, 
                 change_percent, data_source, data_date, created_at, updated_at)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s, NOW(), NOW())
                ON DUPLICATE KEY UPDATE
                company_name = VALUES(company_name),
                market_cap = VALUES(market_cap),
                current_price = VALUES(current_price),
                change_percent = VALUES(change_percent),
                data_source = VALUES(data_source),
                data_date = VALUES(data_date),
                updated_at = NOW()
                """
                
                params = (
                    item['company_name'],
                    item['stock_code'],
                    item['market'],
                    item.get('market_cap', 0),
                    item.get('current_price', 0),
                    item.get('change_percent', 0),
                    item['data_source'],
                    item['data_date']
                )
                
                if self.db_manager.execute_update(sql, params):
                    success_count += 1
            
            logger.info(f"æ•°æ®ä¿å­˜å®Œæˆï¼ŒæˆåŠŸä¿å­˜ {success_count} æ¡æ•°æ®")
            return True
            
        except Exception as e:
            logger.error(f"æ•°æ®ä¿å­˜å¤±è´¥: {e}")
            return False
        finally:
            self.db_manager.disconnect()
    
    def run_collection(self):
        """æ‰§è¡Œå®Œæ•´çš„æ•°æ®é‡‡é›†æµç¨‹"""
        logger.info("å¼€å§‹æ‰§è¡Œæ•°æ®é‡‡é›†ä»»åŠ¡...")
        start_time = time.time()
        
        # é‡‡é›†æ•°æ®
        akshare_data = self.collect_from_akshare()
        time.sleep(2)  # é¿å…è¯·æ±‚è¿‡å¿«
        
        eastmoney_data = self.collect_from_eastmoney()
        
        # åˆå¹¶æ•°æ®
        merged_data = self.merge_data(akshare_data, eastmoney_data)
        
        # ä¿å­˜æ•°æ®
        if self.save_to_database(merged_data):
            elapsed_time = time.time() - start_time
            logger.info(f"æ•°æ®é‡‡é›†ä»»åŠ¡å®Œæˆï¼Œè€—æ—¶ {elapsed_time:.2f} ç§’")
            return True
        else:
            logger.error("æ•°æ®é‡‡é›†ä»»åŠ¡å¤±è´¥")
            return False

def main():
    """ä¸»å‡½æ•°"""
    collector = CompanyDataCollector()
    collector.run_collection()

if __name__ == "__main__":
    main()
```

### ç¬¬äº”æ­¥ï¼šå®šæ—¶ä»»åŠ¡é…ç½®ï¼ˆé¢„è®¡æ—¶é—´ï¼š30åˆ†é’Ÿï¼‰

#### 5.1 åˆ›å»ºè°ƒåº¦å™¨
```python
# åˆ›å»ºæ–‡ä»¶ï¼šscheduler.py
import schedule
import time
import logging
from datetime import datetime
from company_collector import CompanyDataCollector

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def run_daily_collection():
    """æ‰§è¡Œæ—¥å¸¸æ•°æ®é‡‡é›†"""
    logger.info("å¼€å§‹æ‰§è¡Œå®šæ—¶æ•°æ®é‡‡é›†ä»»åŠ¡...")
    collector = CompanyDataCollector()
    
    try:
        success = collector.run_collection()
        if success:
            logger.info("å®šæ—¶æ•°æ®é‡‡é›†ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ")
        else:
            logger.error("å®šæ—¶æ•°æ®é‡‡é›†ä»»åŠ¡æ‰§è¡Œå¤±è´¥")
    except Exception as e:
        logger.error(f"å®šæ—¶ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸: {e}")

def main():
    """ä¸»è°ƒåº¦ç¨‹åº"""
    # é…ç½®å®šæ—¶ä»»åŠ¡
    schedule.every().day.at("09:00").do(run_daily_collection)  # æ¯å¤©9ç‚¹æ‰§è¡Œ
    schedule.every().day.at("15:30").do(run_daily_collection)  # æ¯å¤©15:30æ‰§è¡Œ
    
    logger.info("è°ƒåº¦å™¨å¯åŠ¨ï¼Œç­‰å¾…æ‰§è¡Œå®šæ—¶ä»»åŠ¡...")
    logger.info("å®šæ—¶ä»»åŠ¡å®‰æ’:")
    logger.info("- æ¯å¤© 09:00 æ‰§è¡Œæ•°æ®é‡‡é›†")
    logger.info("- æ¯å¤© 15:30 æ‰§è¡Œæ•°æ®é‡‡é›†")
    
    while True:
        schedule.run_pending()
        time.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

if __name__ == "__main__":
    main()
```

### ç¬¬å…­æ­¥ï¼šæµ‹è¯•å’ŒéªŒè¯ï¼ˆé¢„è®¡æ—¶é—´ï¼š30åˆ†é’Ÿï¼‰

#### 6.1 å•å…ƒæµ‹è¯•
```bash
# æµ‹è¯•æ•°æ®é‡‡é›†
python company_collector.py

# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
type company_collector.log
```

#### 6.2 æ•°æ®éªŒè¯
```python
# åˆ›å»ºéªŒè¯è„šæœ¬ï¼švalidate_data.py
import sys
sys.path.append('../../æ•°æ®åº“é…ç½®')
from database_config import get_database_manager

def validate_collected_data():
    """éªŒè¯é‡‡é›†çš„æ•°æ®"""
    db_manager = get_database_manager()
    
    if not db_manager.connect():
        print("æ•°æ®åº“è¿æ¥å¤±è´¥")
        return
    
    try:
        # æ£€æŸ¥æ•°æ®æ€»æ•°
        result = db_manager.execute_query("SELECT COUNT(*) FROM company_list")
        total_count = result[0][0] if result else 0
        print(f"æ•°æ®åº“ä¸­æ€»è®¡ {total_count} æ¡å…¬å¸æ•°æ®")
        
        # æ£€æŸ¥ä»Šæ—¥æ•°æ®
        result = db_manager.execute_query(
            "SELECT COUNT(*) FROM company_list WHERE data_date = CURDATE()"
        )
        today_count = result[0][0] if result else 0
        print(f"ä»Šæ—¥æ–°å¢ {today_count} æ¡æ•°æ®")
        
        # æ£€æŸ¥å¸‚åœºåˆ†å¸ƒ
        result = db_manager.execute_query(
            "SELECT market, COUNT(*) FROM company_list GROUP BY market"
        )
        print("å¸‚åœºåˆ†å¸ƒ:")
        for row in result:
            print(f"  {row[0]}: {row[1]} å®¶å…¬å¸")
        
        # æ£€æŸ¥æ•°æ®æºåˆ†å¸ƒ
        result = db_manager.execute_query(
            "SELECT data_source, COUNT(*) FROM company_list GROUP BY data_source"
        )
        print("æ•°æ®æºåˆ†å¸ƒ:")
        for row in result:
            print(f"  {row[0]}: {row[1]} æ¡æ•°æ®")
        
        # æ£€æŸ¥æ•°æ®è´¨é‡
        result = db_manager.execute_query(
            "SELECT COUNT(*) FROM company_list WHERE company_name IS NULL OR company_name = ''"
        )
        null_name_count = result[0][0] if result else 0
        
        result = db_manager.execute_query(
            "SELECT COUNT(*) FROM company_list WHERE stock_code IS NULL OR stock_code = ''"
        )
        null_code_count = result[0][0] if result else 0
        
        print(f"æ•°æ®è´¨é‡æ£€æŸ¥:")
        print(f"  ç¼ºå¤±å…¬å¸åç§°: {null_name_count} æ¡")
        print(f"  ç¼ºå¤±è‚¡ç¥¨ä»£ç : {null_code_count} æ¡")
        
        if null_name_count == 0 and null_code_count == 0:
            print("âœ… æ•°æ®è´¨é‡æ£€æŸ¥é€šè¿‡")
        else:
            print("âŒ æ•°æ®è´¨é‡å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦æ£€æŸ¥")
            
    finally:
        db_manager.disconnect()

if __name__ == "__main__":
    validate_collected_data()
```

### ç¬¬ä¸ƒæ­¥ï¼šç›‘æ§å’Œç»´æŠ¤ï¼ˆé¢„è®¡æ—¶é—´ï¼š1å°æ—¶ï¼‰

#### 7.1 åˆ›å»ºç›‘æ§è„šæœ¬
```python
# åˆ›å»ºæ–‡ä»¶ï¼šmonitor.py
import sys
import time
from datetime import datetime, timedelta
sys.path.append('../../æ•°æ®åº“é…ç½®')
from database_config import get_database_manager

class DataMonitor:
    """æ•°æ®ç›‘æ§å™¨"""
    
    def __init__(self):
        self.db_manager = get_database_manager()
    
    def check_data_freshness(self):
        """æ£€æŸ¥æ•°æ®æ–°é²œåº¦"""
        if not self.db_manager.connect():
            return False
        
        try:
            # æ£€æŸ¥æœ€æ–°æ•°æ®æ—¶é—´
            result = self.db_manager.execute_query(
                "SELECT MAX(data_date) FROM company_list"
            )
            
            if result and result[0][0]:
                latest_date = result[0][0]
                today = datetime.now().date()
                
                if latest_date == today:
                    print("âœ… æ•°æ®æ˜¯æœ€æ–°çš„")
                    return True
                elif latest_date == today - timedelta(days=1):
                    print("âš ï¸ æ•°æ®å»¶è¿Ÿ1å¤©")
                    return True
                else:
                    print(f"âŒ æ•°æ®ä¸¥é‡å»¶è¿Ÿï¼Œæœ€æ–°æ•°æ®æ—¥æœŸ: {latest_date}")
                    return False
            else:
                print("âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ•°æ®")
                return False
                
        finally:
            self.db_manager.disconnect()
    
    def check_data_completeness(self):
        """æ£€æŸ¥æ•°æ®å®Œæ•´æ€§"""
        if not self.db_manager.connect():
            return False
        
        try:
            # æ£€æŸ¥Aè‚¡æ•°é‡æ˜¯å¦æ­£å¸¸ï¼ˆå¤§çº¦4000-5000å®¶ï¼‰
            result = self.db_manager.execute_query(
                "SELECT COUNT(*) FROM company_list WHERE status = 'active'"
            )
            
            count = result[0][0] if result else 0
            
            if count > 4000:
                print(f"âœ… æ•°æ®å®Œæ•´æ€§æ­£å¸¸ï¼Œå…± {count} å®¶å…¬å¸")
                return True
            elif count > 3000:
                print(f"âš ï¸ æ•°æ®å¯èƒ½ä¸å®Œæ•´ï¼Œå…± {count} å®¶å…¬å¸")
                return True
            else:
                print(f"âŒ æ•°æ®æ˜æ˜¾ä¸å®Œæ•´ï¼Œä»… {count} å®¶å…¬å¸")
                return False
                
        finally:
            self.db_manager.disconnect()
    
    def run_health_check(self):
        """è¿è¡Œå¥åº·æ£€æŸ¥"""
        print(f"å¼€å§‹æ•°æ®å¥åº·æ£€æŸ¥ - {datetime.now()}")
        
        freshness_ok = self.check_data_freshness()
        completeness_ok = self.check_data_completeness()
        
        if freshness_ok and completeness_ok:
            print("âœ… ç³»ç»Ÿå¥åº·çŠ¶æ€è‰¯å¥½")
            return True
        else:
            print("âŒ ç³»ç»Ÿå­˜åœ¨é—®é¢˜ï¼Œéœ€è¦äººå·¥ä»‹å…¥")
            return False

def main():
    """ä¸»ç›‘æ§ç¨‹åº"""
    monitor = DataMonitor()
    
    while True:
        try:
            monitor.run_health_check()
            print("-" * 50)
            time.sleep(3600)  # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
        except KeyboardInterrupt:
            print("ç›‘æ§ç¨‹åºåœæ­¢")
            break
        except Exception as e:
            print(f"ç›‘æ§ç¨‹åºå¼‚å¸¸: {e}")
            time.sleep(300)  # å¼‚å¸¸æ—¶5åˆ†é’Ÿåé‡è¯•

if __name__ == "__main__":
    main()
```

#### 7.2 åˆ›å»ºç»´æŠ¤è„šæœ¬
```python
# åˆ›å»ºæ–‡ä»¶ï¼šmaintenance.py
import sys
sys.path.append('../../æ•°æ®åº“é…ç½®')
from database_config import get_database_manager

def cleanup_old_data():
    """æ¸…ç†è€æ—§æ•°æ®"""
    db_manager = get_database_manager()
    
    if not db_manager.connect():
        return False
    
    try:
        # åˆ é™¤30å¤©å‰çš„æ•°æ®
        sql = "DELETE FROM company_list WHERE data_date < DATE_SUB(CURDATE(), INTERVAL 30 DAY)"
        
        if db_manager.execute_update(sql):
            print("âœ… è€æ—§æ•°æ®æ¸…ç†å®Œæˆ")
            return True
        else:
            print("âŒ è€æ—§æ•°æ®æ¸…ç†å¤±è´¥")
            return False
            
    finally:
        db_manager.disconnect()

def optimize_database():
    """ä¼˜åŒ–æ•°æ®åº“"""
    db_manager = get_database_manager()
    
    if not db_manager.connect():
        return False
    
    try:
        # ä¼˜åŒ–è¡¨
        sql = "OPTIMIZE TABLE company_list"
        
        if db_manager.execute_update(sql):
            print("âœ… æ•°æ®åº“ä¼˜åŒ–å®Œæˆ")
            return True
        else:
            print("âŒ æ•°æ®åº“ä¼˜åŒ–å¤±è´¥")
            return False
            
    finally:
        db_manager.disconnect()

if __name__ == "__main__":
    print("å¼€å§‹æ•°æ®åº“ç»´æŠ¤...")
    cleanup_old_data()
    optimize_database()
    print("æ•°æ®åº“ç»´æŠ¤å®Œæˆ")
```

## å®Œæ•´æ‰§è¡Œæ¸…å•

### âœ… å¿«é€Ÿå¯åŠ¨æ¸…å•ï¼ˆ30åˆ†é’Ÿå†…å®Œæˆï¼‰

1. **ç¯å¢ƒå‡†å¤‡** (5åˆ†é’Ÿ)
   ```bash
   cd "ç¬¬ä¸€å±‚æ¨¡å—/å…¬å¸åå­—åˆ—è¡¨"
   python -m venv venv
   venv\Scripts\activate
   pip install akshare pandas requests mysql-connector-python schedule
   ```

2. **æµ‹è¯•æ•°æ®æº** (10åˆ†é’Ÿ)
   ```bash
   python -c "import akshare as ak; print(ak.stock_zh_a_spot_em().head())"
   ```

3. **æ•°æ®åº“å‡†å¤‡** (5åˆ†é’Ÿ)
   ```bash
   cd "../../æ•°æ®åº“é…ç½®"
   python init_tables.py
   ```

4. **æ•°æ®é‡‡é›†** (5åˆ†é’Ÿ)
   ```bash
   cd "../ç¬¬ä¸€å±‚æ¨¡å—/å…¬å¸åå­—åˆ—è¡¨"
   python company_collector.py
   ```

5. **éªŒè¯ç»“æœ** (5åˆ†é’Ÿ)
   ```bash
   python validate_data.py
   ```

### ğŸ“‹ å®Œæ•´éƒ¨ç½²æ¸…å•

- [ ] ç¯å¢ƒå‡†å¤‡å’Œä¾èµ–å®‰è£…
- [ ] æ•°æ®æºè¿æ¥æµ‹è¯•
- [ ] æ•°æ®åº“åˆå§‹åŒ–
- [ ] æ•°æ®é‡‡é›†å™¨å¼€å‘
- [ ] å®šæ—¶ä»»åŠ¡é…ç½®
- [ ] æ•°æ®éªŒè¯å’Œç›‘æ§
- [ ] ç»´æŠ¤è„šæœ¬éƒ¨ç½²

### ğŸš¨ æ³¨æ„äº‹é¡¹

1. **ç½‘ç»œè¿æ¥**: ç¡®ä¿èƒ½æ­£å¸¸è®¿é—®å¤–ç½‘API
2. **è¯·æ±‚é¢‘ç‡**: é¿å…è¯·æ±‚è¿‡äºé¢‘ç¹è¢«é™åˆ¶
3. **æ•°æ®è´¨é‡**: å®šæœŸæ£€æŸ¥æ•°æ®å®Œæ•´æ€§
4. **é”™è¯¯å¤„ç†**: å…³æ³¨æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯
5. **å¤‡ä»½ç­–ç•¥**: å®šæœŸå¤‡ä»½é‡è¦æ•°æ®

### ğŸ“ æ•…éšœæ’é™¤

- **æ•°æ®æºæ— æ³•è®¿é—®**: æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œå°è¯•æ›´æ¢æ•°æ®æº
- **æ•°æ®åº“è¿æ¥å¤±è´¥**: æ£€æŸ¥MySQLæœåŠ¡å’Œé…ç½®
- **æ•°æ®è´¨é‡é—®é¢˜**: è¿è¡ŒéªŒè¯è„šæœ¬ï¼Œæ£€æŸ¥æ•°æ®æºçŠ¶æ€
- **æ€§èƒ½é—®é¢˜**: è°ƒæ•´æ‰¹é‡å¤§å°å’Œå¹¶å‘æ•°é‡

è¿™ä¸ªå…è´¹æ–¹æ¡ˆå¯ä»¥æ»¡è¶³åŸºæœ¬çš„æ•°æ®é‡‡é›†éœ€æ±‚ï¼Œåç»­å¯ä»¥æ ¹æ®ä¸šåŠ¡å‘å±•æƒ…å†µè€ƒè™‘å‡çº§åˆ°ä»˜è´¹æ•°æ®æºã€‚

