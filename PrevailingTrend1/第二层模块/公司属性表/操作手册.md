# 公司属性表模块 - 操作手册

## 模块概述
公司属性表模块负责整合和管理上市公司的各项基本属性信息，包括基础信息、财务指标、治理结构、业务特征等多维度数据。该模块作为数据整合层，将第一层模块的原始数据进行清洗、标准化和结构化处理，为后续分析提供统一的公司数据视图。

## 数据来源依赖

### 第一层模块数据输入
- **公司名字列表**: 公司基础信息、股票代码
- **万得行业分类**: 行业归属、分类标准
- **其他互联网信息**: 市场关注度、舆情数据
- **国内热点数据**: 国内政策影响、热点关联
- **国外热点数据**: 国际事件影响
- **腾讯济安指数**: 量化指标数据
- **雪球等论坛热点数据**: 投资者情绪数据

### 外部数据补充
- **交易所公告**: 重大事项、业务变更
- **监管数据**: 违规处罚、监管措施
- **评级数据**: 信用评级、投资评级
- **专业数据库**: Wind、Bloomberg等高质量数据

## 数据字段设计

### 核心标识字段
- **company_id**: 公司唯一标识符
- **stock_code**: 股票代码
- **company_name**: 公司全称
- **short_name**: 股票简称
- **unified_code**: 统一社会信用代码
- **listing_date**: 上市日期

### 基本属性字段
- **market**: 交易市场（主板/中小板/创业板/科创板/北交所）
- **industry_wind**: 万得行业分类
- **industry_shenwan**: 申万行业分类
- **industry_csrc**: 证监会行业分类
- **province**: 注册省份
- **city**: 注册城市
- **registered_capital**: 注册资本
- **total_shares**: 总股本
- **float_shares**: 流通股本

### 财务属性字段
- **market_cap**: 总市值
- **float_market_cap**: 流通市值
- **pe_ratio**: 市盈率
- **pb_ratio**: 市净率
- **ps_ratio**: 市销率
- **roe**: 净资产收益率
- **roa**: 总资产收益率
- **debt_ratio**: 资产负债率
- **current_ratio**: 流动比率
- **quick_ratio**: 速动比率

### 治理结构字段
- **actual_controller**: 实际控制人
- **controlling_shareholder**: 控股股东
- **ownership_nature**: 企业性质（国有/民营/外资等）
- **chairman**: 董事长
- **ceo**: 总经理
- **secretary**: 董事会秘书
- **independent_directors**: 独立董事数量
- **board_size**: 董事会规模

### 业务特征字段
- **main_business**: 主营业务
- **business_scope**: 经营范围
- **revenue_structure**: 收入结构
- **geographic_distribution**: 地域分布
- **customer_concentration**: 客户集中度
- **supplier_concentration**: 供应商集中度
- **research_expense_ratio**: 研发费用占比
- **patent_count**: 专利数量

### 市场表现字段
- **price_volatility**: 价格波动率
- **trading_volume**: 日均成交量
- **turnover_rate**: 换手率
- **beta**: Beta系数
- **correlation_index**: 与指数相关性
- **momentum_score**: 动量因子得分
- **value_score**: 价值因子得分
- **quality_score**: 质量因子得分

### 风险特征字段
- **business_risk**: 经营风险等级
- **financial_risk**: 财务风险等级
- **liquidity_risk**: 流动性风险等级
- **governance_risk**: 治理风险等级
- **compliance_risk**: 合规风险等级
- **overall_risk**: 综合风险评级

### 关注度字段
- **analyst_coverage**: 分析师覆盖数量
- **institutional_holding**: 机构持股比例
- **media_attention**: 媒体关注度
- **investor_sentiment**: 投资者情绪
- **search_popularity**: 搜索热度
- **social_mentions**: 社交媒体提及次数

## 数据处理流程

### 1. 数据收集阶段
```python
def collect_company_attributes():
    """收集公司属性数据"""
    # 从第一层模块获取基础数据
    basic_info = get_company_basic_info()
    industry_info = get_industry_classification()
    market_data = get_market_performance()
    sentiment_data = get_sentiment_analysis()
    
    # 整合数据
    company_attributes = merge_company_data(
        basic_info, industry_info, market_data, sentiment_data
    )
    
    return company_attributes
```

### 2. 数据清洗阶段
```python
def clean_company_data(raw_data):
    """清洗公司数据"""
    cleaned_data = {}
    
    for company_id, data in raw_data.items():
        # 数据标准化
        cleaned_data[company_id] = {
            'company_name': standardize_company_name(data['name']),
            'stock_code': standardize_stock_code(data['code']),
            'industry': map_industry_classification(data['industry']),
            'financial_ratios': calculate_financial_ratios(data['financial']),
            'risk_scores': calculate_risk_scores(data)
        }
    
    return cleaned_data
```

### 3. 数据验证阶段
```python
def validate_company_attributes(company_data):
    """验证公司属性数据"""
    validation_rules = {
        'stock_code': validate_stock_code_format,
        'market_cap': validate_positive_number,
        'pe_ratio': validate_reasonable_range,
        'debt_ratio': validate_percentage_range
    }
    
    validation_results = {}
    for company_id, data in company_data.items():
        results = []
        for field, validator in validation_rules.items():
            if not validator(data.get(field)):
                results.append(f"Invalid {field}")
        validation_results[company_id] = results
    
    return validation_results
```

### 4. 数据存储阶段
```python
def save_company_attributes(company_data):
    """保存公司属性数据"""
    for company_id, attributes in company_data.items():
        sql = """
        INSERT INTO company_attributes 
        (company_id, stock_code, company_name, market, industry_wind, 
         market_cap, pe_ratio, roe, debt_ratio, risk_score, updated_at)
        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, NOW())
        ON DUPLICATE KEY UPDATE
        market_cap = VALUES(market_cap),
        pe_ratio = VALUES(pe_ratio),
        roe = VALUES(roe),
        debt_ratio = VALUES(debt_ratio),
        risk_score = VALUES(risk_score),
        updated_at = NOW()
        """
        
        execute_sql(sql, prepare_data_tuple(attributes))
```

## 技术实现方案

### 1. 推荐技术栈
- **Python 3.8+**: 主要开发语言
- **pandas**: 数据处理和分析
- **numpy**: 数值计算
- **scikit-learn**: 机器学习算法
- **mysql-connector-python**: 数据库连接
- **redis**: 缓存和临时存储
- **celery**: 异步任务处理
- **schedule**: 定时任务调度

### 2. 核心模块设计
- **数据收集器**: 从各第一层模块获取数据
- **数据清洗器**: 数据标准化和质量控制
- **属性计算器**: 计算衍生指标和评分
- **风险评估器**: 综合风险评级计算
- **数据存储器**: 结构化数据持久化
- **监控器**: 数据质量和系统监控

### 3. 数据更新策略
- **实时更新**: 股价、市值等实时数据
- **日级更新**: 交易数据、技术指标
- **周级更新**: 财务比率、风险评分
- **月级更新**: 治理结构、业务特征
- **季度更新**: 财务数据、行业分类

## 质量控制机制

### 1. 数据完整性检查
```python
def check_data_completeness(company_data):
    """检查数据完整性"""
    required_fields = [
        'company_name', 'stock_code', 'market', 
        'industry_wind', 'market_cap', 'listing_date'
    ]
    
    completeness_report = {}
    for company_id, data in company_data.items():
        missing_fields = []
        for field in required_fields:
            if not data.get(field):
                missing_fields.append(field)
        
        completeness_report[company_id] = {
            'complete': len(missing_fields) == 0,
            'missing_fields': missing_fields,
            'completeness_ratio': 1 - len(missing_fields) / len(required_fields)
        }
    
    return completeness_report
```

### 2. 数据一致性验证
```python
def validate_data_consistency(company_data):
    """验证数据一致性"""
    consistency_issues = []
    
    for company_id, data in company_data.items():
        # 检查市值与股价、股本的一致性
        if data.get('market_cap') and data.get('price') and data.get('total_shares'):
            calculated_cap = data['price'] * data['total_shares']
            if abs(data['market_cap'] - calculated_cap) / data['market_cap'] > 0.05:
                consistency_issues.append({
                    'company_id': company_id,
                    'issue': 'market_cap_inconsistent',
                    'expected': calculated_cap,
                    'actual': data['market_cap']
                })
    
    return consistency_issues
```

### 3. 异常值检测
```python
def detect_outliers(company_data, field):
    """检测异常值"""
    values = [data.get(field, 0) for data in company_data.values()]
    q1, q3 = np.percentile(values, [25, 75])
    iqr = q3 - q1
    lower_bound = q1 - 1.5 * iqr
    upper_bound = q3 + 1.5 * iqr
    
    outliers = []
    for company_id, data in company_data.items():
        value = data.get(field, 0)
        if value < lower_bound or value > upper_bound:
            outliers.append({
                'company_id': company_id,
                'field': field,
                'value': value,
                'lower_bound': lower_bound,
                'upper_bound': upper_bound
            })
    
    return outliers
```

## API接口设计

### 1. 查询接口
```python
# 获取公司属性
GET /api/company/{stock_code}/attributes
GET /api/company/attributes?market=SH&industry=计算机

# 批量查询
POST /api/company/attributes/batch
{
    "stock_codes": ["000001", "000002"],
    "fields": ["market_cap", "pe_ratio", "roe"]
}

# 筛选查询
GET /api/company/screen?market_cap_min=100&pe_ratio_max=20&roe_min=0.1
```

### 2. 统计接口
```python
# 行业统计
GET /api/industry/{industry_code}/stats
GET /api/market/{market}/distribution

# 风险分析
GET /api/risk/analysis?stock_codes=000001,000002
GET /api/risk/ranking?industry=计算机&order=desc
```

## 实施计划

### 第一阶段：基础框架（2-3天）
1. 设计数据库表结构
2. 建立数据收集框架
3. 实现基础数据清洗功能
4. 完成核心属性字段处理

### 第二阶段：属性计算（3-4天）
1. 实现财务指标计算
2. 开发风险评分算法
3. 建立治理结构分析
4. 完善市场表现计算

### 第三阶段：质量控制（2-3天）
1. 实现数据验证机制
2. 建立异常检测系统
3. 完善数据一致性检查
4. 优化数据更新流程

### 第四阶段：服务接口（1-2天）
1. 开发RESTful API接口
2. 实现数据查询和筛选
3. 建立监控和报警
4. 完成性能优化

## 成功指标
- 数据覆盖率 > 95%（全市场上市公司）
- 数据完整性 > 90%（核心属性字段）
- 数据准确率 > 98%
- 数据更新及时性 < 2小时
- 系统查询响应时间 < 1秒
- 系统稳定性 > 99.5%

## 维护和监控

### 定期维护任务
- **每日**: 检查数据更新状态，监控系统性能
- **每周**: 验证数据质量，更新计算模型
- **每月**: 评估属性完整性，优化数据结构
- **每季度**: 审查指标有效性，调整评分算法

### 预警机制
- 数据更新延迟超过4小时
- 数据质量指标低于阈值
- 系统响应时间异常
- 异常值检测触发

该模块为整个风险框架提供标准化、高质量的公司属性数据，确保后续分析的准确性和可靠性。
