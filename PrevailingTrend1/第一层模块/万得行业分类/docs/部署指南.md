# 万得行业分类模块 - 部署指南

## 部署概述

本指南详细说明如何在不同环境中部署万得行业分类模块，包括开发环境、测试环境和生产环境。

## 环境要求

### 系统要求
- **操作系统**: Linux (推荐 Ubuntu 18.04+), Windows 10+, macOS 10.14+
- **Python版本**: Python 3.8+
- **内存**: 最少 2GB RAM
- **磁盘空间**: 最少 1GB 可用空间
- **网络**: 需要访问数据库和外部数据源

### 软件依赖
- **数据库**: MySQL 5.7+ 或 MariaDB 10.2+
- **Python包**: 见 requirements.txt
- **可选**: Redis (用于缓存)

## 部署步骤

### 1. 环境准备

#### 1.1 安装Python环境
```bash
# 下载并安装Python 3.8+
# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate     # Windows
```

#### 1.2 安装依赖包
```bash
# 升级pip
pip install --upgrade pip

# 安装依赖
pip install -r requirements.txt
```

#### 1.3 配置数据库
```sql
-- 创建数据库
CREATE DATABASE prevailing_trend CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户
CREATE USER 'industry_user'@'%' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON prevailing_trend.* TO 'industry_user'@'%';
FLUSH PRIVILEGES;
```

### 2. 配置文件设置

#### 2.1 创建环境配置文件
```bash
# 复制配置文件模板
cp .env.example .env

# 编辑配置文件
vim .env
```

#### 2.2 配置文件内容
```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=prevailing_trend
DB_USER=industry_user
DB_PASSWORD=your_password

# 万得Wind配置 (可选)
WIND_USERNAME=your_wind_username
WIND_PASSWORD=your_wind_password
WIND_SERVER=10.0.0.1
WIND_PORT=17011

# Tushare配置 (可选)
TUSHARE_TOKEN=your_tushare_token

# 日志配置
LOG_LEVEL=INFO
LOG_FILE_PATH=logs/industry_classification.log

# API配置
API_HOST=0.0.0.0
API_PORT=5000
API_DEBUG=false
```

### 3. 初始化部署

#### 3.1 初始化数据库
```bash
# 初始化数据库表结构
python main.py --action init
```

#### 3.2 首次数据更新
```bash
# 更新行业分类数据
python main.py --action update
```

#### 3.3 验证部署
```bash
# 查看统计信息
python main.py --action stats

# 查询数据
python main.py --action query --level 1
```

### 4. API服务部署

#### 4.1 启动API服务
```bash
# 启动组合API服务
python api_server.py --service combined --port 5000

# 或分别启动
python api_server.py --service industry --port 5000
python api_server.py --service stock --port 5001
```

#### 4.2 使用Gunicorn部署 (生产环境)
```bash
# 安装Gunicorn
pip install gunicorn

# 启动服务
gunicorn -w 4 -b 0.0.0.0:5000 api_server:app
```

#### 4.3 使用Docker部署
```dockerfile
# Dockerfile
FROM python:3.8-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

EXPOSE 5000

CMD ["python", "api_server.py", "--service", "combined"]
```

```bash
# 构建镜像
docker build -t industry-classification .

# 运行容器
docker run -d -p 5000:5000 --name industry-api industry-classification
```

### 5. 生产环境部署

#### 5.1 使用Nginx反向代理
```nginx
# nginx.conf
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

#### 5.2 使用Systemd服务管理
```ini
# /etc/systemd/system/industry-classification.service
[Unit]
Description=Industry Classification API
After=network.target

[Service]
Type=simple
User=industry
WorkingDirectory=/opt/industry-classification
Environment=PATH=/opt/industry-classification/venv/bin
ExecStart=/opt/industry-classification/venv/bin/python api_server.py
Restart=always

[Install]
WantedBy=multi-user.target
```

```bash
# 启动服务
sudo systemctl enable industry-classification
sudo systemctl start industry-classification
sudo systemctl status industry-classification
```

#### 5.3 使用Supervisor管理进程
```ini
# /etc/supervisor/conf.d/industry-classification.conf
[program:industry-classification]
command=/opt/industry-classification/venv/bin/python api_server.py
directory=/opt/industry-classification
user=industry
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/industry-classification.log
```

### 6. 监控和日志

#### 6.1 日志配置
```bash
# 创建日志目录
mkdir -p logs

# 设置日志权限
chmod 755 logs
chown industry:industry logs
```

#### 6.2 监控脚本
```bash
#!/bin/bash
# monitor.sh

# 检查API服务状态
curl -f http://localhost:5000/health > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "API服务异常，重启服务..."
    sudo systemctl restart industry-classification
fi

# 检查数据库连接
python -c "
import sys
sys.path.append('/opt/industry-classification')
from utils.database import db_manager
try:
    db_manager.connect()
    print('数据库连接正常')
except Exception as e:
    print(f'数据库连接异常: {e}')
    sys.exit(1)
"
```

#### 6.3 定时任务
```bash
# 添加到crontab
# 每小时检查服务状态
0 * * * * /opt/industry-classification/monitor.sh

# 每天凌晨2点更新数据
0 2 * * * cd /opt/industry-classification && python main.py --action update
```

### 7. 安全配置

#### 7.1 防火墙设置
```bash
# 只允许必要端口
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
```

#### 7.2 SSL证书配置
```bash
# 使用Let's Encrypt
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

#### 7.3 数据库安全
```sql
-- 限制数据库访问
GRANT SELECT, INSERT, UPDATE, DELETE ON prevailing_trend.* TO 'industry_user'@'localhost';
REVOKE ALL PRIVILEGES ON *.* FROM 'industry_user'@'%';
```

### 8. 备份和恢复

#### 8.1 数据库备份
```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/industry-classification"

mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u industry_user -p prevailing_trend > $BACKUP_DIR/db_backup_$DATE.sql

# 备份配置文件
cp .env $BACKUP_DIR/config_backup_$DATE.env

# 压缩备份文件
tar -czf $BACKUP_DIR/backup_$DATE.tar.gz $BACKUP_DIR/db_backup_$DATE.sql $BACKUP_DIR/config_backup_$DATE.env

# 删除30天前的备份
find $BACKUP_DIR -name "backup_*.tar.gz" -mtime +30 -delete
```

#### 8.2 数据恢复
```bash
# 恢复数据库
mysql -u industry_user -p prevailing_trend < backup_20231201_120000.sql

# 恢复配置
cp config_backup_20231201_120000.env .env
```

### 9. 性能优化

#### 9.1 数据库优化
```sql
-- 添加索引
ALTER TABLE wind_industry_classification ADD INDEX idx_industry_level (industry_level);
ALTER TABLE stock_industry_mapping ADD INDEX idx_confidence (confidence);

-- 优化查询
ANALYZE TABLE wind_industry_classification;
ANALYZE TABLE stock_industry_mapping;
```

#### 9.2 缓存配置
```python
# 使用Redis缓存
import redis

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def get_cached_industries(level):
    cache_key = f"industries_level_{level}"
    cached_data = redis_client.get(cache_key)
    if cached_data:
        return json.loads(cached_data)
    
    # 从数据库获取数据
    data = get_industries_from_db(level)
    
    # 缓存数据（1小时）
    redis_client.setex(cache_key, 3600, json.dumps(data))
    return data
```

### 10. 故障排除

#### 10.1 常见问题

**问题1: 数据库连接失败**
```bash
# 检查数据库服务状态
sudo systemctl status mysql

# 检查连接配置
python -c "from utils.database import db_manager; db_manager.connect()"
```

**问题2: API服务无法启动**
```bash
# 检查端口占用
netstat -tlnp | grep 5000

# 检查日志
tail -f logs/industry_classification_$(date +%Y%m%d).log
```

**问题3: 数据更新失败**
```bash
# 检查数据源配置
python -c "from config import config; print(config.tushare.token)"

# 手动测试数据采集
python -c "from core.data_collector import DataCollector; dc = DataCollector(); print(dc.get_primary_industry_data())"
```

#### 10.2 性能监控
```bash
# 监控系统资源
htop
iotop
nethogs

# 监控API性能
ab -n 1000 -c 10 http://localhost:5000/industry/api/industries
```

## 总结

通过以上部署指南，您可以成功在不同环境中部署万得行业分类模块。建议在生产环境中：

1. 使用Docker容器化部署
2. 配置Nginx反向代理
3. 启用SSL证书
4. 设置监控和告警
5. 定期备份数据
6. 优化性能配置

这样可以确保系统的稳定性、安全性和可维护性。 