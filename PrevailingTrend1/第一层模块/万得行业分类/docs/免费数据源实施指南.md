# ä¸‡å¾—è¡Œä¸šåˆ†ç±»æ¨¡å— - å…è´¹æ•°æ®æºå®æ–½æŒ‡å—

## å…è´¹æ•°æ®æºæ–¹æ¡ˆ

### ğŸ¯ æ¨èå…è´¹ç»„åˆæ–¹æ¡ˆ
```
ä¸»æ•°æ®æº: Tushareï¼ˆéœ€æ³¨å†Œï¼ŒåŸºç¡€åŠŸèƒ½å…è´¹ï¼‰
è¡¥å……æ•°æ®æº: AKShareï¼ˆå®Œå…¨å…è´¹ï¼Œæ— éœ€æ³¨å†Œï¼‰
éªŒè¯æ•°æ®æº: ä¸œæ–¹è´¢å¯Œç½‘APIï¼ˆå…è´¹ï¼Œæ— éœ€æ³¨å†Œï¼‰
æ¦‚å¿µæ•°æ®æº: åŒèŠ±é¡ºAPIï¼ˆå…è´¹ï¼Œæ— éœ€æ³¨å†Œï¼‰
```

### æ•°æ®æºç‰¹ç‚¹å¯¹æ¯”

| æ•°æ®æº | æ³¨å†Œè¦æ±‚ | è°ƒç”¨é™åˆ¶ | è¡Œä¸šå±‚çº§ | æ•°æ®å®Œæ•´æ€§ | æ¨èæŒ‡æ•° |
|--------|----------|----------|----------|------------|----------|
| Tushare | éœ€æ³¨å†Œ | 200æ¬¡/åˆ†é’Ÿ | 3çº§å®Œæ•´ | â­â­â­â­â­ | â­â­â­â­â­ |
| AKShare | æ— éœ€æ³¨å†Œ | æ— æ˜ç¡®é™åˆ¶ | 2çº§ | â­â­â­â­ | â­â­â­â­ |
| ä¸œæ–¹è´¢å¯Œ | æ— éœ€æ³¨å†Œ | ~60æ¬¡/åˆ†é’Ÿ | 2çº§ | â­â­â­ | â­â­â­ |
| åŒèŠ±é¡º | æ— éœ€æ³¨å†Œ | ~30æ¬¡/åˆ†é’Ÿ | æ¦‚å¿µæ¿å— | â­â­â­ | â­â­â­ |

## è¯¦ç»†æ‰§è¡Œæ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ï¼ˆé¢„è®¡æ—¶é—´ï¼š30åˆ†é’Ÿï¼‰

#### 1.1 åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ
```bash
# åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
cd "ç¬¬ä¸€å±‚æ¨¡å—/ä¸‡å¾—è¡Œä¸šåˆ†ç±»"

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆWindowsï¼‰
venv\Scripts\activate

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆLinux/Macï¼‰
source venv/bin/activate
```

#### 1.2 å®‰è£…å¿…è¦çš„ä¾èµ–åŒ…
```bash
# å®‰è£…æ ¸å¿ƒä¾èµ–
pip install tushare akshare pandas requests mysql-connector-python schedule

# æˆ–è€…ä½¿ç”¨requirementsæ–‡ä»¶
pip install -r requirements.txt
```

#### 1.3 éªŒè¯ç¯å¢ƒå®‰è£…
```bash
python -c "import tushare as ts; print('Tushareç‰ˆæœ¬:', ts.__version__)"
python -c "import akshare as ak; print('AKShareç‰ˆæœ¬:', ak.__version__)"
python -c "import pandas as pd; print('Pandasç‰ˆæœ¬:', pd.__version__)"
python -c "import requests; print('Requestså®‰è£…æˆåŠŸ')"
```

### ç¬¬äºŒæ­¥ï¼šTushareé…ç½®ï¼ˆé¢„è®¡æ—¶é—´ï¼š15åˆ†é’Ÿï¼‰

#### 2.1 æ³¨å†ŒTushareè´¦å·
1. è®¿é—® https://tushare.pro
2. æ³¨å†Œè´¦å·å¹¶å®Œæˆé‚®ç®±éªŒè¯
3. åœ¨ç”¨æˆ·ä¸­å¿ƒè·å–API Token

#### 2.2 æµ‹è¯•Tushareè¿æ¥
```python
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼štest_tushare.py
import tushare as ts

# è®¾ç½®tokenï¼ˆæ›¿æ¢ä¸ºæ‚¨çš„å®é™…tokenï¼‰
ts.set_token('your_tushare_token_here')
pro = ts.pro_api()

def test_tushare_industry():
    """æµ‹è¯•Tushareè¡Œä¸šåˆ†ç±»è·å–"""
    try:
        print("æ­£åœ¨æµ‹è¯•Tushareè¡Œä¸šåˆ†ç±»...")
        
        # è·å–ç”³ä¸‡ä¸€çº§è¡Œä¸šåˆ†ç±»
        df = pro.index_classify(level='L1', src='SW2021')
        print(f"ç”³ä¸‡ä¸€çº§è¡Œä¸šæ•°é‡: {len(df)}")
        print("å‰5ä¸ªè¡Œä¸š:")
        print(df.head())
        
        # è·å–ç”³ä¸‡äºŒçº§è¡Œä¸šåˆ†ç±»
        df2 = pro.index_classify(level='L2', src='SW2021')
        print(f"ç”³ä¸‡äºŒçº§è¡Œä¸šæ•°é‡: {len(df2)}")
        
        return True
    except Exception as e:
        print(f"Tushareæµ‹è¯•å¤±è´¥: {e}")
        return False

if __name__ == "__main__":
    test_tushare_industry()
```

### ç¬¬ä¸‰æ­¥ï¼šæ•°æ®æºæµ‹è¯•ï¼ˆé¢„è®¡æ—¶é—´ï¼š30åˆ†é’Ÿï¼‰

#### 3.1 æµ‹è¯•AKShareè¡Œä¸šæ•°æ®
```python
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼štest_akshare_industry.py
import akshare as ak
import pandas as pd

def test_akshare_industry():
    """æµ‹è¯•AKShareè¡Œä¸šæ•°æ®è·å–"""
    try:
        print("æ­£åœ¨æµ‹è¯•AKShareè¡Œä¸šæ•°æ®...")
        
        # è·å–åŒèŠ±é¡ºè¡Œä¸šæ¿å—
        df = ak.stock_board_industry_summary_ths()
        print(f"åŒèŠ±é¡ºè¡Œä¸šæ¿å—æ•°é‡: {len(df)}")
        print("å‰5ä¸ªè¡Œä¸šæ¿å—:")
        print(df.head())
        
        # è·å–æ¦‚å¿µæ¿å—
        concept_df = ak.stock_board_concept_summary_ths()
        print(f"æ¦‚å¿µæ¿å—æ•°é‡: {len(concept_df)}")
        
        # è·å–å…·ä½“è¡Œä¸šçš„æˆåˆ†è‚¡ï¼ˆç¤ºä¾‹ï¼šè®¡ç®—æœºè¡Œä¸šï¼‰
        if len(df) > 0:
            industry_name = df.iloc[0]['æ¿å—åç§°']
            stocks_df = ak.stock_board_industry_cons_ths(symbol=industry_name)
            print(f"{industry_name}è¡Œä¸šæˆåˆ†è‚¡æ•°é‡: {len(stocks_df)}")
        
        return True
    except Exception as e:
        print(f"AKShareæµ‹è¯•å¤±è´¥: {e}")
        return False

if __name__ == "__main__":
    test_akshare_industry()
```

#### 3.2 æµ‹è¯•ä¸œæ–¹è´¢å¯ŒAPI
```python
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼štest_eastmoney_industry.py
import requests
import json

def test_eastmoney_industry():
    """æµ‹è¯•ä¸œæ–¹è´¢å¯Œè¡Œä¸šæ•°æ®"""
    try:
        print("æ­£åœ¨æµ‹è¯•ä¸œæ–¹è´¢å¯Œè¡Œä¸šæ•°æ®...")
        
        # è·å–è¡Œä¸šæ¿å—åˆ—è¡¨
        url = "http://push2.eastmoney.com/api/qt/clist/get"
        params = {
            'pn': 1,
            'pz': 100,
            'po': 1,
            'np': 1,
            'ut': 'bd1d9ddb04089700cf9c27f6f7426281',
            'fltt': 2,
            'invt': 2,
            'fid': 'f3',
            'fs': 'm:90+t:2',  # è¡Œä¸šæ¿å—
            'fields': 'f12,f14,f2,f3,f62,f184,f225,f165'
        }
        
        response = requests.get(url, params=params, timeout=10)
        data = response.json()
        
        if data.get('rc') == 0 and data.get('data'):
            industries = data['data']['diff']
            print(f"ä¸œæ–¹è´¢å¯Œè¡Œä¸šæ¿å—æ•°é‡: {len(industries)}")
            for industry in industries[:3]:  # æ˜¾ç¤ºå‰3ä¸ª
                print(f"  {industry['f12']}: {industry['f14']}")
            return True
        else:
            print("ä¸œæ–¹è´¢å¯ŒAPIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸")
            return False
    except Exception as e:
        print(f"ä¸œæ–¹è´¢å¯ŒAPIæµ‹è¯•å¤±è´¥: {e}")
        return False

if __name__ == "__main__":
    test_eastmoney_industry()
```

### ç¬¬å››æ­¥ï¼šæ•°æ®åº“å‡†å¤‡ï¼ˆé¢„è®¡æ—¶é—´ï¼š15åˆ†é’Ÿï¼‰

#### 4.1 ç¡®ä¿MySQLè¿è¡Œ
```bash
# æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€ï¼ˆWindowsï¼‰
net start mysql

# è¿æ¥æµ‹è¯•
mysql -u root -p
```

#### 4.2 åˆ›å»ºè¡Œä¸šåˆ†ç±»è¡¨
```sql
-- åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
CREATE DATABASE IF NOT EXISTS prevailing_trend 
CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

USE prevailing_trend;

-- ç”³ä¸‡è¡Œä¸šåˆ†ç±»è¡¨
CREATE TABLE IF NOT EXISTS shenwan_industry_classification (
    id INT AUTO_INCREMENT PRIMARY KEY,
    sw_code VARCHAR(20) NOT NULL COMMENT 'ç”³ä¸‡è¡Œä¸šä»£ç ',
    sw_name VARCHAR(100) NOT NULL COMMENT 'ç”³ä¸‡è¡Œä¸šåç§°',
    industry_level TINYINT NOT NULL COMMENT 'è¡Œä¸šå±‚çº§(1/2/3)',
    parent_code VARCHAR(20) COMMENT 'çˆ¶çº§è¡Œä¸šä»£ç ',
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦æœ‰æ•ˆ',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_sw_code_level (sw_code, industry_level),
    INDEX idx_parent_code (parent_code),
    INDEX idx_industry_level (industry_level)
) COMMENT 'ç”³ä¸‡è¡Œä¸šåˆ†ç±»è¡¨';

-- åŒèŠ±é¡ºè¡Œä¸šæ¿å—è¡¨
CREATE TABLE IF NOT EXISTS ths_industry_board (
    id INT AUTO_INCREMENT PRIMARY KEY,
    board_code VARCHAR(20) NOT NULL COMMENT 'æ¿å—ä»£ç ',
    board_name VARCHAR(100) NOT NULL COMMENT 'æ¿å—åç§°',
    board_type ENUM('industry', 'concept') NOT NULL COMMENT 'æ¿å—ç±»å‹',
    stock_count INT DEFAULT 0 COMMENT 'æˆåˆ†è‚¡æ•°é‡',
    total_market_value DECIMAL(20,2) COMMENT 'æ€»å¸‚å€¼',
    avg_price DECIMAL(10,2) COMMENT 'å¹³å‡ä»·æ ¼',
    change_percent DECIMAL(8,4) COMMENT 'æ¶¨è·Œå¹…',
    data_date DATE COMMENT 'æ•°æ®æ—¥æœŸ',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_board_code_date (board_code, data_date),
    INDEX idx_board_type (board_type),
    INDEX idx_data_date (data_date)
) COMMENT 'åŒèŠ±é¡ºè¡Œä¸šæ¿å—è¡¨';

-- è¡Œä¸šæˆåˆ†è‚¡è¡¨
CREATE TABLE IF NOT EXISTS industry_constituents (
    id INT AUTO_INCREMENT PRIMARY KEY,
    industry_code VARCHAR(20) NOT NULL COMMENT 'è¡Œä¸šä»£ç ',
    industry_type ENUM('shenwan', 'ths_industry', 'ths_concept') NOT NULL COMMENT 'è¡Œä¸šç±»å‹',
    stock_code VARCHAR(10) NOT NULL COMMENT 'è‚¡ç¥¨ä»£ç ',
    stock_name VARCHAR(50) NOT NULL COMMENT 'è‚¡ç¥¨åç§°',
    weight DECIMAL(8,4) COMMENT 'æƒé‡',
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦æœ‰æ•ˆ',
    effective_date DATE COMMENT 'ç”Ÿæ•ˆæ—¥æœŸ',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_industry_stock (industry_code, industry_type, stock_code),
    INDEX idx_stock_code (stock_code),
    INDEX idx_industry_code (industry_code),
    INDEX idx_industry_type (industry_type)
) COMMENT 'è¡Œä¸šæˆåˆ†è‚¡è¡¨';

-- è¡Œä¸šæ˜ å°„å…³ç³»è¡¨
CREATE TABLE IF NOT EXISTS industry_mapping (
    id INT AUTO_INCREMENT PRIMARY KEY,
    source_type ENUM('shenwan', 'ths', 'eastmoney') NOT NULL COMMENT 'æºåˆ†ç±»ç±»å‹',
    source_code VARCHAR(20) NOT NULL COMMENT 'æºåˆ†ç±»ä»£ç ',
    source_name VARCHAR(100) NOT NULL COMMENT 'æºåˆ†ç±»åç§°',
    target_type ENUM('shenwan', 'ths', 'eastmoney') NOT NULL COMMENT 'ç›®æ ‡åˆ†ç±»ç±»å‹',
    target_code VARCHAR(20) NOT NULL COMMENT 'ç›®æ ‡åˆ†ç±»ä»£ç ',
    target_name VARCHAR(100) NOT NULL COMMENT 'ç›®æ ‡åˆ†ç±»åç§°',
    mapping_confidence DECIMAL(3,2) DEFAULT 1.00 COMMENT 'æ˜ å°„ç½®ä¿¡åº¦',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_source_target (source_type, source_code, target_type, target_code),
    INDEX idx_source (source_type, source_code),
    INDEX idx_target (target_type, target_code)
) COMMENT 'è¡Œä¸šæ˜ å°„å…³ç³»è¡¨';
```

### ç¬¬äº”æ­¥ï¼šæ•°æ®é‡‡é›†å®ç°ï¼ˆé¢„è®¡æ—¶é—´ï¼š3å°æ—¶ï¼‰

#### 5.1 åˆ›å»ºè¡Œä¸šæ•°æ®é‡‡é›†å™¨
```python
# åˆ›å»ºæ–‡ä»¶ï¼šindustry_data_collector.py
import tushare as ts
import akshare as ak
import requests
import pandas as pd
import time
import logging
from datetime import datetime, date
import sys
import os

# æ·»åŠ é…ç½®è·¯å¾„
sys.path.append('.')
sys.path.append('../../æ•°æ®åº“é…ç½®')

from database_config import get_database_manager

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('industry_collector.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

class IndustryDataCollector:
    """è¡Œä¸šæ•°æ®é‡‡é›†å™¨"""
    
    def __init__(self, tushare_token=None):
        self.db_manager = get_database_manager()
        self.tushare_token = tushare_token
        if tushare_token:
            ts.set_token(tushare_token)
            self.pro = ts.pro_api()
        else:
            self.pro = None
            logger.warning("æœªæä¾›Tushare tokenï¼Œå°†è·³è¿‡Tushareæ•°æ®é‡‡é›†")
    
    def collect_shenwan_industries(self):
        """é‡‡é›†ç”³ä¸‡è¡Œä¸šåˆ†ç±»"""
        if not self.pro:
            logger.error("Tushareæœªé…ç½®ï¼Œæ— æ³•è·å–ç”³ä¸‡åˆ†ç±»")
            return []
        
        try:
            logger.info("å¼€å§‹é‡‡é›†ç”³ä¸‡è¡Œä¸šåˆ†ç±»...")
            
            # è·å–ç”³ä¸‡ä¸€çº§ã€äºŒçº§ã€ä¸‰çº§è¡Œä¸š
            industries_data = []
            
            for level in ['L1', 'L2', 'L3']:
                logger.info(f"æ­£åœ¨è·å–ç”³ä¸‡{level}çº§è¡Œä¸šåˆ†ç±»...")
                df = self.pro.index_classify(level=level, src='SW2021')
                
                for _, row in df.iterrows():
                    industry_data = {
                        'sw_code': row['index_code'],
                        'sw_name': row['industry_name'],
                        'industry_level': int(level[1]),
                        'parent_code': row.get('parent_code', None),
                        'data_source': 'tushare',
                        'is_active': True
                    }
                    industries_data.append(industry_data)
                
                time.sleep(0.5)  # é¿å…è¯·æ±‚è¿‡å¿«
            
            logger.info(f"ç”³ä¸‡è¡Œä¸šåˆ†ç±»é‡‡é›†å®Œæˆï¼Œå…±è·å– {len(industries_data)} æ¡æ•°æ®")
            return industries_data
            
        except Exception as e:
            logger.error(f"ç”³ä¸‡è¡Œä¸šåˆ†ç±»é‡‡é›†å¤±è´¥: {e}")
            return []
    
    def collect_ths_industry_boards(self):
        """é‡‡é›†åŒèŠ±é¡ºè¡Œä¸šæ¿å—"""
        try:
            logger.info("å¼€å§‹é‡‡é›†åŒèŠ±é¡ºè¡Œä¸šæ¿å—...")
            
            # è·å–è¡Œä¸šæ¿å—
            industry_df = ak.stock_board_industry_summary_ths()
            
            # è·å–æ¦‚å¿µæ¿å—
            concept_df = ak.stock_board_concept_summary_ths()
            
            boards_data = []
            
            # å¤„ç†è¡Œä¸šæ¿å—
            for _, row in industry_df.iterrows():
                board_data = {
                    'board_code': f"THS_IND_{row['æ¿å—ä»£ç ']}",
                    'board_name': row['æ¿å—åç§°'],
                    'board_type': 'industry',
                    'stock_count': row.get('æˆåˆ†è‚¡æ•°é‡', 0),
                    'total_market_value': row.get('æ€»å¸‚å€¼', 0),
                    'change_percent': row.get('æ¶¨è·Œå¹…', 0),
                    'data_date': date.today(),
                    'data_source': 'akshare'
                }
                boards_data.append(board_data)
            
            # å¤„ç†æ¦‚å¿µæ¿å—
            for _, row in concept_df.iterrows():
                board_data = {
                    'board_code': f"THS_CON_{row['æ¿å—ä»£ç ']}",
                    'board_name': row['æ¿å—åç§°'],
                    'board_type': 'concept',
                    'stock_count': row.get('æˆåˆ†è‚¡æ•°é‡', 0),
                    'total_market_value': row.get('æ€»å¸‚å€¼', 0),
                    'change_percent': row.get('æ¶¨è·Œå¹…', 0),
                    'data_date': date.today(),
                    'data_source': 'akshare'
                }
                boards_data.append(board_data)
            
            logger.info(f"åŒèŠ±é¡ºæ¿å—é‡‡é›†å®Œæˆï¼Œå…±è·å– {len(boards_data)} æ¡æ•°æ®")
            return boards_data
            
        except Exception as e:
            logger.error(f"åŒèŠ±é¡ºæ¿å—é‡‡é›†å¤±è´¥: {e}")
            return []
    
    def collect_industry_constituents(self, board_name):
        """é‡‡é›†è¡Œä¸šæˆåˆ†è‚¡"""
        try:
            # è·å–è¡Œä¸šæˆåˆ†è‚¡
            stocks_df = ak.stock_board_industry_cons_ths(symbol=board_name)
            
            constituents_data = []
            for _, row in stocks_df.iterrows():
                constituent_data = {
                    'industry_code': f"THS_IND_{board_name}",
                    'industry_type': 'ths_industry',
                    'stock_code': row['ä»£ç '],
                    'stock_name': row['åç§°'],
                    'weight': None,  # åŒèŠ±é¡ºä¸æä¾›æƒé‡ä¿¡æ¯
                    'is_active': True,
                    'effective_date': date.today()
                }
                constituents_data.append(constituent_data)
            
            return constituents_data
            
        except Exception as e:
            logger.error(f"è·å– {board_name} æˆåˆ†è‚¡å¤±è´¥: {e}")
            return []
    
    def save_shenwan_industries(self, industries_data):
        """ä¿å­˜ç”³ä¸‡è¡Œä¸šåˆ†ç±»åˆ°æ•°æ®åº“"""
        if not industries_data:
            logger.warning("æ²¡æœ‰ç”³ä¸‡è¡Œä¸šæ•°æ®éœ€è¦ä¿å­˜")
            return False
        
        try:
            if not self.db_manager.connect():
                logger.error("æ•°æ®åº“è¿æ¥å¤±è´¥")
                return False
            
            success_count = 0
            for industry in industries_data:
                sql = """
                INSERT INTO shenwan_industry_classification 
                (sw_code, sw_name, industry_level, parent_code, is_active, updated_at)
                VALUES (%s, %s, %s, %s, %s, NOW())
                ON DUPLICATE KEY UPDATE
                sw_name = VALUES(sw_name),
                parent_code = VALUES(parent_code),
                is_active = VALUES(is_active),
                updated_at = NOW()
                """
                
                params = (
                    industry['sw_code'],
                    industry['sw_name'],
                    industry['industry_level'],
                    industry.get('parent_code'),
                    industry['is_active']
                )
                
                if self.db_manager.execute_update(sql, params):
                    success_count += 1
            
            logger.info(f"ç”³ä¸‡è¡Œä¸šæ•°æ®ä¿å­˜å®Œæˆï¼ŒæˆåŠŸä¿å­˜ {success_count} æ¡æ•°æ®")
            return True
            
        except Exception as e:
            logger.error(f"ç”³ä¸‡è¡Œä¸šæ•°æ®ä¿å­˜å¤±è´¥: {e}")
            return False
        finally:
            self.db_manager.disconnect()
    
    def save_ths_boards(self, boards_data):
        """ä¿å­˜åŒèŠ±é¡ºæ¿å—æ•°æ®åˆ°æ•°æ®åº“"""
        if not boards_data:
            logger.warning("æ²¡æœ‰åŒèŠ±é¡ºæ¿å—æ•°æ®éœ€è¦ä¿å­˜")
            return False
        
        try:
            if not self.db_manager.connect():
                logger.error("æ•°æ®åº“è¿æ¥å¤±è´¥")
                return False
            
            success_count = 0
            for board in boards_data:
                sql = """
                INSERT INTO ths_industry_board 
                (board_code, board_name, board_type, stock_count, total_market_value, 
                 change_percent, data_date, updated_at)
                VALUES (%s, %s, %s, %s, %s, %s, %s, NOW())
                ON DUPLICATE KEY UPDATE
                board_name = VALUES(board_name),
                stock_count = VALUES(stock_count),
                total_market_value = VALUES(total_market_value),
                change_percent = VALUES(change_percent),
                updated_at = NOW()
                """
                
                params = (
                    board['board_code'],
                    board['board_name'],
                    board['board_type'],
                    board['stock_count'],
                    board['total_market_value'],
                    board['change_percent'],
                    board['data_date']
                )
                
                if self.db_manager.execute_update(sql, params):
                    success_count += 1
            
            logger.info(f"åŒèŠ±é¡ºæ¿å—æ•°æ®ä¿å­˜å®Œæˆï¼ŒæˆåŠŸä¿å­˜ {success_count} æ¡æ•°æ®")
            return True
            
        except Exception as e:
            logger.error(f"åŒèŠ±é¡ºæ¿å—æ•°æ®ä¿å­˜å¤±è´¥: {e}")
            return False
        finally:
            self.db_manager.disconnect()
    
    def run_collection(self):
        """æ‰§è¡Œå®Œæ•´çš„è¡Œä¸šæ•°æ®é‡‡é›†æµç¨‹"""
        logger.info("å¼€å§‹æ‰§è¡Œè¡Œä¸šæ•°æ®é‡‡é›†ä»»åŠ¡...")
        start_time = time.time()
        
        # 1. é‡‡é›†ç”³ä¸‡è¡Œä¸šåˆ†ç±»
        shenwan_data = self.collect_shenwan_industries()
        if shenwan_data:
            self.save_shenwan_industries(shenwan_data)
        
        # 2. é‡‡é›†åŒèŠ±é¡ºæ¿å—æ•°æ®
        ths_data = self.collect_ths_industry_boards()
        if ths_data:
            self.save_ths_boards(ths_data)
        
        elapsed_time = time.time() - start_time
        logger.info(f"è¡Œä¸šæ•°æ®é‡‡é›†ä»»åŠ¡å®Œæˆï¼Œè€—æ—¶ {elapsed_time:.2f} ç§’")
        
        return True

def main():
    """ä¸»å‡½æ•°"""
    # è®¾ç½®Tushare tokenï¼ˆè¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…tokenï¼‰
    tushare_token = "your_tushare_token_here"
    
    collector = IndustryDataCollector(tushare_token)
    collector.run_collection()

if __name__ == "__main__":
    main()
```

### ç¬¬å…­æ­¥ï¼šé…ç½®æ–‡ä»¶åˆ›å»ºï¼ˆé¢„è®¡æ—¶é—´ï¼š15åˆ†é’Ÿï¼‰

#### 6.1 åˆ›å»ºé…ç½®æ–‡ä»¶
```python
# åˆ›å»ºæ–‡ä»¶ï¼šconfig.py
"""
ä¸‡å¾—è¡Œä¸šåˆ†ç±»æ¨¡å—é…ç½®æ–‡ä»¶
"""
import os

# æ•°æ®åº“é…ç½®
DATABASE_CONFIG = {
    'host': 'localhost',
    'port': 3306,
    'user': 'root',
    'password': 'your_password',
    'database': 'prevailing_trend',
    'charset': 'utf8mb4'
}

# Tushareé…ç½®
TUSHARE_CONFIG = {
    'token': 'your_tushare_token_here',  # åœ¨ https://tushare.pro æ³¨å†Œè·å–
    'retry_count': 3,
    'retry_interval': 5,
    'request_interval': 0.5  # è¯·æ±‚é—´éš”ï¼ˆç§’ï¼‰
}

# AKShareé…ç½®
AKSHARE_CONFIG = {
    'timeout': 30,
    'retry_count': 3,
    'retry_interval': 2,
    'request_interval': 1  # è¯·æ±‚é—´éš”ï¼ˆç§’ï¼‰
}

# ä¸œæ–¹è´¢å¯ŒAPIé…ç½®
EASTMONEY_CONFIG = {
    'base_url': 'http://push2.eastmoney.com/api/qt/clist/get',
    'timeout': 15,
    'retry_count': 3,
    'retry_interval': 3,
    'request_interval': 2  # è¯·æ±‚é—´éš”ï¼ˆç§’ï¼‰
}

# æ•°æ®é‡‡é›†é…ç½®
COLLECTION_CONFIG = {
    'update_frequency': 'weekly',  # æ›´æ–°é¢‘ç‡ï¼šdaily/weekly/monthly
    'batch_size': 500,
    'concurrent_requests': 2,
    'max_workers': 3
}

# æ•°æ®è´¨é‡é…ç½®
QUALITY_CONFIG = {
    'min_industry_count': 25,  # ç”³ä¸‡ä¸€çº§è¡Œä¸šæœ€å°‘æ•°é‡
    'max_industry_count': 35,  # ç”³ä¸‡ä¸€çº§è¡Œä¸šæœ€å¤šæ•°é‡
    'min_concept_count': 300,  # æ¦‚å¿µæ¿å—æœ€å°‘æ•°é‡
    'data_freshness_days': 7   # æ•°æ®æ–°é²œåº¦è¦æ±‚ï¼ˆå¤©ï¼‰
}

# æ—¥å¿—é…ç½®
LOG_CONFIG = {
    'level': 'INFO',
    'format': '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    'file_path': 'industry_collector.log',
    'max_size': 10 * 1024 * 1024,  # 10MB
    'backup_count': 5
}

# è¡Œä¸šåˆ†ç±»æ ‡å‡†ä¼˜å…ˆçº§
INDUSTRY_SOURCE_PRIORITY = [
    'shenwan',    # ç”³ä¸‡åˆ†ç±»ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    'ths',        # åŒèŠ±é¡ºåˆ†ç±»
    'eastmoney'   # ä¸œæ–¹è´¢å¯Œåˆ†ç±»
]

# ç›‘æ§é…ç½®
MONITOR_CONFIG = {
    'enable_alerts': True,
    'alert_email': 'admin@yourcompany.com',
    'check_interval': 3600,  # ç›‘æ§æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
    'alert_thresholds': {
        'data_delay_hours': 24,
        'error_rate_percent': 5,
        'missing_data_percent': 10
    }
}
```

#### 6.2 åˆ›å»ºrequirementsæ–‡ä»¶
```text
# åˆ›å»ºæ–‡ä»¶ï¼šrequirements.txt
tushare>=1.2.89
akshare>=1.11.0
pandas>=1.5.0
requests>=2.28.0
mysql-connector-python>=8.0.32
schedule>=1.2.0
openpyxl>=3.1.0
beautifulsoup4>=4.11.0
lxml>=4.9.0
```

### ç¬¬ä¸ƒæ­¥ï¼šæµ‹è¯•å’ŒéªŒè¯ï¼ˆé¢„è®¡æ—¶é—´ï¼š30åˆ†é’Ÿï¼‰

#### 7.1 åˆ›å»ºéªŒè¯è„šæœ¬
```python
# åˆ›å»ºæ–‡ä»¶ï¼švalidate_industry_data.py
import sys
sys.path.append('../../æ•°æ®åº“é…ç½®')
from database_config import get_database_manager
from datetime import datetime, timedelta

def validate_industry_data():
    """éªŒè¯è¡Œä¸šæ•°æ®è´¨é‡"""
    db_manager = get_database_manager()
    
    if not db_manager.connect():
        print("æ•°æ®åº“è¿æ¥å¤±è´¥")
        return
    
    try:
        print("=" * 50)
        print("è¡Œä¸šæ•°æ®è´¨é‡éªŒè¯æŠ¥å‘Š")
        print("=" * 50)
        
        # 1. æ£€æŸ¥ç”³ä¸‡è¡Œä¸šåˆ†ç±»æ•°æ®
        print("\n1. ç”³ä¸‡è¡Œä¸šåˆ†ç±»æ•°æ®æ£€æŸ¥:")
        for level in [1, 2, 3]:
            result = db_manager.execute_query(
                "SELECT COUNT(*) FROM shenwan_industry_classification WHERE industry_level = %s",
                (level,)
            )
            count = result[0][0] if result else 0
            print(f"   ç”³ä¸‡{level}çº§è¡Œä¸šæ•°é‡: {count}")
        
        # 2. æ£€æŸ¥åŒèŠ±é¡ºæ¿å—æ•°æ®
        print("\n2. åŒèŠ±é¡ºæ¿å—æ•°æ®æ£€æŸ¥:")
        result = db_manager.execute_query(
            "SELECT board_type, COUNT(*) FROM ths_industry_board GROUP BY board_type"
        )
        for row in result:
            print(f"   {row[0]}æ¿å—æ•°é‡: {row[1]}")
        
        # 3. æ£€æŸ¥æ•°æ®æ–°é²œåº¦
        print("\n3. æ•°æ®æ–°é²œåº¦æ£€æŸ¥:")
        result = db_manager.execute_query(
            "SELECT MAX(updated_at) FROM shenwan_industry_classification"
        )
        if result and result[0][0]:
            last_update = result[0][0]
            days_ago = (datetime.now() - last_update).days
            print(f"   ç”³ä¸‡åˆ†ç±»æœ€åæ›´æ–°: {last_update} ({days_ago}å¤©å‰)")
            
            if days_ago <= 1:
                print("   âœ… æ•°æ®æ–°é²œåº¦è‰¯å¥½")
            elif days_ago <= 7:
                print("   âš ï¸ æ•°æ®ç¨æœ‰å»¶è¿Ÿ")
            else:
                print("   âŒ æ•°æ®ä¸¥é‡å»¶è¿Ÿ")
        
        # 4. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
        print("\n4. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥:")
        
        # æ£€æŸ¥ç©ºå€¼
        result = db_manager.execute_query(
            "SELECT COUNT(*) FROM shenwan_industry_classification WHERE sw_name IS NULL OR sw_name = ''"
        )
        null_names = result[0][0] if result else 0
        
        result = db_manager.execute_query(
            "SELECT COUNT(*) FROM shenwan_industry_classification WHERE sw_code IS NULL OR sw_code = ''"
        )
        null_codes = result[0][0] if result else 0
        
        print(f"   ç¼ºå¤±è¡Œä¸šåç§°: {null_names} æ¡")
        print(f"   ç¼ºå¤±è¡Œä¸šä»£ç : {null_codes} æ¡")
        
        if null_names == 0 and null_codes == 0:
            print("   âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡")
        else:
            print("   âŒ æ•°æ®å®Œæ•´æ€§å­˜åœ¨é—®é¢˜")
        
        # 5. æ£€æŸ¥ç”³ä¸‡è¡Œä¸šå±‚çº§ç»“æ„
        print("\n5. ç”³ä¸‡è¡Œä¸šå±‚çº§ç»“æ„æ£€æŸ¥:")
        result = db_manager.execute_query("""
            SELECT 
                l1.sw_name as 'ä¸€çº§è¡Œä¸š',
                COUNT(l2.sw_code) as 'äºŒçº§è¡Œä¸šæ•°é‡',
                COUNT(l3.sw_code) as 'ä¸‰çº§è¡Œä¸šæ•°é‡'
            FROM shenwan_industry_classification l1
            LEFT JOIN shenwan_industry_classification l2 ON l2.parent_code = l1.sw_code AND l2.industry_level = 2
            LEFT JOIN shenwan_industry_classification l3 ON l3.parent_code = l2.sw_code AND l3.industry_level = 3
            WHERE l1.industry_level = 1
            GROUP BY l1.sw_code, l1.sw_name
            ORDER BY l1.sw_name
            LIMIT 5
        """)
        
        for row in result:
            print(f"   {row[0]}: {row[1]}ä¸ªäºŒçº§è¡Œä¸š, {row[2]}ä¸ªä¸‰çº§è¡Œä¸š")
        
        print("\n" + "=" * 50)
        print("éªŒè¯å®Œæˆ")
        
    finally:
        db_manager.disconnect()

if __name__ == "__main__":
    validate_industry_data()
```

### ç¬¬å…«æ­¥ï¼šå®šæ—¶ä»»åŠ¡é…ç½®ï¼ˆé¢„è®¡æ—¶é—´ï¼š20åˆ†é’Ÿï¼‰

#### 8.1 åˆ›å»ºè°ƒåº¦å™¨
```python
# åˆ›å»ºæ–‡ä»¶ï¼šscheduler.py
import schedule
import time
import logging
from datetime import datetime
from industry_data_collector import IndustryDataCollector

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def run_weekly_collection():
    """æ‰§è¡Œå‘¨åº¦è¡Œä¸šæ•°æ®é‡‡é›†"""
    logger.info("å¼€å§‹æ‰§è¡Œå‘¨åº¦è¡Œä¸šæ•°æ®é‡‡é›†ä»»åŠ¡...")
    
    try:
        # æ›¿æ¢ä¸ºæ‚¨çš„å®é™…Tushare token
        tushare_token = "your_tushare_token_here"
        collector = IndustryDataCollector(tushare_token)
        
        success = collector.run_collection()
        if success:
            logger.info("å‘¨åº¦è¡Œä¸šæ•°æ®é‡‡é›†ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ")
        else:
            logger.error("å‘¨åº¦è¡Œä¸šæ•°æ®é‡‡é›†ä»»åŠ¡æ‰§è¡Œå¤±è´¥")
    except Exception as e:
        logger.error(f"å‘¨åº¦ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸: {e}")

def run_daily_board_update():
    """æ‰§è¡Œæ—¥åº¦æ¿å—æ•°æ®æ›´æ–°"""
    logger.info("å¼€å§‹æ‰§è¡Œæ—¥åº¦æ¿å—æ•°æ®æ›´æ–°...")
    
    try:
        collector = IndustryDataCollector()
        
        # åªæ›´æ–°æ¿å—æ•°æ®
        ths_data = collector.collect_ths_industry_boards()
        if ths_data:
            collector.save_ths_boards(ths_data)
            logger.info("æ—¥åº¦æ¿å—æ•°æ®æ›´æ–°æˆåŠŸ")
        else:
            logger.error("æ—¥åº¦æ¿å—æ•°æ®æ›´æ–°å¤±è´¥")
    except Exception as e:
        logger.error(f"æ—¥åº¦ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸: {e}")

def main():
    """ä¸»è°ƒåº¦ç¨‹åº"""
    # é…ç½®å®šæ—¶ä»»åŠ¡
    schedule.every().sunday.at("08:00").do(run_weekly_collection)  # æ¯å‘¨æ—¥8ç‚¹æ‰§è¡Œ
    schedule.every().day.at("16:00").do(run_daily_board_update)    # æ¯å¤©16ç‚¹æ‰§è¡Œ
    
    logger.info("è¡Œä¸šæ•°æ®é‡‡é›†è°ƒåº¦å™¨å¯åŠ¨...")
    logger.info("å®šæ—¶ä»»åŠ¡å®‰æ’:")
    logger.info("- æ¯å‘¨æ—¥ 08:00 æ‰§è¡Œå®Œæ•´è¡Œä¸šæ•°æ®é‡‡é›†")
    logger.info("- æ¯å¤© 16:00 æ‰§è¡Œæ¿å—æ•°æ®æ›´æ–°")
    
    while True:
        schedule.run_pending()
        time.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

if __name__ == "__main__":
    main()
```

## å®Œæ•´æ‰§è¡Œæ¸…å•

### âœ… å¿«é€Ÿå¯åŠ¨æ¸…å•ï¼ˆ30åˆ†é’Ÿå†…å®Œæˆï¼‰

1. **ç¯å¢ƒå‡†å¤‡** (5åˆ†é’Ÿ)
   ```bash
   cd "ç¬¬ä¸€å±‚æ¨¡å—/ä¸‡å¾—è¡Œä¸šåˆ†ç±»"
   python -m venv venv
   venv\Scripts\activate
   pip install tushare akshare pandas requests mysql-connector-python
   ```

2. **Tushareé…ç½®** (5åˆ†é’Ÿ)
   - æ³¨å†Œè´¦å·ï¼šhttps://tushare.pro
   - è·å–tokenå¹¶é…ç½®åˆ°config.py

3. **æµ‹è¯•æ•°æ®æº** (10åˆ†é’Ÿ)
   ```bash
   python test_tushare.py
   python test_akshare_industry.py
   python test_eastmoney_industry.py
   ```

4. **æ•°æ®åº“å‡†å¤‡** (5åˆ†é’Ÿ)
   ```bash
   cd "../../æ•°æ®åº“é…ç½®"
   mysql -u root -p < industry_tables.sql
   ```

5. **æ•°æ®é‡‡é›†** (5åˆ†é’Ÿ)
   ```bash
   cd "../ç¬¬ä¸€å±‚æ¨¡å—/ä¸‡å¾—è¡Œä¸šåˆ†ç±»"
   python industry_data_collector.py
   ```

### ğŸ“‹ å®Œæ•´éƒ¨ç½²æ¸…å•

- [ ] ç¯å¢ƒå‡†å¤‡å’Œä¾èµ–å®‰è£…
- [ ] Tushareè´¦å·æ³¨å†Œå’Œtokené…ç½®
- [ ] æ•°æ®æºè¿æ¥æµ‹è¯•
- [ ] æ•°æ®åº“è¡¨ç»“æ„åˆ›å»º
- [ ] è¡Œä¸šæ•°æ®é‡‡é›†å™¨å¼€å‘
- [ ] å®šæ—¶ä»»åŠ¡é…ç½®
- [ ] æ•°æ®éªŒè¯å’Œç›‘æ§
- [ ] ç»´æŠ¤è„šæœ¬éƒ¨ç½²

### ğŸš¨ æ³¨æ„äº‹é¡¹

1. **Tushareé™åˆ¶**: å…è´¹ç”¨æˆ·æœ‰è°ƒç”¨æ¬¡æ•°é™åˆ¶ï¼Œæ³¨æ„æ§åˆ¶è¯·æ±‚é¢‘ç‡
2. **ç½‘ç»œè¿æ¥**: ç¡®ä¿èƒ½æ­£å¸¸è®¿é—®å¤–ç½‘API
3. **æ•°æ®è´¨é‡**: å®šæœŸæ£€æŸ¥æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§
4. **å­˜å‚¨ç©ºé—´**: è¡Œä¸šæ•°æ®é‡è¾ƒå°ï¼Œé€šå¸¸ä¸è¶…è¿‡100MB
5. **å¤‡ä»½ç­–ç•¥**: å®šæœŸå¤‡ä»½è¡Œä¸šåˆ†ç±»åŸºç¡€æ•°æ®

### ğŸ“ æ•…éšœæ’é™¤

- **Tushare tokené”™è¯¯**: æ£€æŸ¥tokenæ˜¯å¦æ­£ç¡®ï¼Œè´¦å·æ˜¯å¦æ¿€æ´»
- **æ•°æ®æºæ— æ³•è®¿é—®**: æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œå°è¯•æ›´æ¢æ•°æ®æº
- **æ•°æ®åº“è¿æ¥å¤±è´¥**: æ£€æŸ¥MySQLæœåŠ¡å’Œé…ç½®
- **æ•°æ®è´¨é‡é—®é¢˜**: è¿è¡ŒéªŒè¯è„šæœ¬ï¼Œæ£€æŸ¥æ•°æ®æºçŠ¶æ€

è¿™ä¸ªå…è´¹æ–¹æ¡ˆå¯ä»¥æ»¡è¶³è¡Œä¸šåˆ†ç±»æ•°æ®çš„åŸºæœ¬éœ€æ±‚ï¼Œä¸ºæ•´ä¸ªé£é™©æ¡†æ¶æä¾›å¯é çš„è¡Œä¸šåˆ†ç±»åŸºç¡€æ•°æ®ã€‚

