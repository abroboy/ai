# 万得行业分类 - 数据源接入方案

## 推荐数据源组合方案

### 方案一：万得Wind为主（推荐生产环境）
```
主数据源：万得Wind API
补充数据源：申万研究分类
验证数据源：Tushare行业数据
备用数据源：证监会官方分类
```

### 方案二：免费数据源组合（适合开发测试）
```
主数据源：Tushare + AKShare
补充数据源：东方财富行业板块
验证数据源：新浪财经行业分类
备用数据源：同花顺行业概念
```

### 方案三：混合方案（平衡成本与质量）
```
主数据源：万得Wind基础版
补充数据源：Tushare Pro
验证数据源：AKShare + 东方财富
备用数据源：申万研究官网
```

## 数据源详细对比

| 数据源 | 成本 | 数据质量 | 更新频率 | 分类层次 | 推荐指数 |
|--------|------|----------|----------|----------|----------|
| 万得Wind | 付费(高) | ⭐⭐⭐⭐⭐ | 实时 | 4级 | ⭐⭐⭐⭐⭐ |
| 申万研究 | 免费/付费 | ⭐⭐⭐⭐⭐ | 季度 | 3级 | ⭐⭐⭐⭐⭐ |
| Tushare | 免费/付费 | ⭐⭐⭐⭐ | 日级 | 3级 | ⭐⭐⭐⭐ |
| AKShare | 免费 | ⭐⭐⭐ | 日级 | 2级 | ⭐⭐⭐ |
| 东方财富 | 免费 | ⭐⭐⭐ | 实时 | 2级 | ⭐⭐⭐ |

## 具体接入代码示例

### 1. 万得Wind接入（推荐主要数据源）

```python
from WindPy import w
import pandas as pd
import time

# 初始化Wind连接
def init_wind():
    """初始化Wind连接"""
    w.start()
    if w.isconnected():
        print("Wind连接成功")
        return True
    else:
        print("Wind连接失败")
        return False

def get_wind_industry_classification():
    """获取万得行业分类"""
    if not init_wind():
        return None
    
    try:
        # 获取万得行业分类
        data = w.wset("sectorconstituent",
                     "date=20231201;sectorid=1000000247000000")
        
        if data.ErrorCode == 0:
            df = pd.DataFrame(data.Data, 
                            index=data.Fields, 
                            columns=data.Codes).T
            return df
        else:
            print(f"获取万得行业分类失败: {data.ErrorCode}")
            return None
    except Exception as e:
        print(f"Wind API调用失败: {e}")
        return None

def get_shenwan_industry_from_wind():
    """从Wind获取申万行业分类"""
    try:
        # 申万一级行业
        data = w.wset("sectorconstituent",
                     "date=20231201;sectorid=a001010100000000")
        
        if data.ErrorCode == 0:
            # 处理申万一级行业数据
            sw_l1_df = pd.DataFrame(data.Data, 
                                  index=data.Fields, 
                                  columns=data.Codes).T
            
            # 申万二级行业
            data = w.wset("sectorconstituent",
                         "date=20231201;sectorid=a001010200000000")
            
            sw_l2_df = pd.DataFrame(data.Data, 
                                  index=data.Fields, 
                                  columns=data.Codes).T
            
            return {
                'level1': sw_l1_df,
                'level2': sw_l2_df
            }
        return None
    except Exception as e:
        print(f"获取申万分类失败: {e}")
        return None

def get_industry_stocks_mapping():
    """获取行业-股票映射关系"""
    try:
        # 获取所有A股的行业归属
        data = w.wss("000001.SZ,000002.SZ", 
                    "industry_sw,industry_wind",
                    "tradeDate=20231201")
        
        if data.ErrorCode == 0:
            mapping_df = pd.DataFrame(data.Data, 
                                    index=data.Fields, 
                                    columns=data.Codes).T
            return mapping_df
        return None
    except Exception as e:
        print(f"获取行业映射失败: {e}")
        return None
```

### 2. Tushare接入（免费补充数据源）

```python
import tushare as ts

# 设置Tushare token
ts.set_token('your_tushare_token')
pro = ts.pro_api()

def get_tushare_industry_classification():
    """获取Tushare行业分类"""
    try:
        # 获取申万行业分类
        df = pro.index_classify(level='L1', src='SW2021')
        return df
    except Exception as e:
        print(f"获取Tushare行业分类失败: {e}")
        return None

def get_tushare_stock_industry():
    """获取股票行业归属"""
    try:
        # 获取股票基本信息（含行业）
        df = pro.stock_basic(exchange='', 
                           list_status='L',
                           fields='ts_code,name,industry,market')
        return df
    except Exception as e:
        print(f"获取股票行业信息失败: {e}")
        return None

def get_tushare_industry_detail():
    """获取Tushare详细行业分类"""
    try:
        # 申万一级行业
        l1_df = pro.index_classify(level='L1', src='SW2021')
        
        # 申万二级行业
        l2_df = pro.index_classify(level='L2', src='SW2021')
        
        # 申万三级行业
        l3_df = pro.index_classify(level='L3', src='SW2021')
        
        return {
            'level1': l1_df,
            'level2': l2_df,
            'level3': l3_df
        }
    except Exception as e:
        print(f"获取详细行业分类失败: {e}")
        return None
```

### 3. AKShare接入（免费实时数据）

```python
import akshare as ak

def get_akshare_industry_summary():
    """获取AKShare行业板块概要"""
    try:
        # 同花顺行业板块
        df = ak.stock_board_industry_summary_ths()
        return df
    except Exception as e:
        print(f"获取行业板块概要失败: {e}")
        return None

def get_akshare_industry_stocks():
    """获取行业成分股"""
    try:
        # 获取具体行业的成分股
        # 示例：获取计算机行业成分股
        df = ak.stock_board_industry_cons_ths(symbol="计算机")
        return df
    except Exception as e:
        print(f"获取行业成分股失败: {e}")
        return None

def get_akshare_concept_boards():
    """获取概念板块数据"""
    try:
        # 概念板块
        df = ak.stock_board_concept_summary_ths()
        return df
    except Exception as e:
        print(f"获取概念板块失败: {e}")
        return None
```

### 4. 东方财富接入（免费实时数据）

```python
import requests
import json

def get_eastmoney_industry_list():
    """从东方财富获取行业列表"""
    url = "http://push2.eastmoney.com/api/qt/clist/get"
    params = {
        'pn': 1,
        'pz': 1000,
        'po': 1,
        'np': 1,
        'ut': 'bd1d9ddb04089700cf9c27f6f7426281',
        'fltt': 2,
        'invt': 2,
        'fid': 'f3',
        'fs': 'm:90+t:2',  # 行业板块
        'fields': 'f12,f14,f2,f3,f62,f184,f225,f165'
    }
    
    try:
        response = requests.get(url, params=params)
        data = response.json()
        if data['rc'] == 0:
            return data['data']['diff']
        return None
    except Exception as e:
        print(f"东方财富行业数据获取失败: {e}")
        return None

def get_eastmoney_concept_list():
    """获取概念板块列表"""
    url = "http://push2.eastmoney.com/api/qt/clist/get"
    params = {
        'pn': 1,
        'pz': 1000,
        'po': 1,
        'np': 1,
        'ut': 'bd1d9ddb04089700cf9c27f6f7426281',
        'fltt': 2,
        'invt': 2,
        'fid': 'f3',
        'fs': 'm:90+t:3',  # 概念板块
        'fields': 'f12,f14,f2,f3,f62,f184,f225,f165'
    }
    
    try:
        response = requests.get(url, params=params)
        data = response.json()
        if data['rc'] == 0:
            return data['data']['diff']
        return None
    except Exception as e:
        print(f"东方财富概念数据获取失败: {e}")
        return None
```

## 数据源使用建议

### 生产环境推荐方案
1. **主数据源**: 万得Wind API
   - 获取最权威的行业分类标准
   - 实时更新，数据质量最高
   - 支持多层级分类体系

2. **验证数据源**: 申万研究 + Tushare
   - 申万分类作为市场标准验证
   - Tushare提供免费的交叉验证

3. **补充数据源**: AKShare + 东方财富
   - 获取概念板块和热点行业
   - 提供市场表现数据

### 开发测试环境
1. **主数据源**: Tushare + AKShare
   - 免费获取基础行业分类
   - 覆盖申万标准分类

2. **补充数据源**: 东方财富 + 新浪财经
   - 免费实时数据验证
   - 概念板块补充

### 成本优化方案
1. **纯免费方案**: Tushare + AKShare + 东方财富
2. **低成本方案**: 万得Wind基础版 + 免费数据源
3. **高质量方案**: 万得Wind专业版 + 申万研究

## 数据整合策略

### 1. 多源数据合并
```python
def merge_industry_data(wind_data, shenwan_data, tushare_data):
    """合并多个数据源的行业分类"""
    merged_data = {}
    
    # 以万得分类为主
    if wind_data is not None:
        for _, row in wind_data.iterrows():
            industry_code = row['industry_code']
            merged_data[industry_code] = {
                'wind_code': row['industry_code'],
                'wind_name': row['industry_name'],
                'wind_level': row['industry_level']
            }
    
    # 补充申万分类
    if shenwan_data is not None:
        for _, row in shenwan_data.iterrows():
            # 建立万得-申万映射关系
            wind_code = map_shenwan_to_wind(row['sw_code'])
            if wind_code in merged_data:
                merged_data[wind_code]['sw_code'] = row['sw_code']
                merged_data[wind_code]['sw_name'] = row['sw_name']
    
    return merged_data

def map_shenwan_to_wind(sw_code):
    """申万分类映射到万得分类"""
    # 这里需要建立映射表
    mapping = {
        '801010': '010000',  # 农林牧渔
        '801020': '030000',  # 基础化工
        '801030': '040000',  # 钢铁
        # ... 更多映射关系
    }
    return mapping.get(sw_code)
```

### 2. 数据质量验证
```python
def validate_industry_data(industry_data):
    """验证行业数据质量"""
    validation_results = {
        'total_count': len(industry_data),
        'missing_names': 0,
        'duplicate_codes': 0,
        'invalid_levels': 0
    }
    
    seen_codes = set()
    for item in industry_data:
        # 检查必填字段
        if not item.get('industry_name'):
            validation_results['missing_names'] += 1
        
        # 检查重复代码
        code = item.get('industry_code')
        if code in seen_codes:
            validation_results['duplicate_codes'] += 1
        seen_codes.add(code)
        
        # 检查层级有效性
        level = item.get('industry_level')
        if level not in [1, 2, 3, 4]:
            validation_results['invalid_levels'] += 1
    
    return validation_results
```

### 3. 实时更新策略
```python
def update_industry_data():
    """更新行业分类数据"""
    logger.info("开始更新行业分类数据...")
    
    # 1. 获取最新的万得数据
    wind_data = get_wind_industry_classification()
    
    # 2. 获取申万分类作为验证
    shenwan_data = get_tushare_industry_detail()
    
    # 3. 对比数据变化
    changes = detect_industry_changes(wind_data, shenwan_data)
    
    # 4. 更新数据库
    if changes:
        update_database_with_changes(changes)
        logger.info(f"发现 {len(changes)} 个行业分类变更")
    
    # 5. 生成更新报告
    generate_update_report(changes)
```

## 实施建议

### 第一步：选择主要数据源
根据预算和需求选择合适的数据源组合

### 第二步：申请API权限
- 万得Wind: 申请API接口权限
- Tushare: 注册账号，获取token
- 免费API: 了解调用限制和使用条款

### 第三步：建立数据获取框架
先实现一个数据源的完整流程，再逐步添加其他数据源

### 第四步：建立映射关系
建立不同分类标准之间的映射关系表

### 第五步：数据质量控制
实现数据验证、清洗、监控机制

### 第六步：部署监控
建立自动更新、异常报警、数据质量监控体系

## 注意事项

### 1. 数据源稳定性
- 万得Wind: 企业级稳定性，但需要付费
- 免费API: 可能有调用限制和稳定性问题
- 建立多数据源备份机制

### 2. 数据一致性
- 不同数据源的分类标准可能不同
- 需要建立统一的映射关系
- 定期验证数据一致性

### 3. 更新频率
- 行业分类调整通常是季度级别
- 成分股变化需要月度更新
- 市场数据可以日级更新

### 4. 合规要求
- 遵守各数据源的使用条款
- 注意数据版权和使用限制
- 建立合规的数据使用流程

这个方案为万得行业分类模块提供了完整的数据源接入策略，确保数据的准确性、及时性和可靠性。

