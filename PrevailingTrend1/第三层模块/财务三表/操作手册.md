# 财务三表模块 - 操作手册

## 模块概述
财务三表模块负责收集、处理和分析上市公司的资产负债表、利润表和现金流量表数据。该模块为大势所趋风险框架提供详细的财务基础数据，支持财务健康度评估、盈利能力分析和现金流状况监控。

## 数据来源分析

### 1. 主要数据源

#### 权威财务数据源
- **万得Wind数据终端**
  - 最权威的财务数据源
  - 标准化财务科目
  - 历史数据完整
  - 数据质量最高

- **同花顺iFinD**
  - 综合财务数据平台
  - 实时财务更新
  - 多维度财务指标

- **聚源数据**
  - 专业财务数据服务
  - 深度财务分析
  - 历史数据回溯

#### 监管披露数据
- **上海证券交易所** (http://www.sse.com.cn/)
  - 上市公司年报、半年报、季报
  - 监管披露的原始财务数据
  - 审计报告和财务附注

- **深圳证券交易所** (http://www.szse.cn/)
  - 中小板、创业板财务数据
  - 定期报告和临时公告
  - 财务重大事项披露

- **巨潮资讯网** (http://www.cninfo.com.cn/)
  - 统一信息披露平台
  - 完整的财务报告
  - 标准格式数据

#### 免费数据源
- **Tushare Pro**
  - 财务数据API接口
  - 基础财务指标
  - 适合开发测试

- **AKShare**
  - 开源财务数据
  - 多源数据整合
  - 免费使用

## 财务三表数据结构

### 资产负债表 (Balance Sheet)
```sql
CREATE TABLE balance_sheet (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    stock_code VARCHAR(10) NOT NULL,
    report_date DATE NOT NULL,
    report_type ENUM('annual', 'interim', 'quarterly') NOT NULL,
    
    -- 资产类科目
    total_assets DECIMAL(20,2) COMMENT '资产总计',
    current_assets DECIMAL(20,2) COMMENT '流动资产合计',
    monetary_funds DECIMAL(20,2) COMMENT '货币资金',
    trading_assets DECIMAL(20,2) COMMENT '交易性金融资产',
    accounts_receivable DECIMAL(20,2) COMMENT '应收票据及应收账款',
    prepaid_accounts DECIMAL(20,2) COMMENT '预付款项',
    inventory DECIMAL(20,2) COMMENT '存货',
    
    non_current_assets DECIMAL(20,2) COMMENT '非流动资产合计',
    long_term_equity_investment DECIMAL(20,2) COMMENT '长期股权投资',
    fixed_assets DECIMAL(20,2) COMMENT '固定资产',
    intangible_assets DECIMAL(20,2) COMMENT '无形资产',
    goodwill DECIMAL(20,2) COMMENT '商誉',
    
    -- 负债类科目
    total_liabilities DECIMAL(20,2) COMMENT '负债合计',
    current_liabilities DECIMAL(20,2) COMMENT '流动负债合计',
    short_term_borrowings DECIMAL(20,2) COMMENT '短期借款',
    accounts_payable DECIMAL(20,2) COMMENT '应付票据及应付账款',
    advance_receipts DECIMAL(20,2) COMMENT '预收款项',
    
    non_current_liabilities DECIMAL(20,2) COMMENT '非流动负债合计',
    long_term_borrowings DECIMAL(20,2) COMMENT '长期借款',
    bonds_payable DECIMAL(20,2) COMMENT '应付债券',
    
    -- 所有者权益类科目
    total_equity DECIMAL(20,2) COMMENT '所有者权益合计',
    share_capital DECIMAL(20,2) COMMENT '股本',
    capital_reserve DECIMAL(20,2) COMMENT '资本公积',
    retained_earnings DECIMAL(20,2) COMMENT '未分配利润',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_stock_report (stock_code, report_date, report_type),
    INDEX idx_stock_code (stock_code),
    INDEX idx_report_date (report_date)
);
```

### 利润表 (Income Statement)
```sql
CREATE TABLE income_statement (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    stock_code VARCHAR(10) NOT NULL,
    report_date DATE NOT NULL,
    report_type ENUM('annual', 'interim', 'quarterly') NOT NULL,
    
    -- 收入类科目
    total_revenue DECIMAL(20,2) COMMENT '营业收入',
    operating_revenue DECIMAL(20,2) COMMENT '营业收入',
    other_revenue DECIMAL(20,2) COMMENT '其他业务收入',
    
    -- 成本费用类科目
    total_costs DECIMAL(20,2) COMMENT '营业总成本',
    operating_costs DECIMAL(20,2) COMMENT '营业成本',
    selling_expenses DECIMAL(20,2) COMMENT '销售费用',
    management_expenses DECIMAL(20,2) COMMENT '管理费用',
    rd_expenses DECIMAL(20,2) COMMENT '研发费用',
    financial_expenses DECIMAL(20,2) COMMENT '财务费用',
    
    -- 利润类科目
    operating_profit DECIMAL(20,2) COMMENT '营业利润',
    non_operating_income DECIMAL(20,2) COMMENT '营业外收入',
    non_operating_expenses DECIMAL(20,2) COMMENT '营业外支出',
    total_profit DECIMAL(20,2) COMMENT '利润总额',
    income_tax DECIMAL(20,2) COMMENT '所得税费用',
    net_profit DECIMAL(20,2) COMMENT '净利润',
    
    -- 每股数据
    basic_eps DECIMAL(10,4) COMMENT '基本每股收益',
    diluted_eps DECIMAL(10,4) COMMENT '稀释每股收益',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_stock_report (stock_code, report_date, report_type),
    INDEX idx_stock_code (stock_code),
    INDEX idx_report_date (report_date)
);
```

### 现金流量表 (Cash Flow Statement)
```sql
CREATE TABLE cash_flow_statement (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    stock_code VARCHAR(10) NOT NULL,
    report_date DATE NOT NULL,
    report_type ENUM('annual', 'interim', 'quarterly') NOT NULL,
    
    -- 经营活动现金流
    operating_cash_flow DECIMAL(20,2) COMMENT '经营活动现金流量净额',
    cash_from_sales DECIMAL(20,2) COMMENT '销售商品、提供劳务收到的现金',
    cash_paid_for_goods DECIMAL(20,2) COMMENT '购买商品、接受劳务支付的现金',
    cash_paid_to_employees DECIMAL(20,2) COMMENT '支付给职工以及为职工支付的现金',
    cash_paid_for_taxes DECIMAL(20,2) COMMENT '支付的各项税费',
    
    -- 投资活动现金流
    investing_cash_flow DECIMAL(20,2) COMMENT '投资活动现金流量净额',
    cash_from_investment_disposal DECIMAL(20,2) COMMENT '收回投资收到的现金',
    cash_from_investment_income DECIMAL(20,2) COMMENT '取得投资收益收到的现金',
    cash_paid_for_fixed_assets DECIMAL(20,2) COMMENT '购建固定资产、无形资产和其他长期资产支付的现金',
    cash_paid_for_investments DECIMAL(20,2) COMMENT '投资支付的现金',
    
    -- 筹资活动现金流
    financing_cash_flow DECIMAL(20,2) COMMENT '筹资活动现金流量净额',
    cash_from_borrowings DECIMAL(20,2) COMMENT '取得借款收到的现金',
    cash_from_equity_financing DECIMAL(20,2) COMMENT '吸收投资收到的现金',
    cash_paid_for_debt DECIMAL(20,2) COMMENT '偿还债务支付的现金',
    cash_paid_for_dividends DECIMAL(20,2) COMMENT '分配股利、利润或偿付利息支付的现金',
    
    -- 现金净增加额
    net_cash_increase DECIMAL(20,2) COMMENT '现金及现金等价物净增加额',
    beginning_cash DECIMAL(20,2) COMMENT '期初现金及现金等价物余额',
    ending_cash DECIMAL(20,2) COMMENT '期末现金及现金等价物余额',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_stock_report (stock_code, report_date, report_type),
    INDEX idx_stock_code (stock_code),
    INDEX idx_report_date (report_date)
);
```

## 财务指标计算

### 1. 偿债能力指标
```python
def calculate_solvency_ratios(balance_sheet_data):
    """计算偿债能力指标"""
    ratios = {}
    
    # 流动比率
    ratios['current_ratio'] = (
        balance_sheet_data['current_assets'] / 
        balance_sheet_data['current_liabilities']
    )
    
    # 速动比率
    quick_assets = (
        balance_sheet_data['current_assets'] - 
        balance_sheet_data['inventory']
    )
    ratios['quick_ratio'] = (
        quick_assets / balance_sheet_data['current_liabilities']
    )
    
    # 资产负债率
    ratios['debt_ratio'] = (
        balance_sheet_data['total_liabilities'] / 
        balance_sheet_data['total_assets']
    )
    
    # 产权比率
    ratios['equity_ratio'] = (
        balance_sheet_data['total_liabilities'] / 
        balance_sheet_data['total_equity']
    )
    
    return ratios
```

### 2. 盈利能力指标
```python
def calculate_profitability_ratios(income_data, balance_data):
    """计算盈利能力指标"""
    ratios = {}
    
    # 净资产收益率 (ROE)
    ratios['roe'] = (
        income_data['net_profit'] / 
        balance_data['total_equity']
    )
    
    # 总资产收益率 (ROA)
    ratios['roa'] = (
        income_data['net_profit'] / 
        balance_data['total_assets']
    )
    
    # 销售净利率
    ratios['net_profit_margin'] = (
        income_data['net_profit'] / 
        income_data['total_revenue']
    )
    
    # 毛利率
    gross_profit = income_data['total_revenue'] - income_data['operating_costs']
    ratios['gross_profit_margin'] = (
        gross_profit / income_data['total_revenue']
    )
    
    return ratios
```

### 3. 营运能力指标
```python
def calculate_efficiency_ratios(income_data, balance_data):
    """计算营运能力指标"""
    ratios = {}
    
    # 总资产周转率
    ratios['asset_turnover'] = (
        income_data['total_revenue'] / 
        balance_data['total_assets']
    )
    
    # 应收账款周转率
    ratios['receivables_turnover'] = (
        income_data['total_revenue'] / 
        balance_data['accounts_receivable']
    )
    
    # 存货周转率
    ratios['inventory_turnover'] = (
        income_data['operating_costs'] / 
        balance_data['inventory']
    )
    
    # 固定资产周转率
    ratios['fixed_asset_turnover'] = (
        income_data['total_revenue'] / 
        balance_data['fixed_assets']
    )
    
    return ratios
```

### 4. 现金流指标
```python
def calculate_cash_flow_ratios(cash_flow_data, income_data):
    """计算现金流指标"""
    ratios = {}
    
    # 经营现金流与净利润比
    ratios['ocf_to_net_income'] = (
        cash_flow_data['operating_cash_flow'] / 
        income_data['net_profit']
    )
    
    # 自由现金流
    ratios['free_cash_flow'] = (
        cash_flow_data['operating_cash_flow'] - 
        cash_flow_data['cash_paid_for_fixed_assets']
    )
    
    # 现金流量比率
    ratios['cash_flow_ratio'] = (
        cash_flow_data['operating_cash_flow'] / 
        cash_flow_data['current_liabilities']
    )
    
    return ratios
```

## 数据采集实现

### 1. Wind数据采集
```python
from WindPy import w

class WindFinancialDataCollector:
    def __init__(self):
        w.start()
        
    def get_balance_sheet(self, stock_code, report_date):
        """获取资产负债表数据"""
        fields = [
            "tot_assets",           # 资产总计
            "tot_cur_assets",       # 流动资产合计
            "monetary_cap",         # 货币资金
            "accounts_receiv",      # 应收账款
            "inventories",          # 存货
            "fix_assets",           # 固定资产
            "tot_liab",            # 负债合计
            "tot_cur_liab",        # 流动负债合计
            "tot_equity"           # 所有者权益合计
        ]
        
        data = w.wss(stock_code, fields, f"rptDate={report_date}")
        
        if data.ErrorCode == 0:
            return dict(zip(fields, data.Data[0]))
        return None
        
    def get_income_statement(self, stock_code, report_date):
        """获取利润表数据"""
        fields = [
            "oper_rev",            # 营业收入
            "oper_cost",           # 营业成本
            "sell_exp",            # 销售费用
            "admin_exp",           # 管理费用
            "rd_exp",              # 研发费用
            "fin_exp",             # 财务费用
            "oper_profit",         # 营业利润
            "tot_profit",          # 利润总额
            "net_profit_is"        # 净利润
        ]
        
        data = w.wss(stock_code, fields, f"rptDate={report_date}")
        
        if data.ErrorCode == 0:
            return dict(zip(fields, data.Data[0]))
        return None
        
    def get_cash_flow_statement(self, stock_code, report_date):
        """获取现金流量表数据"""
        fields = [
            "net_cash_flows_oper_act",    # 经营活动现金流量净额
            "net_cash_flows_inv_act",     # 投资活动现金流量净额
            "net_cash_flows_fnc_act",     # 筹资活动现金流量净额
            "net_incr_cash_cash_equ",     # 现金及现金等价物净增加额
            "end_bal_cash"                # 期末现金及现金等价物余额
        ]
        
        data = w.wss(stock_code, fields, f"rptDate={report_date}")
        
        if data.ErrorCode == 0:
            return dict(zip(fields, data.Data[0]))
        return None
```

### 2. Tushare数据采集
```python
import tushare as ts

class TushareFinancialDataCollector:
    def __init__(self, token):
        ts.set_token(token)
        self.pro = ts.pro_api()
        
    def get_balance_sheet(self, stock_code, start_date, end_date):
        """获取资产负债表"""
        df = self.pro.balancesheet(
            ts_code=stock_code,
            start_date=start_date,
            end_date=end_date,
            fields=[
                'ts_code', 'ann_date', 'f_ann_date', 'end_date',
                'total_assets', 'total_cur_assets', 'money_cap',
                'accounts_receiv', 'inventories', 'fix_assets',
                'total_liab', 'total_cur_liab', 'total_hldr_eqy_exc_min_int'
            ]
        )
        return df
        
    def get_income_statement(self, stock_code, start_date, end_date):
        """获取利润表"""
        df = self.pro.income(
            ts_code=stock_code,
            start_date=start_date,
            end_date=end_date,
            fields=[
                'ts_code', 'ann_date', 'f_ann_date', 'end_date',
                'total_revenue', 'oper_cost', 'sell_exp', 'admin_exp',
                'rd_exp', 'fin_exp', 'oper_profit', 'total_profit',
                'income_tax', 'n_income'
            ]
        )
        return df
        
    def get_cash_flow_statement(self, stock_code, start_date, end_date):
        """获取现金流量表"""
        df = self.pro.cashflow(
            ts_code=stock_code,
            start_date=start_date,
            end_date=end_date,
            fields=[
                'ts_code', 'ann_date', 'f_ann_date', 'end_date',
                'n_cashflow_act', 'n_cashflow_inv_act', 'n_cashflow_fna_act',
                'n_incr_cash_cash_equ', 'end_bal_cash'
            ]
        )
        return df
```

## API接口设计

### 1. 财务数据查询
```python
# 获取最新财务数据
GET /api/financial/{stock_code}/latest
GET /api/financial/{stock_code}/balance_sheet?date=2023-12-31
GET /api/financial/{stock_code}/income_statement?period=annual
GET /api/financial/{stock_code}/cash_flow?quarters=4

# 批量查询
POST /api/financial/batch
{
    "stock_codes": ["000001", "000002"],
    "report_type": "annual",
    "fields": ["total_assets", "net_profit"]
}
```

### 2. 财务指标计算
```python
# 财务比率分析
GET /api/financial/{stock_code}/ratios?category=profitability
GET /api/financial/{stock_code}/ratios/trend?years=5

# 同行业比较
GET /api/financial/industry/{industry_code}/comparison?metric=roe
```

## 实施计划

### 第一阶段：数据结构设计（1-2天）
1. 设计财务三表数据库结构
2. 建立财务科目标准化映射
3. 完成数据模型定义

### 第二阶段：数据采集（3-4天）
1. 实现Wind数据接口对接
2. 开发Tushare数据采集
3. 建立数据质量控制机制
4. 完成历史数据回填

### 第三阶段：指标计算（2-3天）
1. 实现财务比率计算算法
2. 开发趋势分析功能
3. 建立同业比较机制
4. 完善异常检测

### 第四阶段：服务接口（1-2天）
1. 开发RESTful API
2. 实现数据查询优化
3. 建立缓存机制
4. 完成性能测试

## 成功指标
- 数据覆盖率 > 95%（A股上市公司）
- 数据准确率 > 99.5%
- 数据更新及时性 < 1个工作日
- 指标计算准确率 > 99%
- API响应时间 < 500ms
- 系统稳定性 > 99.5%

该模块为风险框架提供全面、准确的财务基础数据，支持深度的财务分析和风险评估。

